<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 留學顧問</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // 內嵌配置
        window.__CONFIG__ = {
            API_BASE: 'https://aistudentbackend.zeabur.app/api/v1',
            // 暫時使用測試模式，跳過後端驗證
            TEST_MODE: true
        };
        
        // Google OAuth 配置
        window.__GOOGLE_CLIENT_ID__ = '300123710303-m4j1laa65p664n5vtrdkfvfa7b42c2o6.apps.googleusercontent.com';
    </script>
    <style>
        /* 自定義樣式 */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        /* 手機版優化 */
        @media (max-width: 768px) {
            .mobile-optimized {
                font-size: 16px !important; /* 防止 iOS 自動縮放 */
                -webkit-text-size-adjust: 100%;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            
            .mobile-button {
                min-height: 44px !important; /* iOS 建議的最小觸控區域 */
                padding: 12px 16px !important;
                font-size: 16px !important;
            }
            
            .mobile-input {
                font-size: 16px !important; /* 防止 iOS 自動縮放 */
                padding: 12px 16px !important;
                min-height: 44px !important;
            }
            
            .mobile-text {
                font-size: 16px !important;
                line-height: 1.5 !important;
            }
            
            /* 防止雙擊縮放 */
            * {
                touch-action: manipulation;
            }
            
            /* 優化聊天介面 */
            .chat-container {
                height: calc(100vh - 120px) !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            .message-bubble {
                max-width: 85% !important;
                word-wrap: break-word !important;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .hidden { display: none; }
        .block { display: block; }
        
        .message-bubble {
            @apply max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg px-4 py-3 rounded-2xl relative shadow-sm;
            word-wrap: break-word;
        }
        
        .message-user {
            @apply bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-800 ml-auto;
            margin-left: auto;
            margin-right: 0;
        }
        
        .message-user::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: -8px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-left-color: #fbbf24;
            border-bottom: none;
            border-right: none;
        }
        
        .message-ai {
            @apply bg-white text-gray-800 mr-auto border border-gray-200;
            margin-left: 0;
            margin-right: auto;
        }
        
        .message-ai::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: -8px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-right-color: white;
            border-bottom: none;
            border-left: none;
        }
        
        .message-ai::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -9px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-right-color: #e5e7eb;
            border-bottom: none;
            border-left: none;
        }
        
        .message-time {
            @apply text-xs text-gray-500 mt-1;
        }
        
        .message-avatar {
            @apply w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white;
        }
        
        .avatar-ai {
            @apply bg-gradient-to-r from-blue-500 to-blue-600;
        }
        
        .avatar-user {
            @apply bg-gradient-to-r from-yellow-500 to-yellow-600;
        }
        
        /* AI 載入動畫 */
        .ai-loading-message {
            @apply mb-4 flex items-center space-x-3 p-4 bg-white rounded-lg shadow-sm border border-gray-200;
        }
        
        .ai-loading-spinner {
            @apply w-6 h-6 border-2 border-blue-200 border-t-blue-500 rounded-full animate-spin;
        }
        
        @keyframes ai-loading-bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translate3d(0, 0, 0);
            }
            40%, 43% {
                transform: translate3d(0, -8px, 0);
            }
            70% {
                transform: translate3d(0, -4px, 0);
            }
            90% {
                transform: translate3d(0, -2px, 0);
            }
        }
        
        .ai-loading-bounce {
            animation: ai-loading-bounce 2s infinite;
        }
        
        /* 訊息氣泡樣式 */
        .message-content {
            white-space: pre-line;
            word-wrap: break-word;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">
    <!-- 登入頁面 -->
    <div id="login-page" class="min-h-screen flex flex-col items-center justify-center p-4 bg-gradient-to-br from-yellow-100 to-blue-100">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full text-center fade-in">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-4" data-zh="AI 留學顧問" data-en="AI Study Abroad Advisor">AI 留學顧問</h1>
            <p class="text-lg text-gray-600 mb-8" data-zh="您的個人化留學規劃專家" data-en="Your Personalized Study Abroad Planning Expert">您的個人化留學規劃專家</p>
            
            <div id="auth-section" class="mb-6">
                <div id="user-info" class="hidden mb-4">
                    <img id="user-avatar" class="w-16 h-16 rounded-full mx-auto mb-2" src="" alt="User Avatar">
                    <p class="text-xl font-semibold">歡迎，<span id="user-name"></span>!</p>
                    <button onclick="logout()" class="mt-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">登出</button>
                </div>
                <div id="login-buttons">
                    <p class="text-gray-700 mb-4" data-zh="請登入以繼續" data-en="Please login to continue">請登入以繼續</p>
                    <button onclick="skipLogin()" class="w-full flex items-center justify-center px-4 py-3 mb-3 bg-yellow-400 text-gray-800 rounded-lg hover:bg-yellow-500 transition-colors font-medium shadow-md mobile-button mobile-optimized">
                        <span data-zh="跳過登入，直接開始" data-en="Skip login, start directly">跳過登入，直接開始</span>
                    </button>
                    <button onclick="loginWithGoogle()" id="google-login-btn" class="w-full flex items-center justify-center px-4 py-3 mb-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium shadow-md mobile-button mobile-optimized">
                        <img src="https://img.icons8.com/color/24/000000/google-logo.png" alt="Google" class="w-5 h-5 mr-2">
                        <span data-zh="使用 Google 登入" data-en="Login with Google">使用 Google 登入</span>
                    </button>
                    <button onclick="showLineUnavailable()" class="w-full flex items-center justify-center px-4 py-3 bg-gray-400 text-white rounded-lg transition-colors font-medium shadow-md mobile-button mobile-optimized" disabled>
                        <img src="https://img.icons8.com/color/24/000000/line-me.png" alt="LINE" class="w-5 h-5 mr-2">
                        <span data-zh="LINE 登入 (開發中)" data-en="LINE Login (In Development)">LINE 登入 (開發中)</span>
                    </button>
                    <div class="text-xs text-gray-500 mt-2 text-center" data-zh="LINE 登入功能開發中，請先使用 Google 登入或跳過登入" data-en="LINE login is under development, please use Google login or skip login">LINE 登入功能開發中，請先使用 Google 登入或跳過登入</div>
                </div>
            </div>


            <!-- 語言切換 -->
            <div class="mt-6 flex justify-center space-x-4">
                <button onclick="switchLanguage('zh')" id="lang-switch-zh" 
                        class="px-4 py-2 text-sm rounded-lg bg-blue-500 text-white transition-colors">
                    中文
                </button>
                <button onclick="switchLanguage('en')" id="lang-switch-en" 
                        class="px-4 py-2 text-sm rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">
                    English
                </button>
            </div>
        </div>
    </div>

    <!-- 用戶資訊頁面（登入後的歡迎頁面） -->
    <div id="user-info-page" class="min-h-screen hidden">
        <div class="max-w-2xl mx-auto bg-white min-h-screen">
            <header class="bg-gradient-to-r from-yellow-400 to-yellow-300 text-gray-800 p-4 sm:p-6 relative">
                <button onclick="logout()" class="absolute right-2 sm:right-4 top-4 sm:top-6 text-gray-800 hover:text-gray-600 transition-colors text-sm sm:text-base">
                    <span data-zh="登出" data-en="Logout">登出</span>
                </button>
                <div class="text-center px-12 sm:px-0">
                    <h1 class="text-base sm:text-xl lg:text-2xl font-bold mb-1 sm:mb-2 leading-tight" data-zh="歡迎回來！" data-en="Welcome Back!">歡迎回來！</h1>
                    <p class="text-gray-600 text-xs sm:text-base leading-tight" data-zh="繼續您的留學規劃之旅" data-en="Continue your study abroad planning journey">繼續您的留學規劃之旅</p>
                </div>
            </header>

            <main class="p-6">
                <!-- 用戶資訊卡片 -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border border-blue-100 mb-6">
                    <div class="flex items-center mb-4">
                        <img id="user-info-avatar" class="w-16 h-16 rounded-full mr-4" src="" alt="User Avatar">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800" id="user-info-name">用戶名稱</h2>
                            <p class="text-gray-600" id="user-info-role">學生</p>
                        </div>
                    </div>
                    <p class="text-gray-700" data-zh="您的留學規劃資料已準備就緒，讓我們開始諮詢吧！" data-en="Your study abroad planning data is ready, let's start consulting!">您的留學規劃資料已準備就緒，讓我們開始諮詢吧！</p>
                </div>

                <!-- 主要操作按鈕 -->
                <div class="space-y-4">
                    <button onclick="continueToChat()" class="w-full bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-800 py-4 px-6 rounded-xl font-semibold hover:from-yellow-500 hover:to-yellow-600 transition-all duration-200 text-lg shadow-lg flex items-center justify-center">
                        <span class="mr-2">💬</span>
                        <span data-zh="繼續跟AI留學顧問諮詢" data-en="Continue Consulting with AI Study Abroad Advisor">繼續跟AI留學顧問諮詢</span>
                    </button>
                    
                    <button onclick="openUserSettings()" class="w-full bg-white text-gray-700 py-3 px-6 rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors font-medium flex items-center justify-center">
                        <span class="mr-2">⚙️</span>
                        <span data-zh="編輯設定資料" data-en="Edit Settings">編輯設定資料</span>
                    </button>
                </div>

                <!-- 家長專用功能 -->
                <div id="parent-only-section" class="mt-6 hidden">
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-lg border border-green-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3" data-zh="家長專用功能" data-en="Parent-Only Features">家長專用功能</h3>
                        <button onclick="queryStudentProgress()" class="w-full bg-green-500 text-white py-3 px-4 rounded-lg hover:bg-green-600 transition-colors font-medium">
                            <span class="mr-2">📊</span>
                            <span data-zh="查詢學生進度" data-en="Query Student Progress">查詢學生進度</span>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 設定頁面 -->
    <div id="setup-page" class="min-h-screen hidden">
        <div class="max-w-2xl mx-auto bg-white min-h-screen">
            <header class="bg-gradient-to-r from-yellow-400 to-yellow-300 text-gray-800 p-4 sm:p-6 relative">
                <button id="back-to-home" class="absolute left-2 sm:left-4 top-4 sm:top-6 text-gray-800 hover:text-gray-600 transition-colors text-sm sm:text-base z-10">
                    <span data-zh="← Back" data-en="← Back">← Back</span>
                </button>
                <div class="text-center px-12 sm:px-0">
                    <h1 class="text-base sm:text-xl lg:text-2xl font-bold mb-1 sm:mb-2 leading-tight" data-zh="設定您的留學需求" data-en="Set Your Study Abroad Requirements">設定您的留學需求</h1>
                    <p class="text-gray-600 text-xs sm:text-base leading-tight" data-zh="讓我們先了解您的基本資訊" data-en="Let us understand your basic information first">讓我們先了解您的基本資訊</p>
                </div>
            </header>

            <!-- Setup Form -->
            <main class="p-6">
                <form id="setup-form" class="space-y-6">
                    <!-- 個人基本資訊 -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">1</span>
                                <span data-zh="個人基本資訊" data-en="Personal Information">個人基本資訊</span>
                            </div>
                        </h3>
                        <div id="student-fields" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="學生姓名 *" data-en="Student Name *">學生姓名 *</label>
                                <input type="text" id="student_name" name="student_name" required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="例如：王小明" data-en-ph="e.g., David Wang" placeholder="例如：王小明">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="學生電子郵件 *" data-en="Student Email *">學生電子郵件 *</label>
                                <input type="email" id="student_email" name="student_email" required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="例如：david@example.com" data-en-ph="e.g., david@example.com" placeholder="例如：david@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="國籍 *" data-en="Citizenship *">國籍 *</label>
                                <input type="text" id="citizenship" name="citizenship" required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="例如：台灣" data-en-ph="e.g., Taiwan" placeholder="例如：台灣">
                            </div>
                        </div>
                        <div id="parent-fields" class="space-y-4 hidden">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="家長姓名 *" data-en="Parent Name *">家長姓名 *</label>
                                <input type="text" id="parent_name" name="parent_name"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="例如：王媽媽" data-en-ph="e.g., Alice Wang" placeholder="例如：王媽媽">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="家長電子郵件 *" data-en="Parent Email *">家長電子郵件 *</label>
                                <input type="email" id="parent_email" name="parent_email"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="例如：parent@example.com" data-en-ph="e.g., parent@example.com" placeholder="例如：parent@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="與學生關係 *" data-en="Relationship to Student *">與學生關係 *</label>
                                <input type="text" id="relationship" name="relationship"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="例如：母親 / 父親" data-en-ph="e.g., Mother / Father" placeholder="例如：母親">
                            </div>
                            <div class="border-t pt-4">
                                <p class="text-sm text-gray-500 mb-2" data-zh="學生聯絡資料" data-en="Student Contact">學生聯絡資料</p>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="學生姓名 *" data-en="Student Name *">學生姓名 *</label>
                                <input type="text" id="child_name" name="child_name"
                                    class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    data-zh-ph="例如：王小明" data-en-ph="e.g., David Wang" placeholder="例如：王小明">
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="學生電子郵件 *" data-en="Student Email *">學生電子郵件 *</label>
                                <input type="email" id="child_email" name="child_email"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="例如：david@example.com" data-en-ph="e.g., david@example.com" placeholder="例如：david@example.com">
                            </div>
                        </div>
                    </div>

                    <!-- 學術背景 -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">2</span>
                                <span data-zh="學術背景" data-en="Academic Background">學術背景</span>
                            </div>
                        </h3>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="GPA (滿分4.0) *" data-en="GPA (out of 4.0) *">GPA (滿分4.0) *</label>
                            <input type="number" id="gpa" name="gpa" step="0.1" min="0" max="4" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                data-zh-ph="例如：3.8" data-en-ph="e.g., 3.8" placeholder="例如：3.8">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="目標學位 *" data-en="Target Degree *">目標學位 *</label>
                            <select id="degree" name="degree" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized">
                                <option value="" data-zh="請選擇" data-en="Please select">請選擇</option>
                                <option value="bachelor" data-zh="學士" data-en="Bachelor's">學士</option>
                                <option value="master" data-zh="碩士" data-en="Master's">碩士</option>
                                <option value="phd" data-zh="博士" data-en="PhD">博士</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="目標國家 *" data-en="Target Countries *">目標國家 *</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center">
                                    <input type="checkbox" name="countries" value="us" class="mr-2">
                                    <span data-zh="美國" data-en="USA">美國</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="countries" value="uk" class="mr-2">
                                    <span data-zh="英國" data-en="UK">英國</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="countries" value="ca" class="mr-2">
                                    <span data-zh="加拿大" data-en="Canada">加拿大</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 預算和時間 -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">3</span>
                                <span data-zh="預算和時間" data-en="Budget and Time">預算和時間</span>
                            </div>
                        </h3>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="預算 (每年學費+生活費，單位：美元) *" data-en="Budget (Annual tuition + living expenses, USD) *">預算 (每年學費+生活費，單位：美元) *</label>
                            <input type="number" id="budget" name="budget" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                data-zh-ph="例如：50000" data-en-ph="e.g., 50000" placeholder="例如：50000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="目標入學時間 *" data-en="Target Intake Time *">目標入學時間 *</label>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                <select id="intake_semester" name="intake_semester" required 
                                    class="w-full sm:w-1/3 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                    <option value="" data-zh="選擇學期" data-en="Select Semester">選擇學期</option>
                                    <option value="fall" data-zh="秋季" data-en="Fall">秋季</option>
                                    <option value="spring" data-zh="春季" data-en="Spring">春季</option>
                                    <option value="summer" data-zh="夏季" data-en="Summer">夏季</option>
                                    <option value="winter" data-zh="冬季" data-en="Winter">冬季</option>
                                </select>
                                <select id="intake_year" name="intake_year" required 
                                    class="w-full sm:w-2/3 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                    <option value="" data-zh="選擇年份" data-en="Select Year">選擇年份</option>
                                </select>
                            </div>
                            <input type="hidden" id="target_intake" name="target_intake">
                        </div>
                    </div>

                    <!-- 角色選擇 -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">4</span>
                                <span data-zh="選擇您的身份" data-en="Choose Your Role">選擇您的身份</span>
                            </div>
                        </h3>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                            <button type="button" onclick="selectRole('student')" id="role-student" 
                                    class="flex-1 px-4 sm:px-6 py-3 bg-blue-500 text-white rounded-lg font-medium transition-colors text-sm sm:text-base">
                                <span data-zh="👨‍🎓 我是學生" data-en="👨‍🎓 I am a Student">👨‍🎓 我是學生</span>
                            </button>
                            <button type="button" onclick="selectRole('parent')" id="role-parent" 
                                    class="flex-1 px-4 sm:px-6 py-3 bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors hover:bg-gray-400 text-sm sm:text-base">
                                <span data-zh="👨‍👩‍👧‍👦 我是家長" data-en="👨‍👩‍👧‍👦 I am a Parent">👨‍👩‍👧‍👦 我是家長</span>
                            </button>
                        </div>
                    </div>

                    <button type="submit" 
                            class="w-full bg-yellow-400 text-gray-800 py-3 px-6 rounded-lg font-medium hover:bg-yellow-500 transition-colors duration-200 text-lg shadow-lg"
                            data-zh="開始與AI顧問對話" data-en="Start Chat with AI Advisor">
                        開始與AI顧問對話
                    </button>
                </form>
            </main>
        </div>
    </div>

    <!-- 聊天頁面 -->
    <div id="chat-page" class="min-h-screen hidden">
        <div class="max-w-4xl mx-auto bg-white min-h-screen flex flex-col">
            <header class="bg-gradient-to-r from-yellow-400 to-yellow-300 text-gray-800 p-4 text-center relative">
                <button id="back-to-setup" class="absolute left-4 top-4 text-gray-800 hover:text-gray-600 transition-colors">
                    <span data-zh="← 重新設定" data-en="← Reset Settings">← 重新設定</span>
                </button>
                <button onclick="logout()" class="absolute right-4 top-4 text-gray-800 hover:text-gray-600 transition-colors">
                    <span data-zh="登出" data-en="Logout">登出</span>
                </button>
                <h1 class="text-xl font-bold" data-zh="AI 留學顧問" data-en="AI Study Abroad Advisor">AI 留學顧問</h1>
                <p class="text-sm" data-zh="正在為您提供專業建議" data-en="Providing you with professional advice">正在為您提供專業建議</p>
                <div class="flex items-center justify-center mt-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                    <span class="text-sm" data-zh="在線" data-en="Online">在線</span>
                </div>
            </header>

            <main class="flex-1 p-6 overflow-y-auto bg-white chat-container mobile-optimized" id="chat-container">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-4">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">AI</div>
                            <div>
                                <h3 class="font-semibold text-gray-800" data-zh="AI 留學顧問" data-en="AI Study Abroad Advisor">AI 留學顧問</h3>
                                <p class="text-sm text-gray-500" data-zh="您的專屬留學規劃專家" data-en="Your Exclusive Study Abroad Planning Expert">您的專屬留學規劃專家</p>
                            </div>
                        </div>
                        <div class="text-gray-700 leading-relaxed">
                            <p class="mb-3" data-zh="🎓 您好！我是您的AI留學顧問。" data-en="🎓 Hello! I am your AI Study Abroad Advisor.">🎓 您好！我是您的AI留學顧問。</p>
                            <p class="mb-3" data-zh="我已經了解了您的基本資訊，現在讓我們深入討論您的留學計劃吧！" data-en="I have reviewed your basic information, now let's dive deep into your study abroad planning!">我已經了解了您的基本資訊，現在讓我們深入討論您的留學計劃吧！</p>
                            <p class="mb-3" data-zh="您可以問我任何關於留學的問題，比如：" data-en="You can ask me any questions about studying abroad, such as:">您可以問我任何關於留學的問題，比如：</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-4">
                                <div class="flex items-center text-sm text-gray-600">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                    <span data-zh="推薦適合的學校和專業" data-en="School and major recommendations">推薦適合的學校和專業</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                    <span data-zh="申請流程和時間規劃" data-en="Application process and timeline">申請流程和時間規劃</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                    <span data-zh="獎學金申請建議" data-en="Scholarship application advice">獎學金申請建議</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                    <span data-zh="簽證和住宿資訊" data-en="Visa and accommodation info">簽證和住宿資訊</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-400 mt-3" data-zh="剛剛" data-en="Just now">剛剛</div>
                    </div>
                </div>
            </main>

            <footer class="p-6 border-t border-gray-200 bg-gray-50">
                <div class="max-w-4xl mx-auto">
                    <div id="quick-actions" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 mb-4"></div>
                    <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                        <textarea id="message-input" rows="2"
                               class="flex-1 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base bg-white resize-none"
                               placeholder="告訴我你的留學需求、目標或困惑..."
                               data-zh-ph="告訴我你的留學需求、目標或困惑..."
                               data-en-ph="Tell me your study abroad needs, goals, or confusions..."></textarea>
                        <button id="send-btn" 
                                class="px-6 py-4 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition-colors text-sm sm:text-base flex items-center justify-center">
                            <span data-zh="送出" data-en="Send">送出</span>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-3 text-center" data-zh="按 Ctrl+Enter 發送，Enter 換行" data-en="Press Ctrl+Enter to send, Enter for new line">按 Ctrl+Enter 發送，Enter 換行</p>
                </div>
            </footer>
        </div>
    </div>

    <!-- 用戶設定模態框 -->
    <div id="user-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800" data-zh="個人設定" data-en="Personal Settings">個人設定</h2>
                <button onclick="closeUserSettings()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-6">
                <!-- 基本資訊 -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4" data-zh="基本資訊" data-en="Basic Information">基本資訊</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="顯示名稱" data-en="Display Name">顯示名稱</label>
                            <input type="text" id="settings-display-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="語言偏好" data-en="Language Preference">語言偏好</label>
                            <select id="settings-language" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="zh" data-zh="中文" data-en="Chinese">中文</option>
                                <option value="en" data-zh="English" data-en="English">English</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 通知設定 -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4" data-zh="通知設定" data-en="Notification Settings">通知設定</h3>
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="checkbox" id="settings-email-notifications" class="mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <span class="text-gray-700" data-zh="接收電子郵件通知" data-en="Receive email notifications">接收電子郵件通知</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="settings-push-notifications" class="mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <span class="text-gray-700" data-zh="接收推送通知" data-en="Receive push notifications">接收推送通知</span>
                        </label>
                    </div>
                </div>

                <!-- 隱私設定 -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4" data-zh="隱私設定" data-en="Privacy Settings">隱私設定</h3>
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="checkbox" id="settings-data-sharing" class="mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <span class="text-gray-700" data-zh="允許匿名數據分享以改善服務" data-en="Allow anonymous data sharing to improve service">允許匿名數據分享以改善服務</span>
                        </label>
                    </div>
                </div>

                <!-- 編輯設定資料 -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4" data-zh="留學設定資料" data-en="Study Abroad Settings">留學設定資料</h3>
                    <div id="profile-data-display" class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-gray-600 text-center" data-zh="載入中..." data-en="Loading...">載入中...</p>
                    </div>
                    <button onclick="editProfileData()" class="w-full mt-3 bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        <span data-zh="編輯設定資料" data-en="Edit Profile Data">編輯設定資料</span>
                    </button>
                </div>

                <!-- 操作按鈕 -->
                <div class="flex space-x-3">
                    <button onclick="saveUserSettings()" class="flex-1 bg-green-500 text-white py-3 px-4 rounded-lg hover:bg-green-600 transition-colors font-medium">
                        <span data-zh="儲存設定" data-en="Save Settings">儲存設定</span>
                    </button>
                    <button onclick="closeUserSettings()" class="flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                        <span data-zh="取消" data-en="Cancel">取消</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 編輯設定資料模態框 -->
    <div id="edit-profile-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800" data-zh="編輯留學設定" data-en="Edit Study Abroad Settings">編輯留學設定</h2>
                <button onclick="closeEditProfileModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-6">
                <form id="edit-profile-form">
                    <!-- 這裡會動態載入設定表單 -->
                    <div id="edit-profile-content">
                        <p class="text-gray-600 text-center" data-zh="載入設定資料中..." data-en="Loading settings data...">載入設定資料中...</p>
                    </div>
                    
                    <div class="flex space-x-3 mt-6">
                        <button type="submit" class="flex-1 bg-blue-500 text-white py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors font-medium">
                            <span data-zh="儲存變更" data-en="Save Changes">儲存變更</span>
                        </button>
                        <button type="button" onclick="closeEditProfileModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                            <span data-zh="取消" data-en="Cancel">取消</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 學生進度查詢模態框 -->
    <div id="student-progress-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800" data-zh="學生諮詢進度" data-en="Student Consultation Progress">學生諮詢進度</h2>
                <button onclick="closeStudentProgressModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-6">
                <div id="student-progress-content">
                    <p class="text-gray-600 text-center" data-zh="載入進度資料中..." data-en="Loading progress data...">載入進度資料中...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局變量
        var currentRole = 'student';
        var currentLanguage = 'zh';
        var profileId = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 取得 Google Client ID 以初始化 GIS
            fetch(window.__CONFIG__.API_BASE + '/auth/config')
                .then(r => r.json())
                .then(cfg => {
                    if (cfg && cfg.ok && cfg.googleClientId) {
                        window.__GOOGLE_CLIENT_ID__ = cfg.googleClientId;
                        console.log('Google Client ID loaded:', cfg.googleClientId);
                    } else {
                        console.warn('Google Client ID not configured');
                    }
                })
                .catch((error) => {
                    console.error('Failed to load Google Client ID:', error);
                });
            // 檢查登入狀態
            checkAuthStatus();
            
            // 初始化年份選項
            initializeYearOptions();
            
            // 綁定事件
            document.getElementById('back-to-home').addEventListener('click', showLoginPage);
            document.getElementById('back-to-setup').addEventListener('click', showSetupPage);
            document.getElementById('setup-form').addEventListener('submit', handleSetupSubmit);
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    // Ctrl+Enter 發送訊息
                    sendMessage();
                }
                // 單獨按 Enter 只換行，不發送
            });
            
            // 綁定日期選擇事件
            document.getElementById('intake_semester').addEventListener('change', updateTargetIntake);
            document.getElementById('intake_year').addEventListener('change', updateTargetIntake);
        });

        // 檢查認證狀態
        function checkAuthStatus() {
            try {
                fetch(window.__CONFIG__.API_BASE + '/auth/status')
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (data.ok && data.user) {
                        showUserInfo(data.user);
                    } else {
                        showLoginButtons();
                    }
                })
                .catch(function(error) {
                    console.error('Auth check failed:', error);
                    showLoginButtons();
                });
            } catch (error) {
                console.error('Auth check failed:', error);
                showLoginButtons();
            }
        }

        // 顯示用戶資訊
        function showUserInfo(user) {
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('login-buttons').classList.add('hidden');
            document.getElementById('user-name').textContent = user.name;
            if (user.avatar) {
                document.getElementById('user-avatar').src = user.avatar;
            }
        }

        // 顯示登入按鈕
        function showLoginButtons() {
            document.getElementById('user-info').classList.add('hidden');
            document.getElementById('login-buttons').classList.remove('hidden');
        }

        // 登入功能
        function loginWithGoogle() {
            // 檢查是否在手機環境
            var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // 手機環境：直接跳轉到 Google OAuth
                var googleAuthUrl = 'https://accounts.google.com/o/oauth2/v2/auth?' +
                    'client_id=300123710303-m4j1laa65p664n5vtrdkfvfa7b42c2o6.apps.googleusercontent.com&' +
                    'redirect_uri=https://aistudentbackend.zeabur.app/auth/google/callback&' +
                    'response_type=code&' +
                    'scope=openid email profile&' +
                    'state=mobile_login';
                
                window.location.href = googleAuthUrl;
                return;
            }
            
            // 桌面環境：使用 Google API
            if (!window.__GOOGLE_CLIENT_ID__) {
                alert(currentLanguage === 'en' ? 
                    'Google OAuth is not configured. Please use "Skip login" for now.' : 
                    'Google OAuth 尚未配置。請先使用「跳過登入」功能。');
                return;
            }
            
            console.log('Attempting Google login with Client ID:', window.__GOOGLE_CLIENT_ID__);
            
            // 改用 one-tap 的 ID token API
            google.accounts.id.initialize({
                client_id: window.__GOOGLE_CLIENT_ID__,
                callback: async (resp) => {
                    try {
                        var idToken = resp.credential;
                        var r = await fetch(window.__CONFIG__.API_BASE + '/auth/google/verify', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ idToken })
                        });
                        var data = await r.json();
                        if (data.ok && data.token) {
                            localStorage.setItem('jwt', data.token);
                            showUserInfo(data.user || { name: 'User' });
                            showSetupPage();
                        } else {
                            alert(currentLanguage === 'en' ? 'Login failed.' : '登入失敗');
                        }
                    } catch (err) {
                        alert(currentLanguage === 'en' ? 'Login failed.' : '登入失敗');
                    }
                }
            });
            
            // 改用直接跳轉方式（統一使用 OAuth 回調）
            var googleAuthUrl = 'https://accounts.google.com/o/oauth2/v2/auth?' +
                'client_id=300123710303-m4j1laa65p664n5vtrdkfvfa7b42c2o6.apps.googleusercontent.com&' +
                'redirect_uri=https://aistudentbackend.zeabur.app/auth/google/callback&' +
                'response_type=code&' +
                'scope=openid email profile&' +
                'state=desktop_login';
            
            window.location.href = googleAuthUrl;
        }

        function loginWithLINE() {
            // 獲取 LINE Login URL
            fetch('https://aistudentbackend.zeabur.app/api/v1/auth/line/login')
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (data.ok) {
                        // 重定向到 LINE Login
                        window.location.href = data.login_url;
                    } else {
                        alert(currentLanguage === 'en' ? 
                            'LINE login is not available. Please use Google login or skip login.' : 
                            'LINE 登入功能暫時無法使用，請使用 Google 登入或跳過登入。');
                    }
                })
                .catch(function(error) {
                    console.error('LINE Login error:', error);
                    alert(currentLanguage === 'en' ? 
                        'LINE login failed. Please try again or use Google login.' : 
                        'LINE 登入失敗，請重試或使用 Google 登入。');
                });
        }
        
        // 登出功能
        function logout() {
            // 清除本地儲存
            localStorage.removeItem('jwt');
            localStorage.removeItem('userProfile');
            
            // 顯示登出成功訊息
            alert(currentLanguage === 'en' ? 
                'You have been logged out successfully.' : 
                '您已成功登出。');
            
            // 重新載入頁面
            window.location.href = 'https://aistudent.zeabur.app';
        }


        // 跳過登入
        function skipLogin() {
            // 創建一個假的 JWT token 用於測試
            var fakeToken = 'fake-jwt-token-for-testing';
            localStorage.setItem('jwt', fakeToken);
            showSetupPage();
        }

        // 載入用戶資訊
        function loadUserInfo() {
            try {
                var userProfile = localStorage.getItem('userProfile');
                if (userProfile) {
                    var user = JSON.parse(userProfile);
                    document.getElementById('user-info-name').textContent = user.name || '用戶';
                    document.getElementById('user-info-role').textContent = currentRole === 'parent' ? '家長' : '學生';
                    if (user.avatar) {
                        document.getElementById('user-info-avatar').src = user.avatar;
                    }
                }
                
                // 根據角色顯示/隱藏家長專用功能
                var parentSection = document.getElementById('parent-only-section');
                if (currentRole === 'parent') {
                    parentSection.classList.remove('hidden');
                } else {
                    parentSection.classList.add('hidden');
                }
            } catch (error) {
                console.error('載入用戶資訊失敗:', error);
            }
        }

        // 繼續到聊天
        function continueToChat() {
            // 檢查是否有 profile 資料
            if (!profileId) {
                // 檢查本地儲存的 profileId
                var storedProfileId = localStorage.getItem('profileId');
                if (storedProfileId) {
                    profileId = storedProfileId;
                } else {
                    // 沒有 profile 資料，跳轉到設定頁面
                    showSetupPage();
                    return;
                }
            }
            showChatPage();
        }

        // 開啟用戶設定
        function openUserSettings() {
            document.getElementById('user-settings-modal').classList.remove('hidden');
            loadUserSettings();
        }

        // 關閉用戶設定
        function closeUserSettings() {
            document.getElementById('user-settings-modal').classList.add('hidden');
        }

        // 載入用戶設定
        function loadUserSettings() {
            try {
                var userProfile = localStorage.getItem('userProfile');
                if (userProfile) {
                    var user = JSON.parse(userProfile);
                    document.getElementById('settings-display-name').value = user.name || '';
                }
                
                document.getElementById('settings-language').value = currentLanguage;
                
                // 載入通知設定
                loadNotificationSettings();
                
                // 載入 profile 資料
                loadUserProfileData();
            } catch (error) {
                console.error('載入用戶設定失敗:', error);
            }
        }

        // 載入通知設定
        function loadNotificationSettings() {
            try {
                var jwt = localStorage.getItem('jwt');
                if (!jwt) return;
                
                fetch(window.__CONFIG__.API_BASE + '/user/notification-settings', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + jwt,
                        'Content-Type': 'application/json'
                    }
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    if (result.ok && result.data) {
                        document.getElementById('settings-email-notifications').checked = result.data.email_notifications || false;
                        document.getElementById('settings-push-notifications').checked = result.data.push_notifications || false;
                    }
                })
                .catch(function(error) {
                    console.error('載入通知設定失敗:', error);
                });
            } catch (error) {
                console.error('載入通知設定失敗:', error);
            }
        }

        // 載入用戶 profile 資料
        function loadUserProfileData() {
            try {
                if (!profileId) {
                    document.getElementById('profile-data-display').innerHTML = 
                        '<p class="text-yellow-600 text-center" data-zh="尚未設定留學需求資料" data-en="Study abroad requirements not set yet">尚未設定留學需求資料</p>';
                    return;
                }
                
                var jwt = localStorage.getItem('jwt');
                if (!jwt) return;
                
                fetch(window.__CONFIG__.API_BASE + '/user/profile/' + profileId, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + jwt,
                        'Content-Type': 'application/json'
                    }
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    if (result.ok && result.data) {
                        var profile = result.data;
                        var displayHtml = '<div class="space-y-2">';
                        
                        if (profile.student_name) {
                            displayHtml += '<p><span class="font-medium">學生姓名：</span>' + profile.student_name + '</p>';
                        }
                        if (profile.gpa) {
                            displayHtml += '<p><span class="font-medium">GPA：</span>' + profile.gpa + '</p>';
                        }
                        if (profile.degree) {
                            displayHtml += '<p><span class="font-medium">目標學位：</span>' + profile.degree + '</p>';
                        }
                        if (profile.countries && profile.countries.length > 0) {
                            displayHtml += '<p><span class="font-medium">目標國家：</span>' + profile.countries.join(', ') + '</p>';
                        }
                        if (profile.budget) {
                            displayHtml += '<p><span class="font-medium">預算：</span>$' + profile.budget.toLocaleString() + ' USD/年</p>';
                        }
                        if (profile.target_intake) {
                            displayHtml += '<p><span class="font-medium">目標入學時間：</span>' + profile.target_intake + '</p>';
                        }
                        
                        displayHtml += '</div>';
                        document.getElementById('profile-data-display').innerHTML = displayHtml;
                    } else {
                        document.getElementById('profile-data-display').innerHTML = 
                            '<p class="text-yellow-600 text-center" data-zh="載入設定資料失敗" data-en="Failed to load settings data">載入設定資料失敗</p>';
                    }
                })
                .catch(function(error) {
                    console.error('載入 profile 資料失敗:', error);
                    document.getElementById('profile-data-display').innerHTML = 
                        '<p class="text-red-600 text-center" data-zh="載入設定資料失敗" data-en="Failed to load settings data">載入設定資料失敗</p>';
                });
            } catch (error) {
                console.error('載入 profile 資料失敗:', error);
            }
        }

        // 儲存用戶設定
        function saveUserSettings() {
            try {
                var jwt = localStorage.getItem('jwt');
                if (!jwt) {
                    alert(currentLanguage === 'en' ? 'Please login first' : '請先登入');
                    return;
                }
                
                var settings = {
                    display_name: document.getElementById('settings-display-name').value,
                    language: document.getElementById('settings-language').value,
                    email_notifications: document.getElementById('settings-email-notifications').checked,
                    push_notifications: document.getElementById('settings-push-notifications').checked,
                    data_sharing: document.getElementById('settings-data-sharing').checked
                };
                
                // 儲存通知設定
                fetch(window.__CONFIG__.API_BASE + '/user/notification-settings', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + jwt,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email_notifications: settings.email_notifications,
                        push_notifications: settings.push_notifications
                    })
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    if (result.ok) {
                        // 更新語言
                        if (settings.language !== currentLanguage) {
                            switchLanguage(settings.language);
                        }
                        
                        alert(currentLanguage === 'en' ? 'Settings saved successfully!' : '設定已儲存！');
                        closeUserSettings();
                    } else {
                        alert(currentLanguage === 'en' ? 'Failed to save settings' : '儲存設定失敗');
                    }
                })
                .catch(function(error) {
                    console.error('儲存設定失敗:', error);
                    alert(currentLanguage === 'en' ? 'Failed to save settings' : '儲存設定失敗');
                });
            } catch (error) {
                console.error('儲存設定失敗:', error);
                alert(currentLanguage === 'en' ? 'Failed to save settings' : '儲存設定失敗');
            }
        }

        // 編輯 profile 資料
        function editProfileData() {
            document.getElementById('edit-profile-modal').classList.remove('hidden');
            loadEditProfileForm();
        }

        // 關閉編輯 profile 模態框
        function closeEditProfileModal() {
            document.getElementById('edit-profile-modal').classList.add('hidden');
        }

        // 載入編輯 profile 表單
        function loadEditProfileForm() {
            try {
                if (!profileId) {
                    document.getElementById('edit-profile-content').innerHTML = 
                        '<p class="text-yellow-600 text-center" data-zh="尚未設定留學需求資料" data-en="Study abroad requirements not set yet">尚未設定留學需求資料</p>';
                    return;
                }
                
                var jwt = localStorage.getItem('jwt');
                if (!jwt) return;
                
                fetch(window.__CONFIG__.API_BASE + '/user/profile/' + profileId, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + jwt,
                        'Content-Type': 'application/json'
                    }
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    if (result.ok && result.data) {
                        var profile = result.data;
                        var formHtml = '<div class="space-y-4">';
                        
                        formHtml += '<div>';
                        formHtml += '<label class="block text-sm font-medium text-gray-700 mb-2" data-zh="學生姓名" data-en="Student Name">學生姓名</label>';
                        formHtml += '<input type="text" id="edit-student-name" value="' + (profile.student_name || '') + '" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">';
                        formHtml += '</div>';
                        
                        formHtml += '<div>';
                        formHtml += '<label class="block text-sm font-medium text-gray-700 mb-2" data-zh="GPA" data-en="GPA">GPA</label>';
                        formHtml += '<input type="number" id="edit-gpa" step="0.1" min="0" max="4" value="' + (profile.gpa || '') + '" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">';
                        formHtml += '</div>';
                        
                        formHtml += '<div>';
                        formHtml += '<label class="block text-sm font-medium text-gray-700 mb-2" data-zh="預算 (USD/年)" data-en="Budget (USD/year)">預算 (USD/年)</label>';
                        formHtml += '<input type="number" id="edit-budget" value="' + (profile.budget || '') + '" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">';
                        formHtml += '</div>';
                        
                        formHtml += '</div>';
                        document.getElementById('edit-profile-content').innerHTML = formHtml;
                    } else {
                        document.getElementById('edit-profile-content').innerHTML = 
                            '<p class="text-yellow-600 text-center" data-zh="載入設定資料失敗" data-en="Failed to load settings data">載入設定資料失敗</p>';
                    }
                })
                .catch(function(error) {
                    console.error('載入編輯表單失敗:', error);
                    document.getElementById('edit-profile-content').innerHTML = 
                        '<p class="text-red-600 text-center" data-zh="載入設定資料失敗" data-en="Failed to load settings data">載入設定資料失敗</p>';
                });
            } catch (error) {
                console.error('載入編輯表單失敗:', error);
            }
        }

        // 查詢學生進度（家長專用）
        function queryStudentProgress() {
            document.getElementById('student-progress-modal').classList.remove('hidden');
            loadStudentProgress();
        }

        // 關閉學生進度模態框
        function closeStudentProgressModal() {
            document.getElementById('student-progress-modal').classList.add('hidden');
        }

        // 載入學生進度
        function loadStudentProgress() {
            try {
                var jwt = localStorage.getItem('jwt');
                if (!jwt) {
                    document.getElementById('student-progress-content').innerHTML = 
                        '<p class="text-red-600 text-center" data-zh="請先登入" data-en="Please login first">請先登入</p>';
                    return;
                }
                
                fetch(window.__CONFIG__.API_BASE + '/parent/student-progress', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + jwt,
                        'Content-Type': 'application/json'
                    }
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    if (result.ok && result.data) {
                        var progress = result.data;
                        var progressHtml = '<div class="space-y-6">';
                        
                        // 活動統計
                        progressHtml += '<div class="bg-blue-50 p-4 rounded-lg">';
                        progressHtml += '<h3 class="text-lg font-semibold text-gray-800 mb-3" data-zh="活動統計" data-en="Activity Statistics">活動統計</h3>';
                        progressHtml += '<div class="grid grid-cols-2 gap-4">';
                        progressHtml += '<div class="text-center"><div class="text-2xl font-bold text-blue-600">' + (progress.total_sessions || 0) + '</div><div class="text-sm text-gray-600" data-zh="諮詢次數" data-en="Consultation Sessions">諮詢次數</div></div>';
                        progressHtml += '<div class="text-center"><div class="text-2xl font-bold text-green-600">' + (progress.total_messages || 0) + '</div><div class="text-sm text-gray-600" data-zh="對話數" data-en="Messages">對話數</div></div>';
                        progressHtml += '</div></div>';
                        
                        // 最近話題
                        if (progress.recent_topics && progress.recent_topics.length > 0) {
                            progressHtml += '<div class="bg-green-50 p-4 rounded-lg">';
                            progressHtml += '<h3 class="text-lg font-semibold text-gray-800 mb-3" data-zh="最近討論話題" data-en="Recent Topics">最近討論話題</h3>';
                            progressHtml += '<ul class="space-y-2">';
                            for (var i = 0; i < progress.recent_topics.length; i++) {
                                progressHtml += '<li class="flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>' + progress.recent_topics[i] + '</li>';
                            }
                            progressHtml += '</ul></div>';
                        }
                        
                        // AI 分析建議
                        if (progress.ai_analysis) {
                            progressHtml += '<div class="bg-yellow-50 p-4 rounded-lg">';
                            progressHtml += '<h3 class="text-lg font-semibold text-gray-800 mb-3" data-zh="AI 分析建議" data-en="AI Analysis & Recommendations">AI 分析建議</h3>';
                            progressHtml += '<div class="text-gray-700">' + progress.ai_analysis + '</div>';
                            progressHtml += '</div>';
                        }
                        
                        progressHtml += '</div>';
                        document.getElementById('student-progress-content').innerHTML = progressHtml;
                    } else {
                        document.getElementById('student-progress-content').innerHTML = 
                            '<p class="text-yellow-600 text-center" data-zh="暫無進度資料" data-en="No progress data available">暫無進度資料</p>';
                    }
                })
                .catch(function(error) {
                    console.error('載入學生進度失敗:', error);
                    document.getElementById('student-progress-content').innerHTML = 
                        '<p class="text-red-600 text-center" data-zh="載入進度資料失敗" data-en="Failed to load progress data">載入進度資料失敗</p>';
                });
            } catch (error) {
                console.error('載入學生進度失敗:', error);
            }
        }

        // AI 載入動畫
        function showAILoading() {
            var loadingDiv = document.createElement('div');
            loadingDiv.id = 'ai-loading';
            loadingDiv.className = 'ai-loading-message';
            loadingDiv.innerHTML = '<div class="ai-loading-spinner"></div><span data-zh="AI 正在思考中..." data-en="AI is thinking...">AI 正在思考中...</span>';
            document.getElementById('chat-container').appendChild(loadingDiv);
            document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;
        }

        function hideAILoading() {
            var loadingDiv = document.getElementById('ai-loading');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // 載入聊天歷史
        function loadChatHistory() {
            try {
                var chatHistory = localStorage.getItem('chatHistory_' + profileId);
                if (chatHistory) {
                    var messages = JSON.parse(chatHistory);
                    var chatContainer = document.getElementById('chat-container');
                    
                    // 清空現有內容（保留歡迎訊息）
                    var welcomeMessage = chatContainer.querySelector('.bg-white.rounded-lg.shadow-sm.border.border-gray-200');
                    chatContainer.innerHTML = '';
                    if (welcomeMessage) {
                        chatContainer.appendChild(welcomeMessage);
                    }
                    
                    // 載入歷史訊息
                    for (var i = 0; i < messages.length; i++) {
                        addMessage(messages[i].message, messages[i].sender, false);
                    }
                } else {
                    // 沒有歷史記錄，發送歡迎訊息
                    sendWelcomeMessage();
                }
            } catch (error) {
                console.error('載入聊天歷史失敗:', error);
                sendWelcomeMessage();
            }
        }

        // 儲存聊天歷史
        function saveChatHistory(message, sender) {
            try {
                if (!profileId) return;
                
                var chatHistory = localStorage.getItem('chatHistory_' + profileId);
                var messages = chatHistory ? JSON.parse(chatHistory) : [];
                
                messages.push({
                    message: message,
                    sender: sender,
                    timestamp: new Date().toISOString()
                });
                
                // 只保留最近 50 條訊息
                if (messages.length > 50) {
                    messages = messages.slice(-50);
                }
                
                localStorage.setItem('chatHistory_' + profileId, JSON.stringify(messages));
            } catch (error) {
                console.error('儲存聊天歷史失敗:', error);
            }
        }


        // 初始化年份選項
        function initializeYearOptions() {
            var yearSelect = document.getElementById('intake_year');
            var currentYear = new Date().getFullYear();
            
            // 生成未來 5 年的選項
            for (var i = 0; i < 5; i++) {
                var year = currentYear + i;
                var option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                option.setAttribute('data-zh', year);
                option.setAttribute('data-en', year);
                yearSelect.appendChild(option);
            }
        }

        // 更新目標入學時間
        function updateTargetIntake() {
            var semester = document.getElementById('intake_semester').value;
            var year = document.getElementById('intake_year').value;
            var targetIntakeInput = document.getElementById('target_intake');
            
            if (semester && year) {
                var semesterText = currentLanguage === 'en' 
                    ? semester.charAt(0).toUpperCase() + semester.slice(1)
                    : semester === 'fall' ? '秋季' : semester === 'spring' ? '春季' : semester === 'summer' ? '夏季' : '冬季';
                
                var intakeText = currentLanguage === 'en' 
                    ? semesterText + ' ' + year
                    : year + '年' + semesterText;
                
                targetIntakeInput.value = intakeText;
            } else {
                targetIntakeInput.value = '';
            }
        }

        // 語言切換
        function switchLanguage(lang) {
            currentLanguage = lang;
            // 更新所有具備 data-zh / data-en 的元素
            var elements = document.querySelectorAll('[data-zh]');
            for (var i = 0; i < elements.length; i++) {
                var el = elements[i];
                var text = el.getAttribute('data-' + currentLanguage);
                if (text) el.textContent = text;
            }
            // 更新 placeholder
            var inputs = document.querySelectorAll('[data-zh-ph]');
            for (var j = 0; j < inputs.length; j++) {
                var input = inputs[j];
                var placeholder = input.getAttribute('data-' + currentLanguage + '-ph');
                if (placeholder) input.placeholder = placeholder;
            }
            // 更新 select 選項
            var options = document.querySelectorAll('option[data-zh]');
            for (var k = 0; k < options.length; k++) {
                var option = options[k];
                var text = option.getAttribute('data-' + currentLanguage);
                if (text) option.textContent = text;
            }
            
            // 更新目標入學時間顯示
            updateTargetIntake();
            
            // 更新語言切換按鈕樣式（如果存在）
            var zhBtn = document.getElementById('lang-switch-zh');
            var enBtn = document.getElementById('lang-switch-en');
            if (zhBtn && enBtn) {
                zhBtn.classList.toggle('bg-blue-500', lang === 'zh');
                zhBtn.classList.toggle('bg-gray-200', lang !== 'zh');
                zhBtn.classList.toggle('text-white', lang === 'zh');
                zhBtn.classList.toggle('text-gray-700', lang !== 'zh');
                enBtn.classList.toggle('bg-blue-500', lang === 'en');
                enBtn.classList.toggle('bg-gray-200', lang !== 'en');
                enBtn.classList.toggle('text-white', lang === 'en');
                enBtn.classList.toggle('text-gray-700', lang !== 'en');
            }
            
            // 重新載入快速動作按鈕
            loadQuickActions();
        }

        // 角色選擇
        function selectRole(role) {
            currentRole = role;
            document.getElementById('role-student').classList.toggle('bg-blue-500', role === 'student');
            document.getElementById('role-student').classList.toggle('bg-gray-300', role !== 'student');
            document.getElementById('role-parent').classList.toggle('bg-blue-500', role === 'parent');
            document.getElementById('role-parent').classList.toggle('bg-gray-300', role !== 'parent');

            // 切換欄位顯示
            document.getElementById('student-fields').classList.toggle('hidden', role !== 'student');
            document.getElementById('parent-fields').classList.toggle('hidden', role !== 'parent');
            loadQuickActions();
        }

        // 頁面切換
        function showLoginPage() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('user-info-page').classList.add('hidden');
            document.getElementById('setup-page').classList.add('hidden');
            document.getElementById('chat-page').classList.add('hidden');
        }

        function validateToken(token) {
            // 簡單的 token 驗證，檢查是否為有效的 JWT 格式
            try {
                var parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid token format');
                }
                
                // 檢查 token 是否過期（簡單檢查）
                var payload = JSON.parse(atob(parts[1]));
                var currentTime = Math.floor(Date.now() / 1000);
                
                if (payload.exp && payload.exp < currentTime) {
                    throw new Error('Token expired');
                }
                
                // Token 有效，顯示設定頁面
                showSetupPage();
            } catch (error) {
                console.log('Token validation failed:', error);
                // Token 無效，清除並顯示登入頁面
                localStorage.removeItem('jwt');
                showLoginPage();
            }
        }

        function showUserInfoPage() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('user-info-page').classList.remove('hidden');
            document.getElementById('setup-page').classList.add('hidden');
            document.getElementById('chat-page').classList.add('hidden');
            
            // 載入用戶資訊
            loadUserInfo();
        }

        function showSetupPage() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('user-info-page').classList.add('hidden');
            document.getElementById('setup-page').classList.remove('hidden');
            document.getElementById('chat-page').classList.add('hidden');
        }

        function showChatPage() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('user-info-page').classList.add('hidden');
            document.getElementById('setup-page').classList.add('hidden');
            document.getElementById('chat-page').classList.remove('hidden');
            
            // 更新聊天頁面的語言
            switchLanguage(currentLanguage);
            
            loadQuickActions();
            // 載入聊天歷史
            loadChatHistory();
        }

        // 處理設定提交
        function handleSetupSubmit(e) {
            e.preventDefault();
            
            var formData = new FormData(e.target);
            var data = {};
            
            if (currentRole === 'student') {
                data = {
                    student_name: formData.get('student_name'),
                    student_email: formData.get('student_email'),
                    citizenship: formData.get('citizenship'),
                    gpa: parseFloat(formData.get('gpa')),
                    degree: formData.get('degree'),
                    countries: getCheckedCountries(),
                    budget: parseInt(formData.get('budget')),
                    target_intake: formData.get('target_intake'),
                    user_role: currentRole
                };
            } else {
                data = {
                    parent_name: formData.get('parent_name'),
                    parent_email: formData.get('parent_email'),
                    relationship: formData.get('relationship'),
                    child_name: formData.get('child_name'),
                    child_email: formData.get('child_email'),
                    gpa: parseFloat(formData.get('gpa')),
                    degree: formData.get('degree'),
                    countries: getCheckedCountries(),
                    budget: parseInt(formData.get('budget')),
                    target_intake: formData.get('target_intake'),
                    user_role: currentRole
                };
            }

            try {
                // 檢查是否有 JWT token
                var jwt = localStorage.getItem('jwt');
                if (!jwt) {
                    alert(currentLanguage === 'en' ? 'Please login first or skip login to continue.' : '請先登入或跳過登入繼續');
                    return;
                }
                
                var authHeader = { 'Authorization': 'Bearer ' + jwt };
                var headers = {
                    'Content-Type': 'application/json'
                };
                for (var key in authHeader) {
                    headers[key] = authHeader[key];
                }
                
                fetch(window.__CONFIG__.API_BASE + '/intake', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(data)
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    if (result.ok) {
                        profileId = result.data.profile_id;
                        localStorage.setItem('profileId', profileId);
                        showUserInfoPage();
                    } else {
                        alert('提交失敗：' + result.error);
                    }
                })
                .catch(function(error) {
                    console.error('Setup submission failed:', error);
                    alert('提交失敗，請檢查網路連接');
                });
            } catch (error) {
                console.error('Setup submission failed:', error);
                alert('提交失敗，請檢查網路連接');
            }
        }
        
        // 獲取選中的國家
        function getCheckedCountries() {
            var countries = [];
            var checkboxes = document.querySelectorAll('input[name="countries"]:checked');
            for (var i = 0; i < checkboxes.length; i++) {
                countries.push(checkboxes[i].value);
            }
            return countries;
        }

        // 發送消息
        function sendMessage() {
            var input = document.getElementById('message-input');
            var message = input.value.trim();
            var sendBtn = document.getElementById('send-btn');
            
            if (!message) return;

            // 禁用發送按鈕
            sendBtn.disabled = true;
            sendBtn.textContent = currentLanguage === 'en' ? 'Sending...' : '發送中...';

            // 添加用戶消息到聊天
            addMessage(message, 'user');
            input.value = '';

            // 顯示 AI 載入動畫
            showAILoading();

            try {
                var authHeader = {};
                var jwt = localStorage.getItem('jwt');
                if (jwt) {
                    authHeader['Authorization'] = 'Bearer ' + jwt;
                }
                
                var headers = {
                    'Content-Type': 'application/json'
                };
                for (var key in authHeader) {
                    headers[key] = authHeader[key];
                }
                
                fetch(window.__CONFIG__.API_BASE + '/chat', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        profile_id: profileId,
                        message: message,
                        user_role: currentRole,
                        language: currentLanguage
                    })
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    // 隱藏 AI 載入動畫
                    hideAILoading();
                    
                    if (result.ok) {
                        addMessage(result.reply || result.data.response, 'ai');
                    } else {
                        addMessage('抱歉，我無法處理您的請求。請稍後再試。', 'ai');
                    }
                })
                .catch(function(error) {
                    console.error('Chat failed:', error);
                    // 隱藏 AI 載入動畫
                    hideAILoading();
                    addMessage('抱歉，網路連接出現問題。請檢查您的網路連接。', 'ai');
                })
                .finally(function() {
                    // 重新啟用發送按鈕
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<span data-zh="送出" data-en="Send">送出</span>';
                });
            } catch (error) {
                console.error('Chat failed:', error);
                // 隱藏 AI 載入動畫
                hideAILoading();
                addMessage('抱歉，網路連接出現問題。請檢查您的網路連接。', 'ai');
                
                // 重新啟用發送按鈕
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<span data-zh="送出" data-en="Send">送出</span>';
            }
        }

        // 添加消息到聊天
        function addMessage(message, sender, shouldScroll = true) {
            var chatContainer = document.getElementById('chat-container');
            var messageWrapper = document.createElement('div');
            
            var currentTime = new Date().toLocaleTimeString('zh-TW', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            if (sender === 'user') {
                messageWrapper.className = 'flex justify-end mb-4';
                messageWrapper.innerHTML = 
                    '<div class="max-w-xs sm:max-w-sm md:max-w-md bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-800 rounded-lg p-4 shadow-sm">' +
                        '<div class="text-sm leading-relaxed">' + message + '</div>' +
                        '<div class="text-xs text-gray-600 mt-2">' + currentTime + '</div>' +
                    '</div>';
            } else {
                messageWrapper.className = 'mb-4';
                var aiTitle = currentLanguage === 'en' ? 'AI Study Abroad Advisor' : 'AI 留學顧問';
                var aiSubtitle = currentLanguage === 'en' ? 'Your Exclusive Study Abroad Planning Expert' : '您的專屬留學規劃專家';
                
                messageWrapper.innerHTML = 
                    '<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">' +
                        '<div class="flex items-center mb-4">' +
                            '<div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">AI</div>' +
                            '<div>' +
                                '<h3 class="font-semibold text-gray-800">' + aiTitle + '</h3>' +
                                '<p class="text-sm text-gray-500">' + aiSubtitle + '</p>' +
                            '</div>' +
                        '</div>' +
                        '<div class="text-gray-700 leading-relaxed message-content">' + message + '</div>' +
                        '<div class="text-xs text-gray-400 mt-3">' + currentTime + '</div>' +
                    '</div>';
            }
            
            chatContainer.appendChild(messageWrapper);
            
            if (shouldScroll) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            // 儲存到聊天歷史
            saveChatHistory(message, sender);
        }

        // 發送歡迎訊息
        function sendWelcomeMessage() {
            if (!profileId) return;
            
            // 檢查是否有聊天歷史
            var chatHistory = localStorage.getItem('chatHistory_' + profileId);
            if (chatHistory) {
                var messages = JSON.parse(chatHistory);
                if (messages.length > 0) {
                    // 有聊天歷史，不發送歡迎訊息
                    return;
                }
            }
            
            // 顯示 AI 載入動畫
            showAILoading();
            
            try {
                var authHeader = {};
                var jwt = localStorage.getItem('jwt');
                if (jwt) {
                    authHeader['Authorization'] = 'Bearer ' + jwt;
                }
                
                var headers = {
                    'Content-Type': 'application/json'
                };
                for (var key in authHeader) {
                    headers[key] = authHeader[key];
                }
                
                fetch(window.__CONFIG__.API_BASE + '/chat', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        profile_id: profileId,
                        message: '', // 空訊息觸發歡迎回覆
                        user_role: currentRole,
                        language: currentLanguage
                    })
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    // 隱藏 AI 載入動畫
                    hideAILoading();
                    
                    if (result.ok) {
                        addMessage(result.reply || result.data.response, 'ai');
                    } else {
                        console.error('Welcome message failed:', result);
                        // 如果 API 失敗，顯示預設歡迎訊息
                        var welcomeText = currentLanguage === 'en' ? 
                            '🎓 Hello! I am your AI Study Abroad Advisor.\n\nI have reviewed your basic information, now let\'s dive deep into your study abroad planning!\n\nYou can ask me any questions about studying abroad, such as:\n\n• School and major recommendations\n• Application timeline planning\n• Scholarship opportunities\n• Visa and accommodation guidance\n\nWhat would you like to know first?' :
                            '🎓 您好！我是您的AI留學顧問。\n\n我已經了解了您的基本資訊，現在讓我們深入討論您的留學計劃吧！\n\n您可以問我任何關於留學的問題，比如：\n\n• 推薦適合的學校和專業\n• 申請時間規劃\n• 獎學金申請建議\n• 簽證與住宿資訊\n\n您想先了解哪個部分呢？';
                        addMessage(welcomeText, 'ai');
                    }
                })
                .catch(function(error) {
                    console.error('Welcome message error:', error);
                    // 隱藏 AI 載入動畫
                    hideAILoading();
                    
                    // 如果 API 失敗，顯示預設歡迎訊息
                    var welcomeText = currentLanguage === 'en' ? 
                        '🎓 Hello! I am your AI Study Abroad Advisor.\n\nI have reviewed your basic information, now let\'s dive deep into your study abroad planning!\n\nYou can ask me any questions about studying abroad, such as:\n\n• School and major recommendations\n• Application timeline planning\n• Scholarship opportunities\n• Visa and accommodation guidance\n\nWhat would you like to know first?' :
                        '🎓 您好！我是您的AI留學顧問。\n\n我已經了解了您的基本資訊，現在讓我們深入討論您的留學計劃吧！\n\n您可以問我任何關於留學的問題，比如：\n\n• 推薦適合的學校和專業\n• 申請時間規劃\n• 獎學金申請建議\n• 簽證與住宿資訊\n\n您想先了解哪個部分呢？';
                    addMessage(welcomeText, 'ai');
                });
            } catch (error) {
                console.error('Welcome message error:', error);
                // 隱藏 AI 載入動畫
                hideAILoading();
            }
        }

        // 載入快速問答按鈕（依身份）
        function loadQuickActions() {
            var qa = document.getElementById('quick-actions');
            if (!qa) return;
            qa.innerHTML = '';
            
            var studentBtns = [
                { zh: '學校推薦', en: 'School Recommendations', q: '根據我的背景推薦適合的學校和科系', q_en: 'Recommend suitable schools and majors based on my background' },
                { zh: '申請規劃', en: 'Application Planning', q: '請幫我規劃完整的申請時間表和流程', q_en: 'Please help me plan a complete application timeline and process' },
                { zh: '獎學金申請', en: 'Scholarship Application', q: '有哪些適合我的獎學金可以申請？', q_en: 'What scholarships are suitable for me to apply for?' },
                { zh: '簽證指導', en: 'Visa Guidance', q: '學生簽證申請流程和注意事項', q_en: 'Student visa application process and important notes' },
                { zh: '住宿建議', en: 'Housing Advice', q: '海外住宿選擇和注意事項', q_en: 'Overseas accommodation options and considerations' },
                { zh: '語言準備', en: 'Language Preparation', q: '語言考試準備和成績要求', q_en: 'Language test preparation and score requirements' }
            ];
            var parentBtns = [
                { zh: '費用規劃', en: 'Cost Planning', q: '一年總費用預估與預算建議', q_en: 'Annual total cost estimation and budget recommendations' },
                { zh: '投資回報', en: 'ROI Analysis', q: '幫我估算不同方案的投資回收期', q_en: 'Help me estimate the ROI for different options' },
                { zh: '安全考量', en: 'Safety Considerations', q: '海外留學安全注意事項', q_en: 'Safety considerations for studying abroad' },
                { zh: '保險規劃', en: 'Insurance Planning', q: '留學保險選擇和規劃', q_en: 'Study abroad insurance options and planning' },
                { zh: '就業前景', en: 'Career Prospects', q: '畢業後就業前景和發展', q_en: 'Career prospects and development after graduation' },
                { zh: '文化適應', en: 'Cultural Adaptation', q: '如何幫助孩子適應海外文化', q_en: 'How to help children adapt to overseas culture' }
            ];
            
            var buttons = currentRole === 'parent' ? parentBtns : studentBtns;
            
            for (var i = 0; i < buttons.length; i++) {
                var btn = buttons[i];
                var label = currentLanguage === 'en' ? btn.en : btn.zh;
                var question = currentLanguage === 'en' ? btn.q_en : btn.q;
                
                var button = document.createElement('button');
                button.type = 'button';
                button.className = 'px-4 py-3 text-sm bg-white hover:bg-gray-50 rounded-lg border border-gray-200 shadow-sm transition-colors text-gray-700 font-medium';
                button.textContent = label;
                button.onclick = function(questionText) {
                    return function() {
                        document.getElementById('message-input').value = questionText;
                        sendMessage();
                    };
                }(question);
                qa.appendChild(button);
            }
        }
        
        // 智能登入流程檢查
        function checkUserProfileStatus() {
            try {
                var jwt = localStorage.getItem('jwt');
                if (!jwt) {
                    showLoginPage();
                    return;
                }
                
                fetch(window.__CONFIG__.API_BASE + '/user/check-profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + jwt,
                        'Content-Type': 'application/json'
                    }
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    if (result.ok && result.has_profile) {
                        // 有 profile 資料，顯示用戶資訊頁面
                        profileId = result.profile_id;
                        localStorage.setItem('profileId', profileId);
                        showUserInfoPage();
                    } else {
                        // 沒有 profile 資料，跳轉到設定頁面
                        showSetupPage();
                    }
                })
                .catch(function(error) {
                    console.error('檢查用戶狀態失敗:', error);
                    showLoginPage();
                });
            } catch (error) {
                console.error('檢查用戶狀態失敗:', error);
                showLoginPage();
            }
        }

        // 頁面載入時檢查登入狀態
        window.onload = function() {
            // 檢查本地儲存的 profileId
            var storedProfileId = localStorage.getItem('profileId');
            if (storedProfileId) {
                profileId = storedProfileId;
            }
            
            // 檢查 URL 參數中的 token
            var urlParams = new URLSearchParams(window.location.search);
            var token = urlParams.get('token');
            var error = urlParams.get('error');
            
            // 處理登入錯誤
            if (error) {
                var errorMessage = '';
                switch(error) {
                    case 'missing_code':
                        errorMessage = currentLanguage === 'en' ? 'Login failed: Missing authorization code' : '登入失敗：缺少授權碼';
                        break;
                    case 'token_exchange_failed':
                        errorMessage = currentLanguage === 'en' ? 'Login failed: Token exchange failed' : '登入失敗：令牌交換失敗';
                        break;
                    case 'user_info_failed':
                        errorMessage = currentLanguage === 'en' ? 'Login failed: Unable to get user information' : '登入失敗：無法獲取用戶資訊';
                        break;
                    case 'callback_failed':
                        errorMessage = currentLanguage === 'en' ? 'Login failed: Callback processing failed' : '登入失敗：回調處理失敗';
                        break;
                    default:
                        errorMessage = currentLanguage === 'en' ? 'Login failed: ' + error : '登入失敗：' + error;
                }
                alert(errorMessage);
                // 清除 URL 參數
                window.history.replaceState({}, document.title, window.location.pathname);
                showLoginPage();
                return;
            }
            
            if (token) {
                // 儲存 token 並檢查用戶狀態
                localStorage.setItem('jwt', token);
                
                // 儲存用戶資料到 localStorage
                var userInfo = urlParams.get('user');
                if (userInfo) {
                    try {
                        var user = JSON.parse(decodeURIComponent(userInfo));
                        localStorage.setItem('userProfile', JSON.stringify(user));
                    } catch (e) {
                        console.error('解析用戶資料失敗:', e);
                    }
                }
                
                // 智能檢查用戶狀態
                checkUserProfileStatus();
                
                // 清除 URL 參數
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                // 檢查本地儲存的 token
                var storedToken = localStorage.getItem('jwt');
                if (storedToken) {
                    // 驗證 token 是否有效並檢查用戶狀態
                    validateTokenAndCheckProfile(storedToken);
                } else {
                    showLoginPage();
                }
            }
        };

        // 驗證 token 並檢查用戶狀態
        function validateTokenAndCheckProfile(token) {
            try {
                var parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid token format');
                }
                
                // 檢查 token 是否過期（簡單檢查）
                var payload = JSON.parse(atob(parts[1]));
                var currentTime = Math.floor(Date.now() / 1000);
                
                if (payload.exp && payload.exp < currentTime) {
                    throw new Error('Token expired');
                }
                
                // Token 有效，檢查用戶狀態
                checkUserProfileStatus();
            } catch (error) {
                console.log('Token validation failed:', error);
                // Token 無效，清除並顯示登入頁面
                localStorage.removeItem('jwt');
                localStorage.removeItem('profileId');
                localStorage.removeItem('userProfile');
                showLoginPage();
            }
        }
    </script>
</body>
</html>
