<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 留學顧問</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // 內嵌配置
        window.__CONFIG__ = {
            API_BASE: 'https://aistudentbackend.zeabur.app/api/v1',
            // 暫時使用測試模式，跳過後端驗證
            TEST_MODE: true
        };
    </script>
    <style>
        /* 自定義樣式 */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .hidden { display: none; }
        .block { display: block; }
        
        .message-bubble {
            @apply max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg px-4 py-3 rounded-2xl relative shadow-sm;
            word-wrap: break-word;
        }
        
        .message-user {
            @apply bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-800 ml-auto;
            margin-left: auto;
            margin-right: 0;
        }
        
        .message-user::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: -8px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-left-color: #fbbf24;
            border-bottom: none;
            border-right: none;
        }
        
        .message-ai {
            @apply bg-white text-gray-800 mr-auto border border-gray-200;
            margin-left: 0;
            margin-right: auto;
        }
        
        .message-ai::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: -8px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-right-color: white;
            border-bottom: none;
            border-left: none;
        }
        
        .message-ai::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -9px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-right-color: #e5e7eb;
            border-bottom: none;
            border-left: none;
        }
        
        .message-time {
            @apply text-xs text-gray-500 mt-1;
        }
        
        .message-avatar {
            @apply w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white;
        }
        
        .avatar-ai {
            @apply bg-gradient-to-r from-blue-500 to-blue-600;
        }
        
        .avatar-user {
            @apply bg-gradient-to-r from-yellow-500 to-yellow-600;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">
    <!-- 登入頁面 -->
    <div id="login-page" class="min-h-screen flex flex-col items-center justify-center p-4 bg-gradient-to-br from-yellow-100 to-blue-100">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full text-center fade-in">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-4" data-zh="AI 留學顧問" data-en="AI Study Abroad Advisor">AI 留學顧問</h1>
            <p class="text-lg text-gray-600 mb-8" data-zh="您的個人化留學規劃專家" data-en="Your Personalized Study Abroad Planning Expert">您的個人化留學規劃專家</p>
            
            <div id="auth-section" class="mb-6">
                <div id="user-info" class="hidden mb-4">
                    <img id="user-avatar" class="w-16 h-16 rounded-full mx-auto mb-2" src="" alt="User Avatar">
                    <p class="text-xl font-semibold">歡迎，<span id="user-name"></span>!</p>
                    <button onclick="logout()" class="mt-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">登出</button>
                </div>
                <div id="login-buttons">
                    <p class="text-gray-700 mb-4" data-zh="請登入以繼續" data-en="Please login to continue">請登入以繼續</p>
                    <button onclick="skipLogin()" class="w-full flex items-center justify-center px-4 py-3 mb-3 bg-yellow-400 text-gray-800 rounded-lg hover:bg-yellow-500 transition-colors font-medium shadow-md">
                        <span data-zh="跳過登入，直接開始" data-en="Skip login, start directly">跳過登入，直接開始</span>
                    </button>
                    <button onclick="loginWithGoogle()" id="google-login-btn" class="w-full flex items-center justify-center px-4 py-3 mb-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium shadow-md">
                        <img src="https://img.icons8.com/color/24/000000/google-logo.png" alt="Google" class="w-5 h-5 mr-2">
                        <span data-zh="使用 Google 登入" data-en="Login with Google">使用 Google 登入</span>
                    </button>
                    <button onclick="loginWithLine()" class="w-full flex items-center justify-center px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium shadow-md">
                        <img src="https://img.icons8.com/color/24/000000/line-me.png" alt="LINE" class="w-5 h-5 mr-2">
                        <span data-zh="使用 LINE 登入" data-en="Login with LINE">使用 LINE 登入</span>
                    </button>
                </div>
            </div>


            <!-- 語言切換 -->
            <div class="mt-6 flex justify-center space-x-4">
                <button onclick="switchLanguage('zh')" id="lang-switch-zh" 
                        class="px-4 py-2 text-sm rounded-lg bg-blue-500 text-white transition-colors">
                    中文
                </button>
                <button onclick="switchLanguage('en')" id="lang-switch-en" 
                        class="px-4 py-2 text-sm rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">
                    English
                </button>
            </div>
        </div>
    </div>

    <!-- 設定頁面 -->
    <div id="setup-page" class="min-h-screen hidden">
        <div class="max-w-2xl mx-auto bg-white min-h-screen">
            <header class="bg-gradient-to-r from-yellow-400 to-yellow-300 text-gray-800 p-4 sm:p-6 relative">
                <button id="back-to-home" class="absolute left-2 sm:left-4 top-4 sm:top-6 text-gray-800 hover:text-gray-600 transition-colors text-sm sm:text-base z-10">
                    <span data-zh="← Back" data-en="← Back">← Back</span>
                </button>
                <div class="text-center px-12 sm:px-0">
                    <h1 class="text-base sm:text-xl lg:text-2xl font-bold mb-1 sm:mb-2 leading-tight" data-zh="設定您的留學需求" data-en="Set Your Study Abroad Requirements">設定您的留學需求</h1>
                    <p class="text-gray-600 text-xs sm:text-base leading-tight" data-zh="讓我們先了解您的基本資訊" data-en="Let us understand your basic information first">讓我們先了解您的基本資訊</p>
                </div>
            </header>

            <!-- Setup Form -->
            <main class="p-6">
                <form id="setup-form" class="space-y-6">
                    <!-- 個人基本資訊 -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">1</span>
                                <span data-zh="個人基本資訊" data-en="Personal Information">個人基本資訊</span>
                            </div>
                        </h3>
                        <div id="student-fields" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="學生姓名 *" data-en="Student Name *">學生姓名 *</label>
                                <input type="text" id="student_name" name="student_name" required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    data-zh-ph="例如：王小明" data-en-ph="e.g., David Wang" placeholder="例如：王小明">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="學生電子郵件 *" data-en="Student Email *">學生電子郵件 *</label>
                                <input type="email" id="student_email" name="student_email" required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    data-zh-ph="例如：david@example.com" data-en-ph="e.g., david@example.com" placeholder="例如：david@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="國籍 *" data-en="Citizenship *">國籍 *</label>
                                <input type="text" id="citizenship" name="citizenship" required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    data-zh-ph="例如：台灣" data-en-ph="e.g., Taiwan" placeholder="例如：台灣">
                            </div>
                        </div>
                        <div id="parent-fields" class="space-y-4 hidden">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="家長姓名 *" data-en="Parent Name *">家長姓名 *</label>
                                <input type="text" id="parent_name" name="parent_name"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    data-zh-ph="例如：王媽媽" data-en-ph="e.g., Alice Wang" placeholder="例如：王媽媽">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="家長電子郵件 *" data-en="Parent Email *">家長電子郵件 *</label>
                                <input type="email" id="parent_email" name="parent_email"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    data-zh-ph="例如：parent@example.com" data-en-ph="e.g., parent@example.com" placeholder="例如：parent@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="與學生關係 *" data-en="Relationship to Student *">與學生關係 *</label>
                                <input type="text" id="relationship" name="relationship"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    data-zh-ph="例如：母親 / 父親" data-en-ph="e.g., Mother / Father" placeholder="例如：母親">
                            </div>
                            <div class="border-t pt-4">
                                <p class="text-sm text-gray-500 mb-2" data-zh="學生聯絡資料" data-en="Student Contact">學生聯絡資料</p>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="學生姓名 *" data-en="Student Name *">學生姓名 *</label>
                                <input type="text" id="child_name" name="child_name"
                                    class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    data-zh-ph="例如：王小明" data-en-ph="e.g., David Wang" placeholder="例如：王小明">
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="學生電子郵件 *" data-en="Student Email *">學生電子郵件 *</label>
                                <input type="email" id="child_email" name="child_email"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    data-zh-ph="例如：david@example.com" data-en-ph="e.g., david@example.com" placeholder="例如：david@example.com">
                            </div>
                        </div>
                    </div>

                    <!-- 學術背景 -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">2</span>
                                <span data-zh="學術背景" data-en="Academic Background">學術背景</span>
                            </div>
                        </h3>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="GPA (滿分4.0) *" data-en="GPA (out of 4.0) *">GPA (滿分4.0) *</label>
                            <input type="number" id="gpa" name="gpa" step="0.1" min="0" max="4" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                data-zh-ph="例如：3.8" data-en-ph="e.g., 3.8" placeholder="例如：3.8">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="目標學位 *" data-en="Target Degree *">目標學位 *</label>
                            <select id="degree" name="degree" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                <option value="" data-zh="請選擇" data-en="Please select">請選擇</option>
                                <option value="bachelor" data-zh="學士" data-en="Bachelor's">學士</option>
                                <option value="master" data-zh="碩士" data-en="Master's">碩士</option>
                                <option value="phd" data-zh="博士" data-en="PhD">博士</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="目標國家 *" data-en="Target Countries *">目標國家 *</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center">
                                    <input type="checkbox" name="countries" value="us" class="mr-2">
                                    <span data-zh="美國" data-en="USA">美國</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="countries" value="uk" class="mr-2">
                                    <span data-zh="英國" data-en="UK">英國</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="countries" value="ca" class="mr-2">
                                    <span data-zh="加拿大" data-en="Canada">加拿大</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 預算和時間 -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">3</span>
                                <span data-zh="預算和時間" data-en="Budget and Time">預算和時間</span>
                            </div>
                        </h3>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="預算 (每年學費+生活費，單位：美元) *" data-en="Budget (Annual tuition + living expenses, USD) *">預算 (每年學費+生活費，單位：美元) *</label>
                            <input type="number" id="budget" name="budget" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                data-zh-ph="例如：50000" data-en-ph="e.g., 50000" placeholder="例如：50000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="目標入學時間 *" data-en="Target Intake Time *">目標入學時間 *</label>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                <select id="intake_semester" name="intake_semester" required 
                                    class="w-full sm:w-1/3 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                    <option value="" data-zh="選擇學期" data-en="Select Semester">選擇學期</option>
                                    <option value="fall" data-zh="秋季" data-en="Fall">秋季</option>
                                    <option value="spring" data-zh="春季" data-en="Spring">春季</option>
                                    <option value="summer" data-zh="夏季" data-en="Summer">夏季</option>
                                    <option value="winter" data-zh="冬季" data-en="Winter">冬季</option>
                                </select>
                                <select id="intake_year" name="intake_year" required 
                                    class="w-full sm:w-2/3 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                    <option value="" data-zh="選擇年份" data-en="Select Year">選擇年份</option>
                                </select>
                            </div>
                            <input type="hidden" id="target_intake" name="target_intake">
                        </div>
                    </div>

                    <!-- 角色選擇 -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">4</span>
                                <span data-zh="選擇您的身份" data-en="Choose Your Role">選擇您的身份</span>
                            </div>
                        </h3>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                            <button type="button" onclick="selectRole('student')" id="role-student" 
                                    class="flex-1 px-4 sm:px-6 py-3 bg-blue-500 text-white rounded-lg font-medium transition-colors text-sm sm:text-base">
                                <span data-zh="👨‍🎓 我是學生" data-en="👨‍🎓 I am a Student">👨‍🎓 我是學生</span>
                            </button>
                            <button type="button" onclick="selectRole('parent')" id="role-parent" 
                                    class="flex-1 px-4 sm:px-6 py-3 bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors hover:bg-gray-400 text-sm sm:text-base">
                                <span data-zh="👨‍👩‍👧‍👦 我是家長" data-en="👨‍👩‍👧‍👦 I am a Parent">👨‍👩‍👧‍👦 我是家長</span>
                            </button>
                        </div>
                    </div>

                    <button type="submit" 
                            class="w-full bg-yellow-400 text-gray-800 py-3 px-6 rounded-lg font-medium hover:bg-yellow-500 transition-colors duration-200 text-lg shadow-lg"
                            data-zh="開始與AI顧問對話" data-en="Start Chat with AI Advisor">
                        開始與AI顧問對話
                    </button>
                </form>
            </main>
        </div>
    </div>

    <!-- 聊天頁面 -->
    <div id="chat-page" class="min-h-screen hidden">
        <div class="max-w-4xl mx-auto bg-white min-h-screen flex flex-col">
            <header class="bg-gradient-to-r from-yellow-400 to-yellow-300 text-gray-800 p-4 text-center relative">
                <button id="back-to-setup" class="absolute left-4 top-4 text-gray-800 hover:text-gray-600 transition-colors">
                    ← 重新設定
                </button>
                <h1 class="text-xl font-bold">AI 留學顧問</h1>
                <p class="text-sm">正在為您提供專業建議</p>
                <div class="flex items-center justify-center mt-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                    <span class="text-sm">在線</span>
                </div>
            </header>

            <main class="flex-1 p-4 overflow-y-auto bg-gray-50" id="chat-container">
                <div class="space-y-4">
                    <div class="flex items-start space-x-3">
                        <div class="message-avatar avatar-ai">AI</div>
                        <div class="message-bubble message-ai">
                            <p>您好！我是您的AI留學顧問。我已經了解了您的基本資訊，現在讓我們深入討論您的留學計劃吧！</p>
                            <p class="mt-2">您可以問我任何關於留學的問題，比如：</p>
                            <ul class="mt-2 list-disc list-inside text-sm">
                                <li>推薦適合的學校和專業</li>
                                <li>申請流程和時間規劃</li>
                                <li>獎學金申請建議</li>
                                <li>簽證和住宿資訊</li>
                            </ul>
                            <div class="message-time">剛剛</div>
                        </div>
                    </div>
                </div>
            </main>

            <footer class="p-3 sm:p-4 border-t border-gray-200">
                <div id="quick-actions" class="flex flex-wrap gap-2 mb-3"></div>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <input type="text" id="message-input" 
                           class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-sm sm:text-base"
                           placeholder="請輸入您的問題...">
                    <button id="send-btn" 
                            class="px-4 sm:px-6 py-3 bg-yellow-400 text-gray-800 rounded-lg font-medium hover:bg-yellow-500 transition-colors text-sm sm:text-base"
                            data-zh="發送" data-en="Send">發送</button>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center" data-zh="按 Enter 發送" data-en="Press Enter to send">按 Enter 發送</p>
            </footer>
        </div>
    </div>

    <script>
        // 全局變量
        let currentRole = 'student';
        let currentLanguage = 'zh';
        let profileId = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 取得 Google Client ID 以初始化 GIS
            fetch(`${window.__CONFIG__.API_BASE}/auth/config`)
                .then(r => r.json())
                .then(cfg => {
                    if (cfg && cfg.ok && cfg.googleClientId) {
                        window.__GOOGLE_CLIENT_ID__ = cfg.googleClientId;
                    }
                })
                .catch(() => {});
            // 檢查登入狀態
            checkAuthStatus();
            
            // 初始化年份選項
            initializeYearOptions();
            
            // 綁定事件
            document.getElementById('back-to-home').addEventListener('click', showLoginPage);
            document.getElementById('back-to-setup').addEventListener('click', showSetupPage);
            document.getElementById('setup-form').addEventListener('submit', handleSetupSubmit);
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // 綁定日期選擇事件
            document.getElementById('intake_semester').addEventListener('change', updateTargetIntake);
            document.getElementById('intake_year').addEventListener('change', updateTargetIntake);
        });

        // 檢查認證狀態
        async function checkAuthStatus() {
            try {
                const response = await fetch(`${window.__CONFIG__.API_BASE}/auth/status`);
                const data = await response.json();
                
                if (data.ok && data.user) {
                    showUserInfo(data.user);
                } else {
                    showLoginButtons();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                showLoginButtons();
            }
        }

        // 顯示用戶資訊
        function showUserInfo(user) {
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('login-buttons').classList.add('hidden');
            document.getElementById('user-name').textContent = user.name;
            if (user.avatar) {
                document.getElementById('user-avatar').src = user.avatar;
            }
        }

        // 顯示登入按鈕
        function showLoginButtons() {
            document.getElementById('user-info').classList.add('hidden');
            document.getElementById('login-buttons').classList.remove('hidden');
        }

        // 登入功能
        function loginWithGoogle() {
            if (!window.__GOOGLE_CLIENT_ID__) {
                alert(currentLanguage === 'en' ? 'Google login is not ready.' : 'Google 登入尚未就緒');
                return;
            }
            const client = google.accounts.oauth2.initTokenClient({
                client_id: window.__GOOGLE_CLIENT_ID__,
                scope: 'openid email profile',
                callback: async (response) => {
                    try {
                        const idToken = response.access_token ? undefined : undefined; // token client 不給 id_token
                    } catch (e) {}
                }
            });
            // 改用 one-tap 的 ID token API
            google.accounts.id.initialize({
                client_id: window.__GOOGLE_CLIENT_ID__,
                callback: async (resp) => {
                    try {
                        const idToken = resp.credential;
                        const r = await fetch(`${window.__CONFIG__.API_BASE}/auth/google/verify`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ idToken })
                        });
                        const data = await r.json();
                        if (data.ok && data.token) {
                            localStorage.setItem('jwt', data.token);
                            showUserInfo(data.user || { name: 'User' });
                            showSetupPage();
                        } else {
                            alert(currentLanguage === 'en' ? 'Login failed.' : '登入失敗');
                        }
                    } catch (err) {
                        alert(currentLanguage === 'en' ? 'Login failed.' : '登入失敗');
                    }
                }
            });
            google.accounts.id.prompt();
        }

        function loginWithLine() {
            alert(currentLanguage === 'en' ? 'Login is temporarily unavailable. Please click "Skip login, start directly".' : '登入功能暫時不可用，請點「跳過登入，直接開始」');
        }

        function logout() {
            window.location.href = `${window.__CONFIG__.API_BASE.replace('/api/v1', '')}/auth/logout`;
        }

        // 跳過登入
        function skipLogin() {
            // 創建一個假的 JWT token 用於測試
            const fakeToken = 'fake-jwt-token-for-testing';
            localStorage.setItem('jwt', fakeToken);
            showSetupPage();
        }

        // 初始化年份選項
        function initializeYearOptions() {
            const yearSelect = document.getElementById('intake_year');
            const currentYear = new Date().getFullYear();
            
            // 生成未來 5 年的選項
            for (let i = 0; i < 5; i++) {
                const year = currentYear + i;
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                option.setAttribute('data-zh', year);
                option.setAttribute('data-en', year);
                yearSelect.appendChild(option);
            }
        }

        // 更新目標入學時間
        function updateTargetIntake() {
            const semester = document.getElementById('intake_semester').value;
            const year = document.getElementById('intake_year').value;
            const targetIntakeInput = document.getElementById('target_intake');
            
            if (semester && year) {
                const semesterText = currentLanguage === 'en' 
                    ? semester.charAt(0).toUpperCase() + semester.slice(1)
                    : semester === 'fall' ? '秋季' : semester === 'spring' ? '春季' : semester === 'summer' ? '夏季' : '冬季';
                
                const intakeText = currentLanguage === 'en' 
                    ? `${semesterText} ${year}`
                    : `${year}年${semesterText}`;
                
                targetIntakeInput.value = intakeText;
            } else {
                targetIntakeInput.value = '';
            }
        }

        // 語言切換
        function switchLanguage(lang) {
            currentLanguage = lang;
            // 更新所有具備 data-zh / data-en 的元素
            const elements = document.querySelectorAll('[data-zh]');
            elements.forEach(el => {
                const text = el.getAttribute(`data-${currentLanguage}`);
                if (text) el.textContent = text;
            });
            // 更新 placeholder
            const inputs = document.querySelectorAll('[data-zh-ph]');
            inputs.forEach(input => {
                const placeholder = input.getAttribute(`data-${currentLanguage}-ph`);
                if (placeholder) input.placeholder = placeholder;
            });
            // 更新 select 選項
            const options = document.querySelectorAll('option[data-zh]');
            options.forEach(option => {
                const text = option.getAttribute(`data-${currentLanguage}`);
                if (text) option.textContent = text;
            });
            
            // 更新目標入學時間顯示
            updateTargetIntake();
            // 更新語言切換按鈕樣式
            document.getElementById('lang-switch-zh').classList.toggle('bg-blue-500', lang === 'zh');
            document.getElementById('lang-switch-zh').classList.toggle('bg-gray-200', lang !== 'zh');
            document.getElementById('lang-switch-zh').classList.toggle('text-white', lang === 'zh');
            document.getElementById('lang-switch-zh').classList.toggle('text-gray-700', lang !== 'zh');
            document.getElementById('lang-switch-en').classList.toggle('bg-blue-500', lang === 'en');
            document.getElementById('lang-switch-en').classList.toggle('bg-gray-200', lang !== 'en');
            document.getElementById('lang-switch-en').classList.toggle('text-white', lang === 'en');
            document.getElementById('lang-switch-en').classList.toggle('text-gray-700', lang !== 'en');
        }

        // 角色選擇
        function selectRole(role) {
            currentRole = role;
            document.getElementById('role-student').classList.toggle('bg-blue-500', role === 'student');
            document.getElementById('role-student').classList.toggle('bg-gray-300', role !== 'student');
            document.getElementById('role-parent').classList.toggle('bg-blue-500', role === 'parent');
            document.getElementById('role-parent').classList.toggle('bg-gray-300', role !== 'parent');

            // 切換欄位顯示
            document.getElementById('student-fields').classList.toggle('hidden', role !== 'student');
            document.getElementById('parent-fields').classList.toggle('hidden', role !== 'parent');
            loadQuickActions();
        }

        // 頁面切換
        function showLoginPage() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('setup-page').classList.add('hidden');
            document.getElementById('chat-page').classList.add('hidden');
        }

        function showSetupPage() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('setup-page').classList.remove('hidden');
            document.getElementById('chat-page').classList.add('hidden');
        }

        function showChatPage() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('setup-page').classList.add('hidden');
            document.getElementById('chat-page').classList.remove('hidden');
            loadQuickActions();
            // 自動發送打招呼訊息
            sendWelcomeMessage();
        }

        // 處理設定提交
        async function handleSetupSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            let data = {};
            
            if (currentRole === 'student') {
                data = {
                    student_name: formData.get('student_name'),
                    student_email: formData.get('student_email'),
                    citizenship: formData.get('citizenship'),
                    gpa: parseFloat(formData.get('gpa')),
                    degree: formData.get('degree'),
                    countries: Array.from(document.querySelectorAll('input[name="countries"]:checked')).map(cb => cb.value),
                    budget: parseInt(formData.get('budget')),
                    target_intake: formData.get('target_intake'),
                    user_role: currentRole
                };
            } else {
                data = {
                    parent_name: formData.get('parent_name'),
                    parent_email: formData.get('parent_email'),
                    relationship: formData.get('relationship'),
                    child_name: formData.get('child_name'),
                    child_email: formData.get('child_email'),
                    gpa: parseFloat(formData.get('gpa')),
                    degree: formData.get('degree'),
                    countries: Array.from(document.querySelectorAll('input[name="countries"]:checked')).map(cb => cb.value),
                    budget: parseInt(formData.get('budget')),
                    target_intake: formData.get('target_intake'),
                    user_role: currentRole
                };
            }

            try {
                // 檢查是否有 JWT token
                const jwt = localStorage.getItem('jwt');
                if (!jwt) {
                    alert(currentLanguage === 'en' ? 'Please login first or skip login to continue.' : '請先登入或跳過登入繼續');
                    return;
                }
                
                const authHeader = { 'Authorization': `Bearer ${jwt}` };
                const response = await fetch(`${window.__CONFIG__.API_BASE}/intake`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeader
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.ok) {
                    profileId = result.data.profile_id;
                    showChatPage();
                } else {
                    alert('提交失敗：' + result.error);
                }
            } catch (error) {
                console.error('Setup submission failed:', error);
                alert('提交失敗，請檢查網路連接');
            }
        }

        // 發送消息
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;

            // 添加用戶消息到聊天
            addMessage(message, 'user');
            input.value = '';

            try {
                const authHeader = localStorage.getItem('jwt') ? { 'Authorization': `Bearer ${localStorage.getItem('jwt')}` } : {};
                const response = await fetch(`${window.__CONFIG__.API_BASE}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeader
                    },
                    body: JSON.stringify({
                        profile_id: profileId,
                        message: message,
                        user_role: currentRole,
                        language: currentLanguage
                    })
                });

                const result = await response.json();
                
                if (result.ok) {
                    addMessage(result.data.response, 'ai');
                } else {
                    addMessage('抱歉，我無法處理您的請求。請稍後再試。', 'ai');
                }
            } catch (error) {
                console.error('Chat failed:', error);
                addMessage('抱歉，網路連接出現問題。請檢查您的網路連接。', 'ai');
            }
        }

        // 添加消息到聊天
        function addMessage(message, sender) {
            const chatContainer = document.getElementById('chat-container');
            const messageWrapper = document.createElement('div');
            
            const currentTime = new Date().toLocaleTimeString('zh-TW', { 
                hour: '2-digit', 
