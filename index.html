<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI ç•™å­¸é¡§å•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // å…§åµŒé…ç½®
        window.__CONFIG__ = {
            API_BASE: 'https://aistudentbackend.zeabur.app/api/v1',
            // æš«æ™‚ä½¿ç”¨æ¸¬è©¦æ¨¡å¼ï¼Œè·³éå¾Œç«¯é©—è­‰
            TEST_MODE: true
        };
        
        // Google OAuth é…ç½®
        window.__GOOGLE_CLIENT_ID__ = '300123710303-m4j1laa65p664n5vtrdkfvfa7b42c2o6.apps.googleusercontent.com';
    </script>
    <style>
        /* è‡ªå®šç¾©æ¨£å¼ */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        /* æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
        @media (max-width: 768px) {
            .mobile-optimized {
                font-size: 16px !important; /* é˜²æ­¢ iOS è‡ªå‹•ç¸®æ”¾ */
                -webkit-text-size-adjust: 100%;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            
            .mobile-button {
                min-height: 44px !important; /* iOS å»ºè­°çš„æœ€å°è§¸æ§å€åŸŸ */
                padding: 12px 16px !important;
                font-size: 16px !important;
            }
            
            .mobile-input {
                font-size: 16px !important; /* é˜²æ­¢ iOS è‡ªå‹•ç¸®æ”¾ */
                padding: 12px 16px !important;
                min-height: 44px !important;
            }
            
            .mobile-text {
                font-size: 16px !important;
                line-height: 1.5 !important;
            }
            
            /* é˜²æ­¢é›™æ“Šç¸®æ”¾ */
            * {
                touch-action: manipulation;
            }
            
            /* å„ªåŒ–èŠå¤©ä»‹é¢ */
            .chat-container {
                height: calc(100vh - 120px) !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            .message-bubble {
                max-width: 85% !important;
                word-wrap: break-word !important;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .hidden { display: none; }
        .block { display: block; }
        
        .message-bubble {
            @apply max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg px-4 py-3 rounded-2xl relative shadow-sm;
            word-wrap: break-word;
        }
        
        .message-user {
            @apply bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-800 ml-auto;
            margin-left: auto;
            margin-right: 0;
        }
        
        .message-user::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: -8px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-left-color: #fbbf24;
            border-bottom: none;
            border-right: none;
        }
        
        .message-ai {
            @apply bg-white text-gray-800 mr-auto border border-gray-200;
            margin-left: 0;
            margin-right: auto;
        }
        
        .message-ai::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: -8px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-right-color: white;
            border-bottom: none;
            border-left: none;
        }
        
        .message-ai::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -9px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-right-color: #e5e7eb;
            border-bottom: none;
            border-left: none;
        }
        
        .message-time {
            @apply text-xs text-gray-500 mt-1;
        }
        
        .message-avatar {
            @apply w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white;
        }
        
        .avatar-ai {
            @apply bg-gradient-to-r from-blue-500 to-blue-600;
        }
        
        .avatar-user {
            @apply bg-gradient-to-r from-yellow-500 to-yellow-600;
        }
        
        /* AI è¼‰å…¥å‹•ç•« */
        .ai-loading-message {
            @apply mb-4 flex items-center space-x-3 p-4 bg-white rounded-lg shadow-sm border border-gray-200;
        }
        
        .ai-loading-spinner {
            @apply w-6 h-6 border-2 border-blue-200 border-t-blue-500 rounded-full animate-spin;
        }
        
        @keyframes ai-loading-bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translate3d(0, 0, 0);
            }
            40%, 43% {
                transform: translate3d(0, -8px, 0);
            }
            70% {
                transform: translate3d(0, -4px, 0);
            }
            90% {
                transform: translate3d(0, -2px, 0);
            }
        }
        
        .ai-loading-bounce {
            animation: ai-loading-bounce 2s infinite;
        }
        
        /* è¨Šæ¯æ°£æ³¡æ¨£å¼ */
        .message-content {
            white-space: pre-line;
            word-wrap: break-word;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">
    <!-- ç™»å…¥é é¢ -->
    <div id="login-page" class="min-h-screen flex flex-col items-center justify-center p-4 bg-gradient-to-br from-yellow-100 to-blue-100">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full text-center fade-in">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-4" data-zh="AI ç•™å­¸é¡§å•" data-en="AI Study Abroad Advisor">AI ç•™å­¸é¡§å•</h1>
            <p class="text-lg text-gray-600 mb-8" data-zh="æ‚¨çš„å€‹äººåŒ–ç•™å­¸è¦åŠƒå°ˆå®¶" data-en="Your Personalized Study Abroad Planning Expert">æ‚¨çš„å€‹äººåŒ–ç•™å­¸è¦åŠƒå°ˆå®¶</p>
            
            <div id="auth-section" class="mb-6">
                <div id="user-info" class="hidden mb-4">
                    <img id="user-avatar" class="w-16 h-16 rounded-full mx-auto mb-2" src="" alt="User Avatar">
                    <p class="text-xl font-semibold">æ­¡è¿ï¼Œ<span id="user-name"></span>!</p>
                    <button onclick="logout()" class="mt-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">ç™»å‡º</button>
                </div>
                <div id="login-buttons">
                    <p class="text-gray-700 mb-4" data-zh="è«‹ç™»å…¥ä»¥ç¹¼çºŒ" data-en="Please login to continue">è«‹ç™»å…¥ä»¥ç¹¼çºŒ</p>
                    <button onclick="skipLogin()" class="w-full flex items-center justify-center px-4 py-3 mb-3 bg-yellow-400 text-gray-800 rounded-lg hover:bg-yellow-500 transition-colors font-medium shadow-md mobile-button mobile-optimized">
                        <span data-zh="è·³éç™»å…¥ï¼Œç›´æ¥é–‹å§‹" data-en="Skip login, start directly">è·³éç™»å…¥ï¼Œç›´æ¥é–‹å§‹</span>
                    </button>
                    <button onclick="loginWithGoogle()" id="google-login-btn" class="w-full flex items-center justify-center px-4 py-3 mb-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium shadow-md mobile-button mobile-optimized">
                        <img src="https://img.icons8.com/color/24/000000/google-logo.png" alt="Google" class="w-5 h-5 mr-2">
                        <span data-zh="ä½¿ç”¨ Google ç™»å…¥" data-en="Login with Google">ä½¿ç”¨ Google ç™»å…¥</span>
                    </button>
                    <button onclick="showLineUnavailable()" class="w-full flex items-center justify-center px-4 py-3 bg-gray-400 text-white rounded-lg transition-colors font-medium shadow-md mobile-button mobile-optimized" disabled>
                        <img src="https://img.icons8.com/color/24/000000/line-me.png" alt="LINE" class="w-5 h-5 mr-2">
                        <span data-zh="LINE ç™»å…¥ (é–‹ç™¼ä¸­)" data-en="LINE Login (In Development)">LINE ç™»å…¥ (é–‹ç™¼ä¸­)</span>
                    </button>
                    <div class="text-xs text-gray-500 mt-2 text-center" data-zh="LINE ç™»å…¥åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œè«‹å…ˆä½¿ç”¨ Google ç™»å…¥æˆ–è·³éç™»å…¥" data-en="LINE login is under development, please use Google login or skip login">LINE ç™»å…¥åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œè«‹å…ˆä½¿ç”¨ Google ç™»å…¥æˆ–è·³éç™»å…¥</div>
                </div>
            </div>


            <!-- èªè¨€åˆ‡æ› -->
            <div class="mt-6 flex justify-center space-x-4">
                <button onclick="switchLanguage('zh')" id="lang-switch-zh" 
                        class="px-4 py-2 text-sm rounded-lg bg-blue-500 text-white transition-colors">
                    ä¸­æ–‡
                </button>
                <button onclick="switchLanguage('en')" id="lang-switch-en" 
                        class="px-4 py-2 text-sm rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">
                    English
                </button>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ¶è³‡è¨Šé é¢ï¼ˆç™»å…¥å¾Œçš„æ­¡è¿é é¢ï¼‰ -->
    <div id="user-info-page" class="min-h-screen hidden">
        <div class="max-w-2xl mx-auto bg-white min-h-screen">
            <header class="bg-gradient-to-r from-yellow-400 to-yellow-300 text-gray-800 p-4 sm:p-6 relative">
                <button onclick="logout()" class="absolute right-2 sm:right-4 top-4 sm:top-6 text-gray-800 hover:text-gray-600 transition-colors text-sm sm:text-base">
                    <span data-zh="ç™»å‡º" data-en="Logout">ç™»å‡º</span>
                </button>
                <div class="text-center px-12 sm:px-0">
                    <h1 class="text-base sm:text-xl lg:text-2xl font-bold mb-1 sm:mb-2 leading-tight" data-zh="æ­¡è¿å›ä¾†ï¼" data-en="Welcome Back!">æ­¡è¿å›ä¾†ï¼</h1>
                    <p class="text-gray-600 text-xs sm:text-base leading-tight" data-zh="ç¹¼çºŒæ‚¨çš„ç•™å­¸è¦åŠƒä¹‹æ—…" data-en="Continue your study abroad planning journey">ç¹¼çºŒæ‚¨çš„ç•™å­¸è¦åŠƒä¹‹æ—…</p>
                </div>
            </header>

            <main class="p-6">
                <!-- ç”¨æˆ¶è³‡è¨Šå¡ç‰‡ -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border border-blue-100 mb-6">
                    <div class="flex items-center mb-4">
                        <img id="user-info-avatar" class="w-16 h-16 rounded-full mr-4" src="" alt="User Avatar">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800" id="user-info-name">ç”¨æˆ¶åç¨±</h2>
                            <p class="text-gray-600" id="user-info-role">å­¸ç”Ÿ</p>
                        </div>
                    </div>
                    <p class="text-gray-700" data-zh="æ‚¨çš„ç•™å­¸è¦åŠƒè³‡æ–™å·²æº–å‚™å°±ç·’ï¼Œè®“æˆ‘å€‘é–‹å§‹è«®è©¢å§ï¼" data-en="Your study abroad planning data is ready, let's start consulting!">æ‚¨çš„ç•™å­¸è¦åŠƒè³‡æ–™å·²æº–å‚™å°±ç·’ï¼Œè®“æˆ‘å€‘é–‹å§‹è«®è©¢å§ï¼</p>
                </div>

                <!-- ä¸»è¦æ“ä½œæŒ‰éˆ• -->
                <div class="space-y-4">
                    <button onclick="continueToChat()" class="w-full bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-800 py-4 px-6 rounded-xl font-semibold hover:from-yellow-500 hover:to-yellow-600 transition-all duration-200 text-lg shadow-lg flex items-center justify-center">
                        <span class="mr-2">ğŸ’¬</span>
                        <span data-zh="ç¹¼çºŒè·ŸAIç•™å­¸é¡§å•è«®è©¢" data-en="Continue Consulting with AI Study Abroad Advisor">ç¹¼çºŒè·ŸAIç•™å­¸é¡§å•è«®è©¢</span>
                    </button>
                    
                    <button onclick="openUserSettings()" class="w-full bg-white text-gray-700 py-3 px-6 rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors font-medium flex items-center justify-center">
                        <span class="mr-2">âš™ï¸</span>
                        <span data-zh="ç·¨è¼¯è¨­å®šè³‡æ–™" data-en="Edit Settings">ç·¨è¼¯è¨­å®šè³‡æ–™</span>
                    </button>
                </div>

                <!-- å®¶é•·å°ˆç”¨åŠŸèƒ½ -->
                <div id="parent-only-section" class="mt-6 hidden">
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-lg border border-green-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3" data-zh="å®¶é•·å°ˆç”¨åŠŸèƒ½" data-en="Parent-Only Features">å®¶é•·å°ˆç”¨åŠŸèƒ½</h3>
                        <button onclick="queryStudentProgress()" class="w-full bg-green-500 text-white py-3 px-4 rounded-lg hover:bg-green-600 transition-colors font-medium">
                            <span class="mr-2">ğŸ“Š</span>
                            <span data-zh="æŸ¥è©¢å­¸ç”Ÿé€²åº¦" data-en="Query Student Progress">æŸ¥è©¢å­¸ç”Ÿé€²åº¦</span>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- è¨­å®šé é¢ -->
    <div id="setup-page" class="min-h-screen hidden">
        <div class="max-w-2xl mx-auto bg-white min-h-screen">
            <header class="bg-gradient-to-r from-yellow-400 to-yellow-300 text-gray-800 p-4 sm:p-6 relative">
                <button id="back-to-home" class="absolute left-2 sm:left-4 top-4 sm:top-6 text-gray-800 hover:text-gray-600 transition-colors text-sm sm:text-base z-10">
                    <span data-zh="â† Back" data-en="â† Back">â† Back</span>
                </button>
                <div class="text-center px-12 sm:px-0">
                    <h1 class="text-base sm:text-xl lg:text-2xl font-bold mb-1 sm:mb-2 leading-tight" data-zh="è¨­å®šæ‚¨çš„ç•™å­¸éœ€æ±‚" data-en="Set Your Study Abroad Requirements">è¨­å®šæ‚¨çš„ç•™å­¸éœ€æ±‚</h1>
                    <p class="text-gray-600 text-xs sm:text-base leading-tight" data-zh="è®“æˆ‘å€‘å…ˆäº†è§£æ‚¨çš„åŸºæœ¬è³‡è¨Š" data-en="Let us understand your basic information first">è®“æˆ‘å€‘å…ˆäº†è§£æ‚¨çš„åŸºæœ¬è³‡è¨Š</p>
                </div>
            </header>

            <!-- Setup Form -->
            <main class="p-6">
                <form id="setup-form" class="space-y-6">
                    <!-- å€‹äººåŸºæœ¬è³‡è¨Š -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">1</span>
                                <span data-zh="å€‹äººåŸºæœ¬è³‡è¨Š" data-en="Personal Information">å€‹äººåŸºæœ¬è³‡è¨Š</span>
                            </div>
                        </h3>
                        <div id="student-fields" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å­¸ç”Ÿå§“å *" data-en="Student Name *">å­¸ç”Ÿå§“å *</label>
                                <input type="text" id="student_name" name="student_name" required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="ä¾‹å¦‚ï¼šç‹å°æ˜" data-en-ph="e.g., David Wang" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å­¸ç”Ÿé›»å­éƒµä»¶ *" data-en="Student Email *">å­¸ç”Ÿé›»å­éƒµä»¶ *</label>
                                <input type="email" id="student_email" name="student_email" required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="ä¾‹å¦‚ï¼šdavid@example.com" data-en-ph="e.g., david@example.com" placeholder="ä¾‹å¦‚ï¼šdavid@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="åœ‹ç± *" data-en="Citizenship *">åœ‹ç± *</label>
                                <input type="text" id="citizenship" name="citizenship" required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="ä¾‹å¦‚ï¼šå°ç£" data-en-ph="e.g., Taiwan" placeholder="ä¾‹å¦‚ï¼šå°ç£">
                            </div>
                        </div>
                        <div id="parent-fields" class="space-y-4 hidden">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å®¶é•·å§“å *" data-en="Parent Name *">å®¶é•·å§“å *</label>
                                <input type="text" id="parent_name" name="parent_name"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="ä¾‹å¦‚ï¼šç‹åª½åª½" data-en-ph="e.g., Alice Wang" placeholder="ä¾‹å¦‚ï¼šç‹åª½åª½">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å®¶é•·é›»å­éƒµä»¶ *" data-en="Parent Email *">å®¶é•·é›»å­éƒµä»¶ *</label>
                                <input type="email" id="parent_email" name="parent_email"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="ä¾‹å¦‚ï¼šparent@example.com" data-en-ph="e.g., parent@example.com" placeholder="ä¾‹å¦‚ï¼šparent@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="èˆ‡å­¸ç”Ÿé—œä¿‚ *" data-en="Relationship to Student *">èˆ‡å­¸ç”Ÿé—œä¿‚ *</label>
                                <input type="text" id="relationship" name="relationship"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="ä¾‹å¦‚ï¼šæ¯è¦ª / çˆ¶è¦ª" data-en-ph="e.g., Mother / Father" placeholder="ä¾‹å¦‚ï¼šæ¯è¦ª">
                            </div>
                            <div class="border-t pt-4">
                                <p class="text-sm text-gray-500 mb-2" data-zh="å­¸ç”Ÿè¯çµ¡è³‡æ–™" data-en="Student Contact">å­¸ç”Ÿè¯çµ¡è³‡æ–™</p>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å­¸ç”Ÿå§“å *" data-en="Student Name *">å­¸ç”Ÿå§“å *</label>
                                <input type="text" id="child_name" name="child_name"
                                    class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    data-zh-ph="ä¾‹å¦‚ï¼šç‹å°æ˜" data-en-ph="e.g., David Wang" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜">
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å­¸ç”Ÿé›»å­éƒµä»¶ *" data-en="Student Email *">å­¸ç”Ÿé›»å­éƒµä»¶ *</label>
                                <input type="email" id="child_email" name="child_email"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="ä¾‹å¦‚ï¼šdavid@example.com" data-en-ph="e.g., david@example.com" placeholder="ä¾‹å¦‚ï¼šdavid@example.com">
                            </div>
                        </div>
                    </div>

                    <!-- å­¸è¡“èƒŒæ™¯ -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">2</span>
                                <span data-zh="å­¸è¡“èƒŒæ™¯" data-en="Academic Background">å­¸è¡“èƒŒæ™¯</span>
                            </div>
                        </h3>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="GPA (æ»¿åˆ†4.0) *" data-en="GPA (out of 4.0) *">GPA (æ»¿åˆ†4.0) *</label>
                            <input type="number" id="gpa" name="gpa" step="0.1" min="0" max="4" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                data-zh-ph="ä¾‹å¦‚ï¼š3.8" data-en-ph="e.g., 3.8" placeholder="ä¾‹å¦‚ï¼š3.8">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="ç›®æ¨™å­¸ä½ *" data-en="Target Degree *">ç›®æ¨™å­¸ä½ *</label>
                            <select id="degree" name="degree" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized">
                                <option value="" data-zh="è«‹é¸æ“‡" data-en="Please select">è«‹é¸æ“‡</option>
                                <option value="bachelor" data-zh="å­¸å£«" data-en="Bachelor's">å­¸å£«</option>
                                <option value="master" data-zh="ç¢©å£«" data-en="Master's">ç¢©å£«</option>
                                <option value="phd" data-zh="åšå£«" data-en="PhD">åšå£«</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="ç›®æ¨™åœ‹å®¶ *" data-en="Target Countries *">ç›®æ¨™åœ‹å®¶ *</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center">
                                    <input type="checkbox" name="countries" value="us" class="mr-2">
                                    <span data-zh="ç¾åœ‹" data-en="USA">ç¾åœ‹</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="countries" value="uk" class="mr-2">
                                    <span data-zh="è‹±åœ‹" data-en="UK">è‹±åœ‹</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="countries" value="ca" class="mr-2">
                                    <span data-zh="åŠ æ‹¿å¤§" data-en="Canada">åŠ æ‹¿å¤§</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- é ç®—å’Œæ™‚é–“ -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">3</span>
                                <span data-zh="é ç®—å’Œæ™‚é–“" data-en="Budget and Time">é ç®—å’Œæ™‚é–“</span>
                            </div>
                        </h3>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="é ç®— (æ¯å¹´å­¸è²»+ç”Ÿæ´»è²»ï¼Œå–®ä½ï¼šç¾å…ƒ) *" data-en="Budget (Annual tuition + living expenses, USD) *">é ç®— (æ¯å¹´å­¸è²»+ç”Ÿæ´»è²»ï¼Œå–®ä½ï¼šç¾å…ƒ) *</label>
                            <input type="number" id="budget" name="budget" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                data-zh-ph="ä¾‹å¦‚ï¼š50000" data-en-ph="e.g., 50000" placeholder="ä¾‹å¦‚ï¼š50000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="ç›®æ¨™å…¥å­¸æ™‚é–“ *" data-en="Target Intake Time *">ç›®æ¨™å…¥å­¸æ™‚é–“ *</label>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                <select id="intake_semester" name="intake_semester" required 
                                    class="w-full sm:w-1/3 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                    <option value="" data-zh="é¸æ“‡å­¸æœŸ" data-en="Select Semester">é¸æ“‡å­¸æœŸ</option>
                                    <option value="fall" data-zh="ç§‹å­£" data-en="Fall">ç§‹å­£</option>
                                    <option value="spring" data-zh="æ˜¥å­£" data-en="Spring">æ˜¥å­£</option>
                                    <option value="summer" data-zh="å¤å­£" data-en="Summer">å¤å­£</option>
                                    <option value="winter" data-zh="å†¬å­£" data-en="Winter">å†¬å­£</option>
                                </select>
                                <select id="intake_year" name="intake_year" required 
                                    class="w-full sm:w-2/3 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                    <option value="" data-zh="é¸æ“‡å¹´ä»½" data-en="Select Year">é¸æ“‡å¹´ä»½</option>
                                </select>
                            </div>
                            <input type="hidden" id="target_intake" name="target_intake">
                        </div>
                    </div>

                    <!-- è§’è‰²é¸æ“‡ -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">4</span>
                                <span data-zh="é¸æ“‡æ‚¨çš„èº«ä»½" data-en="Choose Your Role">é¸æ“‡æ‚¨çš„èº«ä»½</span>
                            </div>
                        </h3>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                            <button type="button" onclick="selectRole('student')" id="role-student" 
                                    class="flex-1 px-4 sm:px-6 py-3 bg-blue-500 text-white rounded-lg font-medium transition-colors text-sm sm:text-base">
                                <span data-zh="ğŸ‘¨â€ğŸ“ æˆ‘æ˜¯å­¸ç”Ÿ" data-en="ğŸ‘¨â€ğŸ“ I am a Student">ğŸ‘¨â€ğŸ“ æˆ‘æ˜¯å­¸ç”Ÿ</span>
                            </button>
                            <button type="button" onclick="selectRole('parent')" id="role-parent" 
                                    class="flex-1 px-4 sm:px-6 py-3 bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors hover:bg-gray-400 text-sm sm:text-base">
                                <span data-zh="ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ æˆ‘æ˜¯å®¶é•·" data-en="ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ I am a Parent">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ æˆ‘æ˜¯å®¶é•·</span>
                            </button>
                        </div>
                    </div>

                    <button type="submit" 
                            class="w-full bg-yellow-400 text-gray-800 py-3 px-6 rounded-lg font-medium hover:bg-yellow-500 transition-colors duration-200 text-lg shadow-lg"
                            data-zh="é–‹å§‹èˆ‡AIé¡§å•å°è©±" data-en="Start Chat with AI Advisor">
                        é–‹å§‹èˆ‡AIé¡§å•å°è©±
                    </button>
                </form>
            </main>
        </div>
    </div>

    <!-- èŠå¤©é é¢ -->
    <div id="chat-page" class="min-h-screen hidden">
        <div class="max-w-4xl mx-auto bg-white min-h-screen flex flex-col">
            <header class="bg-gradient-to-r from-yellow-400 to-yellow-300 text-gray-800 p-4 text-center relative">
                <button id="back-to-setup" class="absolute left-4 top-4 text-gray-800 hover:text-gray-600 transition-colors">
                    <span data-zh="â† é‡æ–°è¨­å®š" data-en="â† Reset Settings">â† é‡æ–°è¨­å®š</span>
                </button>
                <button onclick="logout()" class="absolute right-4 top-4 text-gray-800 hover:text-gray-600 transition-colors">
                    <span data-zh="ç™»å‡º" data-en="Logout">ç™»å‡º</span>
                </button>
                <h1 class="text-xl font-bold" data-zh="AI ç•™å­¸é¡§å•" data-en="AI Study Abroad Advisor">AI ç•™å­¸é¡§å•</h1>
                <p class="text-sm" data-zh="æ­£åœ¨ç‚ºæ‚¨æä¾›å°ˆæ¥­å»ºè­°" data-en="Providing you with professional advice">æ­£åœ¨ç‚ºæ‚¨æä¾›å°ˆæ¥­å»ºè­°</p>
                <div class="flex items-center justify-center mt-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                    <span class="text-sm" data-zh="åœ¨ç·š" data-en="Online">åœ¨ç·š</span>
                </div>
            </header>

            <main class="flex-1 p-6 overflow-y-auto bg-white chat-container mobile-optimized" id="chat-container">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-4">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">AI</div>
                            <div>
                                <h3 class="font-semibold text-gray-800" data-zh="AI ç•™å­¸é¡§å•" data-en="AI Study Abroad Advisor">AI ç•™å­¸é¡§å•</h3>
                                <p class="text-sm text-gray-500" data-zh="æ‚¨çš„å°ˆå±¬ç•™å­¸è¦åŠƒå°ˆå®¶" data-en="Your Exclusive Study Abroad Planning Expert">æ‚¨çš„å°ˆå±¬ç•™å­¸è¦åŠƒå°ˆå®¶</p>
                            </div>
                        </div>
                        <div class="text-gray-700 leading-relaxed">
                            <p class="mb-3" data-zh="ğŸ“ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIç•™å­¸é¡§å•ã€‚" data-en="ğŸ“ Hello! I am your AI Study Abroad Advisor.">ğŸ“ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIç•™å­¸é¡§å•ã€‚</p>
                            <p class="mb-3" data-zh="æˆ‘å·²ç¶“äº†è§£äº†æ‚¨çš„åŸºæœ¬è³‡è¨Šï¼Œç¾åœ¨è®“æˆ‘å€‘æ·±å…¥è¨è«–æ‚¨çš„ç•™å­¸è¨ˆåŠƒå§ï¼" data-en="I have reviewed your basic information, now let's dive deep into your study abroad planning!">æˆ‘å·²ç¶“äº†è§£äº†æ‚¨çš„åŸºæœ¬è³‡è¨Šï¼Œç¾åœ¨è®“æˆ‘å€‘æ·±å…¥è¨è«–æ‚¨çš„ç•™å­¸è¨ˆåŠƒå§ï¼</p>
                            <p class="mb-3" data-zh="æ‚¨å¯ä»¥å•æˆ‘ä»»ä½•é—œæ–¼ç•™å­¸çš„å•é¡Œï¼Œæ¯”å¦‚ï¼š" data-en="You can ask me any questions about studying abroad, such as:">æ‚¨å¯ä»¥å•æˆ‘ä»»ä½•é—œæ–¼ç•™å­¸çš„å•é¡Œï¼Œæ¯”å¦‚ï¼š</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-4">
                                <div class="flex items-center text-sm text-gray-600">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                    <span data-zh="æ¨è–¦é©åˆçš„å­¸æ ¡å’Œå°ˆæ¥­" data-en="School and major recommendations">æ¨è–¦é©åˆçš„å­¸æ ¡å’Œå°ˆæ¥­</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                    <span data-zh="ç”³è«‹æµç¨‹å’Œæ™‚é–“è¦åŠƒ" data-en="Application process and timeline">ç”³è«‹æµç¨‹å’Œæ™‚é–“è¦åŠƒ</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                    <span data-zh="çå­¸é‡‘ç”³è«‹å»ºè­°" data-en="Scholarship application advice">çå­¸é‡‘ç”³è«‹å»ºè­°</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                    <span data-zh="ç°½è­‰å’Œä½å®¿è³‡è¨Š" data-en="Visa and accommodation info">ç°½è­‰å’Œä½å®¿è³‡è¨Š</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-400 mt-3" data-zh="å‰›å‰›" data-en="Just now">å‰›å‰›</div>
                    </div>
                </div>
            </main>

            <footer class="p-6 border-t border-gray-200 bg-gray-50">
                <div class="max-w-4xl mx-auto">
                    <div id="quick-actions" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 mb-4"></div>
                    <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                        <textarea id="message-input" rows="2"
                               class="flex-1 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base bg-white resize-none"
                               placeholder="å‘Šè¨´æˆ‘ä½ çš„ç•™å­¸éœ€æ±‚ã€ç›®æ¨™æˆ–å›°æƒ‘..."
                               data-zh-ph="å‘Šè¨´æˆ‘ä½ çš„ç•™å­¸éœ€æ±‚ã€ç›®æ¨™æˆ–å›°æƒ‘..."
                               data-en-ph="Tell me your study abroad needs, goals, or confusions..."></textarea>
                        <button id="send-btn" 
                                class="px-6 py-4 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition-colors text-sm sm:text-base flex items-center justify-center">
                            <span data-zh="é€å‡º" data-en="Send">é€å‡º</span>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-3 text-center" data-zh="æŒ‰ Ctrl+Enter ç™¼é€ï¼ŒEnter æ›è¡Œ" data-en="Press Ctrl+Enter to send, Enter for new line">æŒ‰ Ctrl+Enter ç™¼é€ï¼ŒEnter æ›è¡Œ</p>
                </div>
            </footer>
        </div>
    </div>

    <!-- ç”¨æˆ¶è¨­å®šæ¨¡æ…‹æ¡† -->
    <div id="user-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800" data-zh="å€‹äººè¨­å®š" data-en="Personal Settings">å€‹äººè¨­å®š</h2>
                <button onclick="closeUserSettings()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-6">
                <!-- åŸºæœ¬è³‡è¨Š -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4" data-zh="åŸºæœ¬è³‡è¨Š" data-en="Basic Information">åŸºæœ¬è³‡è¨Š</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="é¡¯ç¤ºåç¨±" data-en="Display Name">é¡¯ç¤ºåç¨±</label>
                            <input type="text" id="settings-display-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="èªè¨€åå¥½" data-en="Language Preference">èªè¨€åå¥½</label>
                            <select id="settings-language" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="zh" data-zh="ä¸­æ–‡" data-en="Chinese">ä¸­æ–‡</option>
                                <option value="en" data-zh="English" data-en="English">English</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- é€šçŸ¥è¨­å®š -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4" data-zh="é€šçŸ¥è¨­å®š" data-en="Notification Settings">é€šçŸ¥è¨­å®š</h3>
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="checkbox" id="settings-email-notifications" class="mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <span class="text-gray-700" data-zh="æ¥æ”¶é›»å­éƒµä»¶é€šçŸ¥" data-en="Receive email notifications">æ¥æ”¶é›»å­éƒµä»¶é€šçŸ¥</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="settings-push-notifications" class="mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <span class="text-gray-700" data-zh="æ¥æ”¶æ¨é€é€šçŸ¥" data-en="Receive push notifications">æ¥æ”¶æ¨é€é€šçŸ¥</span>
                        </label>
                    </div>
                </div>

                <!-- éš±ç§è¨­å®š -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4" data-zh="éš±ç§è¨­å®š" data-en="Privacy Settings">éš±ç§è¨­å®š</h3>
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="checkbox" id="settings-data-sharing" class="mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <span class="text-gray-700" data-zh="å…è¨±åŒ¿åæ•¸æ“šåˆ†äº«ä»¥æ”¹å–„æœå‹™" data-en="Allow anonymous data sharing to improve service">å…è¨±åŒ¿åæ•¸æ“šåˆ†äº«ä»¥æ”¹å–„æœå‹™</span>
                        </label>
                    </div>
                </div>

                <!-- ç·¨è¼¯è¨­å®šè³‡æ–™ -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4" data-zh="ç•™å­¸è¨­å®šè³‡æ–™" data-en="Study Abroad Settings">ç•™å­¸è¨­å®šè³‡æ–™</h3>
                    <div id="profile-data-display" class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-gray-600 text-center" data-zh="è¼‰å…¥ä¸­..." data-en="Loading...">è¼‰å…¥ä¸­...</p>
                    </div>
                    <button onclick="editProfileData()" class="w-full mt-3 bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        <span data-zh="ç·¨è¼¯è¨­å®šè³‡æ–™" data-en="Edit Profile Data">ç·¨è¼¯è¨­å®šè³‡æ–™</span>
                    </button>
                </div>

                <!-- æ“ä½œæŒ‰éˆ• -->
                <div class="flex space-x-3">
                    <button onclick="saveUserSettings()" class="flex-1 bg-green-500 text-white py-3 px-4 rounded-lg hover:bg-green-600 transition-colors font-medium">
                        <span data-zh="å„²å­˜è¨­å®š" data-en="Save Settings">å„²å­˜è¨­å®š</span>
                    </button>
                    <button onclick="closeUserSettings()" class="flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                        <span data-zh="å–æ¶ˆ" data-en="Cancel">å–æ¶ˆ</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯è¨­å®šè³‡æ–™æ¨¡æ…‹æ¡† -->
    <div id="edit-profile-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800" data-zh="ç·¨è¼¯ç•™å­¸è¨­å®š" data-en="Edit Study Abroad Settings">ç·¨è¼¯ç•™å­¸è¨­å®š</h2>
                <button onclick="closeEditProfileModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-6">
                <form id="edit-profile-form">
                    <!-- é€™è£¡æœƒå‹•æ…‹è¼‰å…¥è¨­å®šè¡¨å–® -->
                    <div id="edit-profile-content">
                        <p class="text-gray-600 text-center" data-zh="è¼‰å…¥è¨­å®šè³‡æ–™ä¸­..." data-en="Loading settings data...">è¼‰å…¥è¨­å®šè³‡æ–™ä¸­...</p>
                    </div>
                    
                    <div class="flex space-x-3 mt-6">
                        <button type="submit" class="flex-1 bg-blue-500 text-white py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors font-medium">
                            <span data-zh="å„²å­˜è®Šæ›´" data-en="Save Changes">å„²å­˜è®Šæ›´</span>
                        </button>
                        <button type="button" onclick="closeEditProfileModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                            <span data-zh="å–æ¶ˆ" data-en="Cancel">å–æ¶ˆ</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- å­¸ç”Ÿé€²åº¦æŸ¥è©¢æ¨¡æ…‹æ¡† -->
    <div id="student-progress-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800" data-zh="å­¸ç”Ÿè«®è©¢é€²åº¦" data-en="Student Consultation Progress">å­¸ç”Ÿè«®è©¢é€²åº¦</h2>
                <button onclick="closeStudentProgressModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-6">
                <div id="student-progress-content">
                    <p class="text-gray-600 text-center" data-zh="è¼‰å…¥é€²åº¦è³‡æ–™ä¸­..." data-en="Loading progress data...">è¼‰å…¥é€²åº¦è³‡æ–™ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        var currentRole = 'student';
        var currentLanguage = 'zh';
        var profileId = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å–å¾— Google Client ID ä»¥åˆå§‹åŒ– GIS
            fetch(window.__CONFIG__.API_BASE + '/auth/config')
                .then(r => r.json())
                .then(cfg => {
                    if (cfg && cfg.ok && cfg.googleClientId) {
                        window.__GOOGLE_CLIENT_ID__ = cfg.googleClientId;
                        console.log('Google Client ID loaded:', cfg.googleClientId);
                    } else {
                        console.warn('Google Client ID not configured');
                    }
                })
                .catch((error) => {
                    console.error('Failed to load Google Client ID:', error);
                });
            // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            checkAuthStatus();
            
            // åˆå§‹åŒ–å¹´ä»½é¸é …
            initializeYearOptions();
            
            // ç¶å®šäº‹ä»¶
            document.getElementById('back-to-home').addEventListener('click', showLoginPage);
            document.getElementById('back-to-setup').addEventListener('click', showSetupPage);
            document.getElementById('setup-form').addEventListener('submit', handleSetupSubmit);
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    // Ctrl+Enter ç™¼é€è¨Šæ¯
                    sendMessage();
                }
                // å–®ç¨æŒ‰ Enter åªæ›è¡Œï¼Œä¸ç™¼é€
            });
            
            // ç¶å®šæ—¥æœŸé¸æ“‡äº‹ä»¶
            document.getElementById('intake_semester').addEventListener('change', updateTargetIntake);
            document.getElementById('intake_year').addEventListener('change', updateTargetIntake);
        });

        // æª¢æŸ¥èªè­‰ç‹€æ…‹
        function checkAuthStatus() {
            try {
                fetch(window.__CONFIG__.API_BASE + '/auth/status')
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (data.ok && data.user) {
                        showUserInfo(data.user);
                    } else {
                        showLoginButtons();
                    }
                })
                .catch(function(error) {
                    console.error('Auth check failed:', error);
                    showLoginButtons();
                });
            } catch (error) {
                console.error('Auth check failed:', error);
                showLoginButtons();
            }
        }

        // é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
        function showUserInfo(user) {
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('login-buttons').classList.add('hidden');
            document.getElementById('user-name').textContent = user.name;
            if (user.avatar) {
                document.getElementById('user-avatar').src = user.avatar;
            }
        }

        // é¡¯ç¤ºç™»å…¥æŒ‰éˆ•
        function showLoginButtons() {
            document.getElementById('user-info').classList.add('hidden');
            document.getElementById('login-buttons').classList.remove('hidden');
        }

        // ç™»å…¥åŠŸèƒ½
        function loginWithGoogle() {
            // æª¢æŸ¥æ˜¯å¦åœ¨æ‰‹æ©Ÿç’°å¢ƒ
            var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // æ‰‹æ©Ÿç’°å¢ƒï¼šç›´æ¥è·³è½‰åˆ° Google OAuth
                var googleAuthUrl = 'https://accounts.google.com/o/oauth2/v2/auth?' +
                    'client_id=300123710303-m4j1laa65p664n5vtrdkfvfa7b42c2o6.apps.googleusercontent.com&' +
                    'redirect_uri=https://aistudentbackend.zeabur.app/auth/google/callback&' +
                    'response_type=code&' +
                    'scope=openid email profile&' +
                    'state=mobile_login';
                
                window.location.href = googleAuthUrl;
                return;
            }
            
            // æ¡Œé¢ç’°å¢ƒï¼šä½¿ç”¨ Google API
            if (!window.__GOOGLE_CLIENT_ID__) {
                alert(currentLanguage === 'en' ? 
                    'Google OAuth is not configured. Please use "Skip login" for now.' : 
                    'Google OAuth å°šæœªé…ç½®ã€‚è«‹å…ˆä½¿ç”¨ã€Œè·³éç™»å…¥ã€åŠŸèƒ½ã€‚');
                return;
            }
            
            console.log('Attempting Google login with Client ID:', window.__GOOGLE_CLIENT_ID__);
            
            // æ”¹ç”¨ one-tap çš„ ID token API
            google.accounts.id.initialize({
                client_id: window.__GOOGLE_CLIENT_ID__,
                callback: async (resp) => {
                    try {
                        var idToken = resp.credential;
                        var r = await fetch(window.__CONFIG__.API_BASE + '/auth/google/verify', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ idToken })
                        });
                        var data = await r.json();
                        if (data.ok && data.token) {
                            localStorage.setItem('jwt', data.token);
                            showUserInfo(data.user || { name: 'User' });
                            showSetupPage();
                        } else {
                            alert(currentLanguage === 'en' ? 'Login failed.' : 'ç™»å…¥å¤±æ•—');
                        }
                    } catch (err) {
                        alert(currentLanguage === 'en' ? 'Login failed.' : 'ç™»å…¥å¤±æ•—');
                    }
                }
            });
            
            // æ”¹ç”¨ç›´æ¥è·³è½‰æ–¹å¼ï¼ˆçµ±ä¸€ä½¿ç”¨ OAuth å›èª¿ï¼‰
            var googleAuthUrl = 'https://accounts.google.com/o/oauth2/v2/auth?' +
                'client_id=300123710303-m4j1laa65p664n5vtrdkfvfa7b42c2o6.apps.googleusercontent.com&' +
                'redirect_uri=https://aistudentbackend.zeabur.app/auth/google/callback&' +
                'response_type=code&' +
                'scope=openid email profile&' +
                'state=desktop_login';
            
            window.location.href = googleAuthUrl;
        }

        function loginWithLINE() {
            // ç²å– LINE Login URL
            fetch('https://aistudentbackend.zeabur.app/api/v1/auth/line/login')
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (data.ok) {
                        // é‡å®šå‘åˆ° LINE Login
                        window.location.href = data.login_url;
                    } else {
                        alert(currentLanguage === 'en' ? 
                            'LINE login is not available. Please use Google login or skip login.' : 
                            'LINE ç™»å…¥åŠŸèƒ½æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œè«‹ä½¿ç”¨ Google ç™»å…¥æˆ–è·³éç™»å…¥ã€‚');
                    }
                })
                .catch(function(error) {
                    console.error('LINE Login error:', error);
                    alert(currentLanguage === 'en' ? 
                        'LINE login failed. Please try again or use Google login.' : 
                        'LINE ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦æˆ–ä½¿ç”¨ Google ç™»å…¥ã€‚');
                });
        }
        
        // ç™»å‡ºåŠŸèƒ½
        function logout() {
            // æ¸…é™¤æœ¬åœ°å„²å­˜
            localStorage.removeItem('jwt');
            localStorage.removeItem('userProfile');
            
            // é¡¯ç¤ºç™»å‡ºæˆåŠŸè¨Šæ¯
            alert(currentLanguage === 'en' ? 
                'You have been logged out successfully.' : 
                'æ‚¨å·²æˆåŠŸç™»å‡ºã€‚');
            
            // é‡æ–°è¼‰å…¥é é¢
            window.location.href = 'https://aistudent.zeabur.app';
        }


        // è·³éç™»å…¥
        function skipLogin() {
            // å‰µå»ºä¸€å€‹å‡çš„ JWT token ç”¨æ–¼æ¸¬è©¦
            var fakeToken = 'fake-jwt-token-for-testing';
            localStorage.setItem('jwt', fakeToken);
            showSetupPage();
        }

        // è¼‰å…¥ç”¨æˆ¶è³‡è¨Š
        function loadUserInfo() {
            try {
                var userProfile = localStorage.getItem('userProfile');
                if (userProfile) {
                    var user = JSON.parse(userProfile);
                    document.getElementById('user-info-name').textContent = user.name || 'ç”¨æˆ¶';
                    document.getElementById('user-info-role').textContent = currentRole === 'parent' ? 'å®¶é•·' : 'å­¸ç”Ÿ';
                    if (user.avatar) {
                        document.getElementById('user-info-avatar').src = user.avatar;
                    }
                }
                
                // æ ¹æ“šè§’è‰²é¡¯ç¤º/éš±è—å®¶é•·å°ˆç”¨åŠŸèƒ½
                var parentSection = document.getElementById('parent-only-section');
                if (currentRole === 'parent') {
                    parentSection.classList.remove('hidden');
                } else {
                    parentSection.classList.add('hidden');
                }
            } catch (error) {
                console.error('è¼‰å…¥ç”¨æˆ¶è³‡è¨Šå¤±æ•—:', error);
            }
        }

        // ç¹¼çºŒåˆ°èŠå¤©
        function continueToChat() {
            // æª¢æŸ¥æ˜¯å¦æœ‰ profile è³‡æ–™
            if (!profileId) {
                // æª¢æŸ¥æœ¬åœ°å„²å­˜çš„ profileId
                var storedProfileId = localStorage.getItem('profileId');
                if (storedProfileId) {
                    profileId = storedProfileId;
                } else {
                    // æ²’æœ‰ profile è³‡æ–™ï¼Œè·³è½‰åˆ°è¨­å®šé é¢
                    showSetupPage();
                    return;
                }
            }
            showChatPage();
        }

        // é–‹å•Ÿç”¨æˆ¶è¨­å®š
        function openUserSettings() {
            document.getElementById('user-settings-modal').classList.remove('hidden');
            loadUserSettings();
        }

        // é—œé–‰ç”¨æˆ¶è¨­å®š
        function closeUserSettings() {
            document.getElementById('user-settings-modal').classList.add('hidden');
        }

        // è¼‰å…¥ç”¨æˆ¶è¨­å®š
        function loadUserSettings() {
            try {
                var userProfile = localStorage.getItem('userProfile');
                if (userProfile) {
                    var user = JSON.parse(userProfile);
                    document.getElementById('settings-display-name').value = user.name || '';
                }
                
                document.getElementById('settings-language').value = currentLanguage;
                
                // è¼‰å…¥é€šçŸ¥è¨­å®š
                loadNotificationSettings();
                
                // è¼‰å…¥ profile è³‡æ–™
                loadUserProfileData();
            } catch (error) {
                console.error('è¼‰å…¥ç”¨æˆ¶è¨­å®šå¤±æ•—:', error);
            }
        }

        // è¼‰å…¥é€šçŸ¥è¨­å®š
        function loadNotificationSettings() {
            try {
                var jwt = localStorage.getItem('jwt');
                if (!jwt) return;
                
                fetch(window.__CONFIG__.API_BASE + '/user/notification-settings', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + jwt,
                        'Content-Type': 'application/json'
                    }
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    if (result.ok && result.data) {
                        document.getElementById('settings-email-notifications').checked = result.data.email_notifications || false;
                        document.getElementById('settings-push-notifications').checked = result.data.push_notifications || false;
                    }
                })
                .catch(function(error) {
                    console.error('è¼‰å…¥é€šçŸ¥è¨­å®šå¤±æ•—:', error);
                });
            } catch (error) {
                console.error('è¼‰å…¥é€šçŸ¥è¨­å®šå¤±æ•—:', error);
            }
        }

        // è¼‰å…¥ç”¨æˆ¶ profile è³‡æ–™
        function loadUserProfileData() {
            try {
                if (!profileId) {
                    document.getElementById('profile-data-display').innerHTML = 
                        '<p class="text-yellow-600 text-center" data-zh="å°šæœªè¨­å®šç•™å­¸éœ€æ±‚è³‡æ–™" data-en="Study abroad requirements not set yet">å°šæœªè¨­å®šç•™å­¸éœ€æ±‚è³‡æ–™</p>';
                    return;
                }
                
                var jwt = localStorage.getItem('jwt');
                if (!jwt) return;
                
                fetch(window.__CONFIG__.API_BASE + '/user/profile/' + profileId, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + jwt,
                        'Content-Type': 'application/json'
                    }
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    if (result.ok && result.data) {
                        var profile = result.data;
                        var displayHtml = '<div class="space-y-2">';
                        
                        if (profile.student_name) {
                            displayHtml += '<p><span class="font-medium">å­¸ç”Ÿå§“åï¼š</span>' + profile.student_name + '</p>';
                        }
                        if (profile.gpa) {
                            displayHtml += '<p><span class="font-medium">GPAï¼š</span>' + profile.gpa + '</p>';
                        }
                        if (profile.degree) {
                            displayHtml += '<p><span class="font-medium">ç›®æ¨™å­¸ä½ï¼š</span>' + profile.degree + '</p>';
                        }
                        if (profile.countries && profile.countries.length > 0) {
                            displayHtml += '<p><span class="font-medium">ç›®æ¨™åœ‹å®¶ï¼š</span>' + profile.countries.join(', ') + '</p>';
                        }
                        if (profile.budget) {
                            displayHtml += '<p><span class="font-medium">é ç®—ï¼š</span>$' + profile.budget.toLocaleString() + ' USD/å¹´</p>';
                        }
                        if (profile.target_intake) {
                            displayHtml += '<p><span class="font-medium">ç›®æ¨™å…¥å­¸æ™‚é–“ï¼š</span>' + profile.target_intake + '</p>';
                        }
                        
                        displayHtml += '</div>';
                        document.getElementById('profile-data-display').innerHTML = displayHtml;
                    } else {
                        document.getElementById('profile-data-display').innerHTML = 
                            '<p class="text-yellow-600 text-center" data-zh="è¼‰å…¥è¨­å®šè³‡æ–™å¤±æ•—" data-en="Failed to load settings data">è¼‰å…¥è¨­å®šè³‡æ–™å¤±æ•—</p>';
                    }
                })
                .catch(function(error) {
                    console.error('è¼‰å…¥ profile è³‡æ–™å¤±æ•—:', error);
                    document.getElementById('profile-data-display').innerHTML = 
                        '<p class="text-red-600 text-center" data-zh="è¼‰å…¥è¨­å®šè³‡æ–™å¤±æ•—" data-en="Failed to load settings data">è¼‰å…¥è¨­å®šè³‡æ–™å¤±æ•—</p>';
                });
            } catch (error) {
                console.error('è¼‰å…¥ profile è³‡æ–™å¤±æ•—:', error);
            }
        }

        // å„²å­˜ç”¨æˆ¶è¨­å®š
        function saveUserSettings() {
            try {
                var jwt = localStorage.getItem('jwt');
                if (!jwt) {
                    alert(currentLanguage === 'en' ? 'Please login first' : 'è«‹å…ˆç™»å…¥');
                    return;
                }
                
                var settings = {
                    display_name: document.getElementById('settings-display-name').value,
                    language: document.getElementById('settings-language').value,
                    email_notifications: document.getElementById('settings-email-notifications').checked,
                    push_notifications: document.getElementById('settings-push-notifications').checked,
                    data_sharing: document.getElementById('settings-data-sharing').checked
                };
                
                // å„²å­˜é€šçŸ¥è¨­å®š
                fetch(window.__CONFIG__.API_BASE + '/user/notification-settings', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + jwt,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email_notifications: settings.email_notifications,
                        push_notifications: settings.push_notifications
                    })
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    if (result.ok) {
                        // æ›´æ–°èªè¨€
                        if (settings.language !== currentLanguage) {
                            switchLanguage(settings.language);
                        }
                        
                        alert(currentLanguage === 'en' ? 'Settings saved successfully!' : 'è¨­å®šå·²å„²å­˜ï¼');
                        closeUserSettings();
                    } else {
                        alert(currentLanguage === 'en' ? 'Failed to save settings' : 'å„²å­˜è¨­å®šå¤±æ•—');
                    }
                })
                .catch(function(error) {
                    console.error('å„²å­˜è¨­å®šå¤±æ•—:', error);
                    alert(currentLanguage === 'en' ? 'Failed to save settings' : 'å„²å­˜è¨­å®šå¤±æ•—');
                });
            } catch (error) {
                console.error('å„²å­˜è¨­å®šå¤±æ•—:', error);
                alert(currentLanguage === 'en' ? 'Failed to save settings' : 'å„²å­˜è¨­å®šå¤±æ•—');
            }
        }

        // ç·¨è¼¯ profile è³‡æ–™
        function editProfileData() {
            document.getElementById('edit-profile-modal').classList.remove('hidden');
            loadEditProfileForm();
        }

        // é—œé–‰ç·¨è¼¯ profile æ¨¡æ…‹æ¡†
        function closeEditProfileModal() {
            document.getElementById('edit-profile-modal').classList.add('hidden');
        }

        // è¼‰å…¥ç·¨è¼¯ profile è¡¨å–®
        function loadEditProfileForm() {
            try {
                if (!profileId) {
                    document.getElementById('edit-profile-content').innerHTML = 
                        '<p class="text-yellow-600 text-center" data-zh="å°šæœªè¨­å®šç•™å­¸éœ€æ±‚è³‡æ–™" data-en="Study abroad requirements not set yet">å°šæœªè¨­å®šç•™å­¸éœ€æ±‚è³‡æ–™</p>';
                    return;
                }
                
                var jwt = localStorage.getItem('jwt');
                if (!jwt) return;
                
                fetch(window.__CONFIG__.API_BASE + '/user/profile/' + profileId, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + jwt,
                        'Content-Type': 'application/json'
                    }
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    if (result.ok && result.data) {
                        var profile = result.data;
                        var formHtml = '<div class="space-y-4">';
                        
                        formHtml += '<div>';
                        formHtml += '<label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å­¸ç”Ÿå§“å" data-en="Student Name">å­¸ç”Ÿå§“å</label>';
                        formHtml += '<input type="text" id="edit-student-name" value="' + (profile.student_name || '') + '" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">';
                        formHtml += '</div>';
                        
                        formHtml += '<div>';
                        formHtml += '<label class="block text-sm font-medium text-gray-700 mb-2" data-zh="GPA" data-en="GPA">GPA</label>';
                        formHtml += '<input type="number" id="edit-gpa" step="0.1" min="0" max="4" value="' + (profile.gpa || '') + '" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">';
                        formHtml += '</div>';
                        
                        formHtml += '<div>';
                        formHtml += '<label class="block text-sm font-medium text-gray-700 mb-2" data-zh="é ç®— (USD/å¹´)" data-en="Budget (USD/year)">é ç®— (USD/å¹´)</label>';
                        formHtml += '<input type="number" id="edit-budget" value="' + (profile.budget || '') + '" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">';
                        formHtml += '</div>';
                        
                        formHtml += '</div>';
                        document.getElementById('edit-profile-content').innerHTML = formHtml;
                    } else {
                        document.getElementById('edit-profile-content').innerHTML = 
                            '<p class="text-yellow-600 text-center" data-zh="è¼‰å…¥è¨­å®šè³‡æ–™å¤±æ•—" data-en="Failed to load settings data">è¼‰å…¥è¨­å®šè³‡æ–™å¤±æ•—</p>';
                    }
                })
                .catch(function(error) {
                    console.error('è¼‰å…¥ç·¨è¼¯è¡¨å–®å¤±æ•—:', error);
                    document.getElementById('edit-profile-content').innerHTML = 
                        '<p class="text-red-600 text-center" data-zh="è¼‰å…¥è¨­å®šè³‡æ–™å¤±æ•—" data-en="Failed to load settings data">è¼‰å…¥è¨­å®šè³‡æ–™å¤±æ•—</p>';
                });
            } catch (error) {
                console.error('è¼‰å…¥ç·¨è¼¯è¡¨å–®å¤±æ•—:', error);
            }
        }

        // æŸ¥è©¢å­¸ç”Ÿé€²åº¦ï¼ˆå®¶é•·å°ˆç”¨ï¼‰
        function queryStudentProgress() {
            document.getElementById('student-progress-modal').classList.remove('hidden');
            loadStudentProgress();
        }

        // é—œé–‰å­¸ç”Ÿé€²åº¦æ¨¡æ…‹æ¡†
        function closeStudentProgressModal() {
            document.getElementById('student-progress-modal').classList.add('hidden');
        }

        // è¼‰å…¥å­¸ç”Ÿé€²åº¦
        function loadStudentProgress() {
            try {
                var jwt = localStorage.getItem('jwt');
                if (!jwt) {
                    document.getElementById('student-progress-content').innerHTML = 
                        '<p class="text-red-600 text-center" data-zh="è«‹å…ˆç™»å…¥" data-en="Please login first">è«‹å…ˆç™»å…¥</p>';
                    return;
                }
                
                fetch(window.__CONFIG__.API_BASE + '/parent/student-progress', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + jwt,
                        'Content-Type': 'application/json'
                    }
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    if (result.ok && result.data) {
                        var progress = result.data;
                        var progressHtml = '<div class="space-y-6">';
                        
                        // æ´»å‹•çµ±è¨ˆ
                        progressHtml += '<div class="bg-blue-50 p-4 rounded-lg">';
                        progressHtml += '<h3 class="text-lg font-semibold text-gray-800 mb-3" data-zh="æ´»å‹•çµ±è¨ˆ" data-en="Activity Statistics">æ´»å‹•çµ±è¨ˆ</h3>';
                        progressHtml += '<div class="grid grid-cols-2 gap-4">';
                        progressHtml += '<div class="text-center"><div class="text-2xl font-bold text-blue-600">' + (progress.total_sessions || 0) + '</div><div class="text-sm text-gray-600" data-zh="è«®è©¢æ¬¡æ•¸" data-en="Consultation Sessions">è«®è©¢æ¬¡æ•¸</div></div>';
                        progressHtml += '<div class="text-center"><div class="text-2xl font-bold text-green-600">' + (progress.total_messages || 0) + '</div><div class="text-sm text-gray-600" data-zh="å°è©±æ•¸" data-en="Messages">å°è©±æ•¸</div></div>';
                        progressHtml += '</div></div>';
                        
                        // æœ€è¿‘è©±é¡Œ
                        if (progress.recent_topics && progress.recent_topics.length > 0) {
                            progressHtml += '<div class="bg-green-50 p-4 rounded-lg">';
                            progressHtml += '<h3 class="text-lg font-semibold text-gray-800 mb-3" data-zh="æœ€è¿‘è¨è«–è©±é¡Œ" data-en="Recent Topics">æœ€è¿‘è¨è«–è©±é¡Œ</h3>';
                            progressHtml += '<ul class="space-y-2">';
                            for (var i = 0; i < progress.recent_topics.length; i++) {
                                progressHtml += '<li class="flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>' + progress.recent_topics[i] + '</li>';
                            }
                            progressHtml += '</ul></div>';
                        }
                        
                        // AI åˆ†æå»ºè­°
                        if (progress.ai_analysis) {
                            progressHtml += '<div class="bg-yellow-50 p-4 rounded-lg">';
                            progressHtml += '<h3 class="text-lg font-semibold text-gray-800 mb-3" data-zh="AI åˆ†æå»ºè­°" data-en="AI Analysis & Recommendations">AI åˆ†æå»ºè­°</h3>';
                            progressHtml += '<div class="text-gray-700">' + progress.ai_analysis + '</div>';
                            progressHtml += '</div>';
                        }
                        
                        progressHtml += '</div>';
                        document.getElementById('student-progress-content').innerHTML = progressHtml;
                    } else {
                        document.getElementById('student-progress-content').innerHTML = 
                            '<p class="text-yellow-600 text-center" data-zh="æš«ç„¡é€²åº¦è³‡æ–™" data-en="No progress data available">æš«ç„¡é€²åº¦è³‡æ–™</p>';
                    }
                })
                .catch(function(error) {
                    console.error('è¼‰å…¥å­¸ç”Ÿé€²åº¦å¤±æ•—:', error);
                    document.getElementById('student-progress-content').innerHTML = 
                        '<p class="text-red-600 text-center" data-zh="è¼‰å…¥é€²åº¦è³‡æ–™å¤±æ•—" data-en="Failed to load progress data">è¼‰å…¥é€²åº¦è³‡æ–™å¤±æ•—</p>';
                });
            } catch (error) {
                console.error('è¼‰å…¥å­¸ç”Ÿé€²åº¦å¤±æ•—:', error);
            }
        }

        // AI è¼‰å…¥å‹•ç•«
        function showAILoading() {
            var loadingDiv = document.createElement('div');
            loadingDiv.id = 'ai-loading';
            loadingDiv.className = 'ai-loading-message';
            loadingDiv.innerHTML = '<div class="ai-loading-spinner"></div><span data-zh="AI æ­£åœ¨æ€è€ƒä¸­..." data-en="AI is thinking...">AI æ­£åœ¨æ€è€ƒä¸­...</span>';
            document.getElementById('chat-container').appendChild(loadingDiv);
            document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;
        }

        function hideAILoading() {
            var loadingDiv = document.getElementById('ai-loading');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // è¼‰å…¥èŠå¤©æ­·å²
        function loadChatHistory() {
            try {
                var chatHistory = localStorage.getItem('chatHistory_' + profileId);
                if (chatHistory) {
                    var messages = JSON.parse(chatHistory);
                    var chatContainer = document.getElementById('chat-container');
                    
                    // æ¸…ç©ºç¾æœ‰å…§å®¹ï¼ˆä¿ç•™æ­¡è¿è¨Šæ¯ï¼‰
                    var welcomeMessage = chatContainer.querySelector('.bg-white.rounded-lg.shadow-sm.border.border-gray-200');
                    chatContainer.innerHTML = '';
                    if (welcomeMessage) {
                        chatContainer.appendChild(welcomeMessage);
                    }
                    
                    // è¼‰å…¥æ­·å²è¨Šæ¯
                    for (var i = 0; i < messages.length; i++) {
                        addMessage(messages[i].message, messages[i].sender, false);
                    }
                } else {
                    // æ²’æœ‰æ­·å²è¨˜éŒ„ï¼Œç™¼é€æ­¡è¿è¨Šæ¯
                    sendWelcomeMessage();
                }
            } catch (error) {
                console.error('è¼‰å…¥èŠå¤©æ­·å²å¤±æ•—:', error);
                sendWelcomeMessage();
            }
        }

        // å„²å­˜èŠå¤©æ­·å²
        function saveChatHistory(message, sender) {
            try {
                if (!profileId) return;
                
                var chatHistory = localStorage.getItem('chatHistory_' + profileId);
                var messages = chatHistory ? JSON.parse(chatHistory) : [];
                
                messages.push({
                    message: message,
                    sender: sender,
                    timestamp: new Date().toISOString()
                });
                
                // åªä¿ç•™æœ€è¿‘ 50 æ¢è¨Šæ¯
                if (messages.length > 50) {
                    messages = messages.slice(-50);
                }
                
                localStorage.setItem('chatHistory_' + profileId, JSON.stringify(messages));
            } catch (error) {
                console.error('å„²å­˜èŠå¤©æ­·å²å¤±æ•—:', error);
            }
        }


        // åˆå§‹åŒ–å¹´ä»½é¸é …
        function initializeYearOptions() {
            var yearSelect = document.getElementById('intake_year');
            var currentYear = new Date().getFullYear();
            
            // ç”Ÿæˆæœªä¾† 5 å¹´çš„é¸é …
            for (var i = 0; i < 5; i++) {
                var year = currentYear + i;
                var option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                option.setAttribute('data-zh', year);
                option.setAttribute('data-en', year);
                yearSelect.appendChild(option);
            }
        }

        // æ›´æ–°ç›®æ¨™å…¥å­¸æ™‚é–“
        function updateTargetIntake() {
            var semester = document.getElementById('intake_semester').value;
            var year = document.getElementById('intake_year').value;
            var targetIntakeInput = document.getElementById('target_intake');
            
            if (semester && year) {
                var semesterText = currentLanguage === 'en' 
                    ? semester.charAt(0).toUpperCase() + semester.slice(1)
                    : semester === 'fall' ? 'ç§‹å­£' : semester === 'spring' ? 'æ˜¥å­£' : semester === 'summer' ? 'å¤å­£' : 'å†¬å­£';
                
                var intakeText = currentLanguage === 'en' 
                    ? semesterText + ' ' + year
                    : year + 'å¹´' + semesterText;
                
                targetIntakeInput.value = intakeText;
            } else {
                targetIntakeInput.value = '';
            }
        }

        // èªè¨€åˆ‡æ›
        function switchLanguage(lang) {
            currentLanguage = lang;
            // æ›´æ–°æ‰€æœ‰å…·å‚™ data-zh / data-en çš„å…ƒç´ 
            var elements = document.querySelectorAll('[data-zh]');
            for (var i = 0; i < elements.length; i++) {
                var el = elements[i];
                var text = el.getAttribute('data-' + currentLanguage);
                if (text) el.textContent = text;
            }
            // æ›´æ–° placeholder
            var inputs = document.querySelectorAll('[data-zh-ph]');
            for (var j = 0; j < inputs.length; j++) {
                var input = inputs[j];
                var placeholder = input.getAttribute('data-' + currentLanguage + '-ph');
                if (placeholder) input.placeholder = placeholder;
            }
            // æ›´æ–° select é¸é …
            var options = document.querySelectorAll('option[data-zh]');
            for (var k = 0; k < options.length; k++) {
                var option = options[k];
                var text = option.getAttribute('data-' + currentLanguage);
                if (text) option.textContent = text;
            }
            
            // æ›´æ–°ç›®æ¨™å…¥å­¸æ™‚é–“é¡¯ç¤º
            updateTargetIntake();
            
            // æ›´æ–°èªè¨€åˆ‡æ›æŒ‰éˆ•æ¨£å¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            var zhBtn = document.getElementById('lang-switch-zh');
            var enBtn = document.getElementById('lang-switch-en');
            if (zhBtn && enBtn) {
                zhBtn.classList.toggle('bg-blue-500', lang === 'zh');
                zhBtn.classList.toggle('bg-gray-200', lang !== 'zh');
                zhBtn.classList.toggle('text-white', lang === 'zh');
                zhBtn.classList.toggle('text-gray-700', lang !== 'zh');
                enBtn.classList.toggle('bg-blue-500', lang === 'en');
                enBtn.classList.toggle('bg-gray-200', lang !== 'en');
                enBtn.classList.toggle('text-white', lang === 'en');
                enBtn.classList.toggle('text-gray-700', lang !== 'en');
            }
            
            // é‡æ–°è¼‰å…¥å¿«é€Ÿå‹•ä½œæŒ‰éˆ•
            loadQuickActions();
        }

        // è§’è‰²é¸æ“‡
        function selectRole(role) {
            currentRole = role;
            document.getElementById('role-student').classList.toggle('bg-blue-500', role === 'student');
            document.getElementById('role-student').classList.toggle('bg-gray-300', role !== 'student');
            document.getElementById('role-parent').classList.toggle('bg-blue-500', role === 'parent');
            document.getElementById('role-parent').classList.toggle('bg-gray-300', role !== 'parent');

            // åˆ‡æ›æ¬„ä½é¡¯ç¤º
            document.getElementById('student-fields').classList.toggle('hidden', role !== 'student');
            document.getElementById('parent-fields').classList.toggle('hidden', role !== 'parent');
            loadQuickActions();
        }

        // é é¢åˆ‡æ›
        function showLoginPage() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('user-info-page').classList.add('hidden');
            document.getElementById('setup-page').classList.add('hidden');
            document.getElementById('chat-page').classList.add('hidden');
        }

        function validateToken(token) {
            // ç°¡å–®çš„ token é©—è­‰ï¼Œæª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„ JWT æ ¼å¼
            try {
                var parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid token format');
                }
                
                // æª¢æŸ¥ token æ˜¯å¦éæœŸï¼ˆç°¡å–®æª¢æŸ¥ï¼‰
                var payload = JSON.parse(atob(parts[1]));
                var currentTime = Math.floor(Date.now() / 1000);
                
                if (payload.exp && payload.exp < currentTime) {
                    throw new Error('Token expired');
                }
                
                // Token æœ‰æ•ˆï¼Œé¡¯ç¤ºè¨­å®šé é¢
                showSetupPage();
            } catch (error) {
                console.log('Token validation failed:', error);
                // Token ç„¡æ•ˆï¼Œæ¸…é™¤ä¸¦é¡¯ç¤ºç™»å…¥é é¢
                localStorage.removeItem('jwt');
                showLoginPage();
            }
        }

        function showUserInfoPage() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('user-info-page').classList.remove('hidden');
            document.getElementById('setup-page').classList.add('hidden');
            document.getElementById('chat-page').classList.add('hidden');
            
            // è¼‰å…¥ç”¨æˆ¶è³‡è¨Š
            loadUserInfo();
        }

        function showSetupPage() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('user-info-page').classList.add('hidden');
            document.getElementById('setup-page').classList.remove('hidden');
            document.getElementById('chat-page').classList.add('hidden');
        }

        function showChatPage() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('user-info-page').classList.add('hidden');
            document.getElementById('setup-page').classList.add('hidden');
            document.getElementById('chat-page').classList.remove('hidden');
            
            // æ›´æ–°èŠå¤©é é¢çš„èªè¨€
            switchLanguage(currentLanguage);
            
            loadQuickActions();
            // è¼‰å…¥èŠå¤©æ­·å²
            loadChatHistory();
        }

        // è™•ç†è¨­å®šæäº¤
        function handleSetupSubmit(e) {
            e.preventDefault();
            
            var formData = new FormData(e.target);
            var data = {};
            
            if (currentRole === 'student') {
                data = {
                    student_name: formData.get('student_name'),
                    student_email: formData.get('student_email'),
                    citizenship: formData.get('citizenship'),
                    gpa: parseFloat(formData.get('gpa')),
                    degree: formData.get('degree'),
                    countries: getCheckedCountries(),
                    budget: parseInt(formData.get('budget')),
                    target_intake: formData.get('target_intake'),
                    user_role: currentRole
                };
            } else {
                data = {
                    parent_name: formData.get('parent_name'),
                    parent_email: formData.get('parent_email'),
                    relationship: formData.get('relationship'),
                    child_name: formData.get('child_name'),
                    child_email: formData.get('child_email'),
                    gpa: parseFloat(formData.get('gpa')),
                    degree: formData.get('degree'),
                    countries: getCheckedCountries(),
                    budget: parseInt(formData.get('budget')),
                    target_intake: formData.get('target_intake'),
                    user_role: currentRole
                };
            }

            try {
                // æª¢æŸ¥æ˜¯å¦æœ‰ JWT token
                var jwt = localStorage.getItem('jwt');
                if (!jwt) {
                    alert(currentLanguage === 'en' ? 'Please login first or skip login to continue.' : 'è«‹å…ˆç™»å…¥æˆ–è·³éç™»å…¥ç¹¼çºŒ');
                    return;
                }
                
                var authHeader = { 'Authorization': 'Bearer ' + jwt };
                var headers = {
                    'Content-Type': 'application/json'
                };
                for (var key in authHeader) {
                    headers[key] = authHeader[key];
                }
                
                fetch(window.__CONFIG__.API_BASE + '/intake', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(data)
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    if (result.ok) {
                        profileId = result.data.profile_id;
                        localStorage.setItem('profileId', profileId);
                        showUserInfoPage();
                    } else {
                        alert('æäº¤å¤±æ•—ï¼š' + result.error);
                    }
                })
                .catch(function(error) {
                    console.error('Setup submission failed:', error);
                    alert('æäº¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
                });
            } catch (error) {
                console.error('Setup submission failed:', error);
                alert('æäº¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
            }
        }
        
        // ç²å–é¸ä¸­çš„åœ‹å®¶
        function getCheckedCountries() {
            var countries = [];
            var checkboxes = document.querySelectorAll('input[name="countries"]:checked');
            for (var i = 0; i < checkboxes.length; i++) {
                countries.push(checkboxes[i].value);
            }
            return countries;
        }

        // ç™¼é€æ¶ˆæ¯
        function sendMessage() {
            var input = document.getElementById('message-input');
            var message = input.value.trim();
            var sendBtn = document.getElementById('send-btn');
            
            if (!message) return;

            // ç¦ç”¨ç™¼é€æŒ‰éˆ•
            sendBtn.disabled = true;
            sendBtn.textContent = currentLanguage === 'en' ? 'Sending...' : 'ç™¼é€ä¸­...';

            // æ·»åŠ ç”¨æˆ¶æ¶ˆæ¯åˆ°èŠå¤©
            addMessage(message, 'user');
            input.value = '';

            // é¡¯ç¤º AI è¼‰å…¥å‹•ç•«
            showAILoading();

            try {
                var authHeader = {};
                var jwt = localStorage.getItem('jwt');
                if (jwt) {
                    authHeader['Authorization'] = 'Bearer ' + jwt;
                }
                
                var headers = {
                    'Content-Type': 'application/json'
                };
                for (var key in authHeader) {
                    headers[key] = authHeader[key];
                }
                
                fetch(window.__CONFIG__.API_BASE + '/chat', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        profile_id: profileId,
                        message: message,
                        user_role: currentRole,
                        language: currentLanguage
                    })
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    // éš±è— AI è¼‰å…¥å‹•ç•«
                    hideAILoading();
                    
                    if (result.ok) {
                        addMessage(result.reply || result.data.response, 'ai');
                    } else {
                        addMessage('æŠ±æ­‰ï¼Œæˆ‘ç„¡æ³•è™•ç†æ‚¨çš„è«‹æ±‚ã€‚è«‹ç¨å¾Œå†è©¦ã€‚', 'ai');
                    }
                })
                .catch(function(error) {
                    console.error('Chat failed:', error);
                    // éš±è— AI è¼‰å…¥å‹•ç•«
                    hideAILoading();
                    addMessage('æŠ±æ­‰ï¼Œç¶²è·¯é€£æ¥å‡ºç¾å•é¡Œã€‚è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£æ¥ã€‚', 'ai');
                })
                .finally(function() {
                    // é‡æ–°å•Ÿç”¨ç™¼é€æŒ‰éˆ•
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<span data-zh="é€å‡º" data-en="Send">é€å‡º</span>';
                });
            } catch (error) {
                console.error('Chat failed:', error);
                // éš±è— AI è¼‰å…¥å‹•ç•«
                hideAILoading();
                addMessage('æŠ±æ­‰ï¼Œç¶²è·¯é€£æ¥å‡ºç¾å•é¡Œã€‚è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£æ¥ã€‚', 'ai');
                
                // é‡æ–°å•Ÿç”¨ç™¼é€æŒ‰éˆ•
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<span data-zh="é€å‡º" data-en="Send">é€å‡º</span>';
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©
        function addMessage(message, sender, shouldScroll = true) {
            var chatContainer = document.getElementById('chat-container');
            var messageWrapper = document.createElement('div');
            
            var currentTime = new Date().toLocaleTimeString('zh-TW', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            if (sender === 'user') {
                messageWrapper.className = 'flex justify-end mb-4';
                messageWrapper.innerHTML = 
                    '<div class="max-w-xs sm:max-w-sm md:max-w-md bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-800 rounded-lg p-4 shadow-sm">' +
                        '<div class="text-sm leading-relaxed">' + message + '</div>' +
                        '<div class="text-xs text-gray-600 mt-2">' + currentTime + '</div>' +
                    '</div>';
            } else {
                messageWrapper.className = 'mb-4';
                var aiTitle = currentLanguage === 'en' ? 'AI Study Abroad Advisor' : 'AI ç•™å­¸é¡§å•';
                var aiSubtitle = currentLanguage === 'en' ? 'Your Exclusive Study Abroad Planning Expert' : 'æ‚¨çš„å°ˆå±¬ç•™å­¸è¦åŠƒå°ˆå®¶';
                
                messageWrapper.innerHTML = 
                    '<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">' +
                        '<div class="flex items-center mb-4">' +
                            '<div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">AI</div>' +
                            '<div>' +
                                '<h3 class="font-semibold text-gray-800">' + aiTitle + '</h3>' +
                                '<p class="text-sm text-gray-500">' + aiSubtitle + '</p>' +
                            '</div>' +
                        '</div>' +
                        '<div class="text-gray-700 leading-relaxed message-content">' + message + '</div>' +
                        '<div class="text-xs text-gray-400 mt-3">' + currentTime + '</div>' +
                    '</div>';
            }
            
            chatContainer.appendChild(messageWrapper);
            
            if (shouldScroll) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            // å„²å­˜åˆ°èŠå¤©æ­·å²
            saveChatHistory(message, sender);
        }

        // ç™¼é€æ­¡è¿è¨Šæ¯
        function sendWelcomeMessage() {
            if (!profileId) return;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰èŠå¤©æ­·å²
            var chatHistory = localStorage.getItem('chatHistory_' + profileId);
            if (chatHistory) {
                var messages = JSON.parse(chatHistory);
                if (messages.length > 0) {
                    // æœ‰èŠå¤©æ­·å²ï¼Œä¸ç™¼é€æ­¡è¿è¨Šæ¯
                    return;
                }
            }
            
            // é¡¯ç¤º AI è¼‰å…¥å‹•ç•«
            showAILoading();
            
            try {
                var authHeader = {};
                var jwt = localStorage.getItem('jwt');
                if (jwt) {
                    authHeader['Authorization'] = 'Bearer ' + jwt;
                }
                
                var headers = {
                    'Content-Type': 'application/json'
                };
                for (var key in authHeader) {
                    headers[key] = authHeader[key];
                }
                
                fetch(window.__CONFIG__.API_BASE + '/chat', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        profile_id: profileId,
                        message: '', // ç©ºè¨Šæ¯è§¸ç™¼æ­¡è¿å›è¦†
                        user_role: currentRole,
                        language: currentLanguage
                    })
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    // éš±è— AI è¼‰å…¥å‹•ç•«
                    hideAILoading();
                    
                    if (result.ok) {
                        addMessage(result.reply || result.data.response, 'ai');
                    } else {
                        console.error('Welcome message failed:', result);
                        // å¦‚æœ API å¤±æ•—ï¼Œé¡¯ç¤ºé è¨­æ­¡è¿è¨Šæ¯
                        var welcomeText = currentLanguage === 'en' ? 
                            'ğŸ“ Hello! I am your AI Study Abroad Advisor.\n\nI have reviewed your basic information, now let\'s dive deep into your study abroad planning!\n\nYou can ask me any questions about studying abroad, such as:\n\nâ€¢ School and major recommendations\nâ€¢ Application timeline planning\nâ€¢ Scholarship opportunities\nâ€¢ Visa and accommodation guidance\n\nWhat would you like to know first?' :
                            'ğŸ“ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIç•™å­¸é¡§å•ã€‚\n\næˆ‘å·²ç¶“äº†è§£äº†æ‚¨çš„åŸºæœ¬è³‡è¨Šï¼Œç¾åœ¨è®“æˆ‘å€‘æ·±å…¥è¨è«–æ‚¨çš„ç•™å­¸è¨ˆåŠƒå§ï¼\n\næ‚¨å¯ä»¥å•æˆ‘ä»»ä½•é—œæ–¼ç•™å­¸çš„å•é¡Œï¼Œæ¯”å¦‚ï¼š\n\nâ€¢ æ¨è–¦é©åˆçš„å­¸æ ¡å’Œå°ˆæ¥­\nâ€¢ ç”³è«‹æ™‚é–“è¦åŠƒ\nâ€¢ çå­¸é‡‘ç”³è«‹å»ºè­°\nâ€¢ ç°½è­‰èˆ‡ä½å®¿è³‡è¨Š\n\næ‚¨æƒ³å…ˆäº†è§£å“ªå€‹éƒ¨åˆ†å‘¢ï¼Ÿ';
                        addMessage(welcomeText, 'ai');
                    }
                })
                .catch(function(error) {
                    console.error('Welcome message error:', error);
                    // éš±è— AI è¼‰å…¥å‹•ç•«
                    hideAILoading();
                    
                    // å¦‚æœ API å¤±æ•—ï¼Œé¡¯ç¤ºé è¨­æ­¡è¿è¨Šæ¯
                    var welcomeText = currentLanguage === 'en' ? 
                        'ğŸ“ Hello! I am your AI Study Abroad Advisor.\n\nI have reviewed your basic information, now let\'s dive deep into your study abroad planning!\n\nYou can ask me any questions about studying abroad, such as:\n\nâ€¢ School and major recommendations\nâ€¢ Application timeline planning\nâ€¢ Scholarship opportunities\nâ€¢ Visa and accommodation guidance\n\nWhat would you like to know first?' :
                        'ğŸ“ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIç•™å­¸é¡§å•ã€‚\n\næˆ‘å·²ç¶“äº†è§£äº†æ‚¨çš„åŸºæœ¬è³‡è¨Šï¼Œç¾åœ¨è®“æˆ‘å€‘æ·±å…¥è¨è«–æ‚¨çš„ç•™å­¸è¨ˆåŠƒå§ï¼\n\næ‚¨å¯ä»¥å•æˆ‘ä»»ä½•é—œæ–¼ç•™å­¸çš„å•é¡Œï¼Œæ¯”å¦‚ï¼š\n\nâ€¢ æ¨è–¦é©åˆçš„å­¸æ ¡å’Œå°ˆæ¥­\nâ€¢ ç”³è«‹æ™‚é–“è¦åŠƒ\nâ€¢ çå­¸é‡‘ç”³è«‹å»ºè­°\nâ€¢ ç°½è­‰èˆ‡ä½å®¿è³‡è¨Š\n\næ‚¨æƒ³å…ˆäº†è§£å“ªå€‹éƒ¨åˆ†å‘¢ï¼Ÿ';
                    addMessage(welcomeText, 'ai');
                });
            } catch (error) {
                console.error('Welcome message error:', error);
                // éš±è— AI è¼‰å…¥å‹•ç•«
                hideAILoading();
            }
        }

        // è¼‰å…¥å¿«é€Ÿå•ç­”æŒ‰éˆ•ï¼ˆä¾èº«ä»½ï¼‰
        function loadQuickActions() {
            var qa = document.getElementById('quick-actions');
            if (!qa) return;
            qa.innerHTML = '';
            
            var studentBtns = [
                { zh: 'å­¸æ ¡æ¨è–¦', en: 'School Recommendations', q: 'æ ¹æ“šæˆ‘çš„èƒŒæ™¯æ¨è–¦é©åˆçš„å­¸æ ¡å’Œç§‘ç³»', q_en: 'Recommend suitable schools and majors based on my background' },
                { zh: 'ç”³è«‹è¦åŠƒ', en: 'Application Planning', q: 'è«‹å¹«æˆ‘è¦åŠƒå®Œæ•´çš„ç”³è«‹æ™‚é–“è¡¨å’Œæµç¨‹', q_en: 'Please help me plan a complete application timeline and process' },
                { zh: 'çå­¸é‡‘ç”³è«‹', en: 'Scholarship Application', q: 'æœ‰å“ªäº›é©åˆæˆ‘çš„çå­¸é‡‘å¯ä»¥ç”³è«‹ï¼Ÿ', q_en: 'What scholarships are suitable for me to apply for?' },
                { zh: 'ç°½è­‰æŒ‡å°', en: 'Visa Guidance', q: 'å­¸ç”Ÿç°½è­‰ç”³è«‹æµç¨‹å’Œæ³¨æ„äº‹é …', q_en: 'Student visa application process and important notes' },
                { zh: 'ä½å®¿å»ºè­°', en: 'Housing Advice', q: 'æµ·å¤–ä½å®¿é¸æ“‡å’Œæ³¨æ„äº‹é …', q_en: 'Overseas accommodation options and considerations' },
                { zh: 'èªè¨€æº–å‚™', en: 'Language Preparation', q: 'èªè¨€è€ƒè©¦æº–å‚™å’Œæˆç¸¾è¦æ±‚', q_en: 'Language test preparation and score requirements' }
            ];
            var parentBtns = [
                { zh: 'è²»ç”¨è¦åŠƒ', en: 'Cost Planning', q: 'ä¸€å¹´ç¸½è²»ç”¨é ä¼°èˆ‡é ç®—å»ºè­°', q_en: 'Annual total cost estimation and budget recommendations' },
                { zh: 'æŠ•è³‡å›å ±', en: 'ROI Analysis', q: 'å¹«æˆ‘ä¼°ç®—ä¸åŒæ–¹æ¡ˆçš„æŠ•è³‡å›æ”¶æœŸ', q_en: 'Help me estimate the ROI for different options' },
                { zh: 'å®‰å…¨è€ƒé‡', en: 'Safety Considerations', q: 'æµ·å¤–ç•™å­¸å®‰å…¨æ³¨æ„äº‹é …', q_en: 'Safety considerations for studying abroad' },
                { zh: 'ä¿éšªè¦åŠƒ', en: 'Insurance Planning', q: 'ç•™å­¸ä¿éšªé¸æ“‡å’Œè¦åŠƒ', q_en: 'Study abroad insurance options and planning' },
                { zh: 'å°±æ¥­å‰æ™¯', en: 'Career Prospects', q: 'ç•¢æ¥­å¾Œå°±æ¥­å‰æ™¯å’Œç™¼å±•', q_en: 'Career prospects and development after graduation' },
                { zh: 'æ–‡åŒ–é©æ‡‰', en: 'Cultural Adaptation', q: 'å¦‚ä½•å¹«åŠ©å­©å­é©æ‡‰æµ·å¤–æ–‡åŒ–', q_en: 'How to help children adapt to overseas culture' }
            ];
            
            var buttons = currentRole === 'parent' ? parentBtns : studentBtns;
            
            for (var i = 0; i < buttons.length; i++) {
                var btn = buttons[i];
                var label = currentLanguage === 'en' ? btn.en : btn.zh;
                var question = currentLanguage === 'en' ? btn.q_en : btn.q;
                
                var button = document.createElement('button');
                button.type = 'button';
                button.className = 'px-4 py-3 text-sm bg-white hover:bg-gray-50 rounded-lg border border-gray-200 shadow-sm transition-colors text-gray-700 font-medium';
                button.textContent = label;
                button.onclick = function(questionText) {
                    return function() {
                        document.getElementById('message-input').value = questionText;
                        sendMessage();
                    };
                }(question);
                qa.appendChild(button);
            }
        }
        
        // æ™ºèƒ½ç™»å…¥æµç¨‹æª¢æŸ¥
        function checkUserProfileStatus() {
            try {
                var jwt = localStorage.getItem('jwt');
                if (!jwt) {
                    showLoginPage();
                    return;
                }
                
                fetch(window.__CONFIG__.API_BASE + '/user/check-profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + jwt,
                        'Content-Type': 'application/json'
                    }
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    if (result.ok && result.has_profile) {
                        // æœ‰ profile è³‡æ–™ï¼Œé¡¯ç¤ºç”¨æˆ¶è³‡è¨Šé é¢
                        profileId = result.profile_id;
                        localStorage.setItem('profileId', profileId);
                        showUserInfoPage();
                    } else {
                        // æ²’æœ‰ profile è³‡æ–™ï¼Œè·³è½‰åˆ°è¨­å®šé é¢
                        showSetupPage();
                    }
                })
                .catch(function(error) {
                    console.error('æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹å¤±æ•—:', error);
                    showLoginPage();
                });
            } catch (error) {
                console.error('æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹å¤±æ•—:', error);
                showLoginPage();
            }
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        window.onload = function() {
            // æª¢æŸ¥æœ¬åœ°å„²å­˜çš„ profileId
            var storedProfileId = localStorage.getItem('profileId');
            if (storedProfileId) {
                profileId = storedProfileId;
            }
            
            // æª¢æŸ¥ URL åƒæ•¸ä¸­çš„ token
            var urlParams = new URLSearchParams(window.location.search);
            var token = urlParams.get('token');
            var error = urlParams.get('error');
            
            // è™•ç†ç™»å…¥éŒ¯èª¤
            if (error) {
                var errorMessage = '';
                switch(error) {
                    case 'missing_code':
                        errorMessage = currentLanguage === 'en' ? 'Login failed: Missing authorization code' : 'ç™»å…¥å¤±æ•—ï¼šç¼ºå°‘æˆæ¬Šç¢¼';
                        break;
                    case 'token_exchange_failed':
                        errorMessage = currentLanguage === 'en' ? 'Login failed: Token exchange failed' : 'ç™»å…¥å¤±æ•—ï¼šä»¤ç‰Œäº¤æ›å¤±æ•—';
                        break;
                    case 'user_info_failed':
                        errorMessage = currentLanguage === 'en' ? 'Login failed: Unable to get user information' : 'ç™»å…¥å¤±æ•—ï¼šç„¡æ³•ç²å–ç”¨æˆ¶è³‡è¨Š';
                        break;
                    case 'callback_failed':
                        errorMessage = currentLanguage === 'en' ? 'Login failed: Callback processing failed' : 'ç™»å…¥å¤±æ•—ï¼šå›èª¿è™•ç†å¤±æ•—';
                        break;
                    default:
                        errorMessage = currentLanguage === 'en' ? 'Login failed: ' + error : 'ç™»å…¥å¤±æ•—ï¼š' + error;
                }
                alert(errorMessage);
                // æ¸…é™¤ URL åƒæ•¸
                window.history.replaceState({}, document.title, window.location.pathname);
                showLoginPage();
                return;
            }
            
            if (token) {
                // å„²å­˜ token ä¸¦æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹
                localStorage.setItem('jwt', token);
                
                // å„²å­˜ç”¨æˆ¶è³‡æ–™åˆ° localStorage
                var userInfo = urlParams.get('user');
                if (userInfo) {
                    try {
                        var user = JSON.parse(decodeURIComponent(userInfo));
                        localStorage.setItem('userProfile', JSON.stringify(user));
                    } catch (e) {
                        console.error('è§£æç”¨æˆ¶è³‡æ–™å¤±æ•—:', e);
                    }
                }
                
                // æ™ºèƒ½æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹
                checkUserProfileStatus();
                
                // æ¸…é™¤ URL åƒæ•¸
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                // æª¢æŸ¥æœ¬åœ°å„²å­˜çš„ token
                var storedToken = localStorage.getItem('jwt');
                if (storedToken) {
                    // é©—è­‰ token æ˜¯å¦æœ‰æ•ˆä¸¦æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹
                    validateTokenAndCheckProfile(storedToken);
                } else {
                    showLoginPage();
                }
            }
        };

        // é©—è­‰ token ä¸¦æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹
        function validateTokenAndCheckProfile(token) {
            try {
                var parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid token format');
                }
                
                // æª¢æŸ¥ token æ˜¯å¦éæœŸï¼ˆç°¡å–®æª¢æŸ¥ï¼‰
                var payload = JSON.parse(atob(parts[1]));
                var currentTime = Math.floor(Date.now() / 1000);
                
                if (payload.exp && payload.exp < currentTime) {
                    throw new Error('Token expired');
                }
                
                // Token æœ‰æ•ˆï¼Œæª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹
                checkUserProfileStatus();
            } catch (error) {
                console.log('Token validation failed:', error);
                // Token ç„¡æ•ˆï¼Œæ¸…é™¤ä¸¦é¡¯ç¤ºç™»å…¥é é¢
                localStorage.removeItem('jwt');
                localStorage.removeItem('profileId');
                localStorage.removeItem('userProfile');
                showLoginPage();
            }
        }
    </script>
</body>
</html>
