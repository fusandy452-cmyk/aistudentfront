<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI ç•™å­¸é¡§å•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // èª¿è©¦æ¨¡å¼é–‹é—œ (æŒ‰ Ctrl+Shift+D é–‹å•Ÿ)
        window.DEBUG_MODE = false;
        
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                window.DEBUG_MODE = !window.DEBUG_MODE;
                toggleDebugPanel();
            }
        });
        
        function toggleDebugPanel() {
            let panel = document.getElementById('debug-panel');
            if (!panel) {
                createDebugPanel();
            } else {
                panel.style.display = window.DEBUG_MODE ? 'block' : 'none';
            }
        }
        
        function createDebugPanel() {
            const panel = document.createElement('div');
            panel.id = 'debug-panel';
            panel.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                width: 400px;
                max-height: 500px;
                background: #f0f0f0;
                border: 2px solid #333;
                border-radius: 8px;
                padding: 15px;
                font-family: monospace;
                font-size: 12px;
                z-index: 10000;
                overflow-y: auto;
                display: ${window.DEBUG_MODE ? 'block' : 'none'};
            `;
            
            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin: 0; color: #333;">ğŸ”§ èª¿è©¦é¢æ¿</h3>
                    <button onclick="clearDebugInfo()" style="padding: 2px 6px; font-size: 10px;">æ¸…é™¤</button>
                </div>
                <div id="debug-info" style="background: white; padding: 10px; border-radius: 4px; min-height: 200px; max-height: 300px; overflow-y: auto;"></div>
                <div style="margin-top: 10px;">
                    <button onclick="testGoogleAPI()" style="padding: 4px 8px; margin: 2px; font-size: 10px;">æ¸¬è©¦ Google API</button>
                    <button onclick="testBackendConfig()" style="padding: 4px 8px; margin: 2px; font-size: 10px;">æ¸¬è©¦å¾Œç«¯</button>
                    <button onclick="testGoogleLogin()" style="padding: 4px 8px; margin: 2px; font-size: 10px;">æ¸¬è©¦ç™»å…¥</button>
                </div>
                <div style="margin-top: 5px; font-size: 10px; color: #666;">
                    æŒ‰ Ctrl+Shift+D åˆ‡æ›èª¿è©¦é¢æ¿
                </div>
            `;
            
            document.body.appendChild(panel);
            
            // æ·»åŠ èª¿è©¦å‡½æ•¸
            window.addDebugInfo = function(message) {
                const debugInfo = document.getElementById('debug-info');
                if (!debugInfo) return;
                
                const div = document.createElement('div');
                div.textContent = new Date().toLocaleTimeString() + ': ' + message;
                debugInfo.appendChild(div);
                debugInfo.scrollTop = debugInfo.scrollHeight;
                console.log('[DEBUG]', message);
            };
            
            window.clearDebugInfo = function() {
                const debugInfo = document.getElementById('debug-info');
                if (debugInfo) debugInfo.innerHTML = '';
            };
            
            window.testGoogleAPI = function() {
                addDebugInfo('æ¸¬è©¦ Google API è¼‰å…¥ç‹€æ…‹...');
                
                if (typeof google !== 'undefined') {
                    addDebugInfo('âœ“ Google API å·²è¼‰å…¥');
                    if (google.accounts) {
                        addDebugInfo('âœ“ Google Accounts API å¯ç”¨');
                    } else {
                        addDebugInfo('âœ— Google Accounts API ä¸å¯ç”¨');
                    }
                } else {
                    addDebugInfo('âœ— Google API æœªè¼‰å…¥');
                }
            };
            
            window.testBackendConfig = function() {
                addDebugInfo('æ¸¬è©¦å¾Œç«¯é…ç½®...');
                
                fetch(window.__CONFIG__.API_BASE + '/api/v1/auth/config')
                    .then(r => r.json())
                    .then(cfg => {
                        addDebugInfo('å¾Œç«¯é…ç½®éŸ¿æ‡‰: ' + JSON.stringify(cfg));
                        
                        if (cfg && cfg.ok && cfg.google && cfg.google.client_id) {
                            addDebugInfo('âœ“ Google Client ID é…ç½®æ­£ç¢º: ' + cfg.google.client_id);
                            window.__GOOGLE_CLIENT_ID__ = cfg.google.client_id;
                        } else {
                            addDebugInfo('âœ— Google Client ID é…ç½®æœ‰å•é¡Œ');
                        }
                    })
                    .catch(error => {
                        addDebugInfo('âœ— å¾Œç«¯é…ç½®è«‹æ±‚å¤±æ•—: ' + error.message);
                    });
            };
            
            window.testGoogleLogin = function() {
                addDebugInfo('æ¸¬è©¦ Google ç™»å…¥ï¼ˆå½ˆå‡ºè¦–çª—æ¨¡å¼ï¼‰...');
                
                const clientId = window.__GOOGLE_CLIENT_ID__ || '300123710303-m4j1laa65p664n5vtrdkfvfa7b42c2o6.apps.googleusercontent.com';
                addDebugInfo('ä½¿ç”¨ Client ID: ' + clientId);
                
                const googleAuthUrl = 'https://accounts.google.com/o/oauth2/v2/auth?' +
                    'client_id=' + clientId + '&' +
                    'redirect_uri=https://aistudentbackend.zeabur.app/auth/google/callback&' +
                    'response_type=code&' +
                    'scope=openid email profile&' +
                    'state=popup_login';
                
                addDebugInfo('Google ç™»å…¥ URL: ' + googleAuthUrl);
                
                // æ‰“é–‹å½ˆå‡ºè¦–çª—
                const popup = window.open(
                    googleAuthUrl,
                    'googleLogin',
                    'width=500,height=600,scrollbars=yes,resizable=yes'
                );
                
                if (!popup) {
                    addDebugInfo('âœ— å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹');
                    return;
                }
                
                addDebugInfo('âœ“ å½ˆå‡ºè¦–çª—å·²æ‰“é–‹');
            };
        }
    </script>
    <script>
        // å…§åµŒé…ç½®
        window.__CONFIG__ = {
            API_BASE: 'https://aistudentbackend.zeabur.app',
            // æš«æ™‚ä½¿ç”¨æ¸¬è©¦æ¨¡å¼ï¼Œè·³éå¾Œç«¯é©—è­‰
            TEST_MODE: true
        };
        
        // LINE Login é…ç½®
        window.__LINE_CHANNEL_ID__ = '2008117059'; // æ‚¨çš„ LINE Channel ID
        
        // LINE ç™»å…¥é…ç½®ï¼ˆæ‚¨çš„ Channel æ˜¯ Messaging API é¡å‹ï¼Œä½¿ç”¨æ¨™æº– OAuthï¼‰
        
        // Google OAuth é…ç½®
        window.__GOOGLE_CLIENT_ID__ = '300123710303-m4j1laa65p664n5vtrdkfvfa7b42c2o6.apps.googleusercontent.com';
    </script>
    <style>
        /* è‡ªå®šç¾©æ¨£å¼ */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        /* æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
        @media (max-width: 768px) {
            .mobile-optimized {
                font-size: 16px !important; /* é˜²æ­¢ iOS è‡ªå‹•ç¸®æ”¾ */
                -webkit-text-size-adjust: 100%;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
        }
        
        /* iOS Safari æŒ‰éˆ•å…¼å®¹æ€§ä¿®å¾© */
        button {
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        #back-to-setup {
            min-width: 44px;
            min-height: 44px;
            z-index: 10;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            position: absolute !important;
            left: 1rem !important;
            top: 1rem !important;
        }
        
        /* ç¢ºä¿æŒ‰éˆ•åœ¨ iOS Safari ä¸­å¯é»æ“Š */
        #back-to-setup::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            z-index: -1;
        }
        
        /* ç¢ºä¿æŒ‰éˆ•æ–‡å­—æ¨£å¼æ­£ç¢º */
        #back-to-setup span {
            display: inline-block;
            font-size: 14px;
            font-weight: 500;
        }
            
            .mobile-button {
                pointer-events: auto !important;
                -webkit-user-select: none;
                user-select: none;
                min-height: 44px !important; /* iOS å»ºè­°çš„æœ€å°è§¸æ§å€åŸŸ */
                padding: 12px 16px !important;
                font-size: 16px !important;
            }
            
            .mobile-input {
                font-size: 16px !important; /* é˜²æ­¢ iOS è‡ªå‹•ç¸®æ”¾ */
                padding: 12px 16px !important;
                min-height: 44px !important;
            }
            
            .mobile-text {
                font-size: 16px !important;
                line-height: 1.5 !important;
            }
            
            /* é˜²æ­¢é›™æ“Šç¸®æ”¾ */
            * {
                touch-action: manipulation;
            }
            
            /* å„ªåŒ–èŠå¤©ä»‹é¢ */
            .chat-container {
                height: calc(100vh - 120px) !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            /* AI è¼‰å…¥å‹•ç•« */
            @keyframes ai-loading-bounce {
                0%, 80%, 100% {
                    transform: scale(0);
                    opacity: 0.5;
                }
                40% {
                    transform: scale(1);
                    opacity: 1;
                }
            }
            
            .ai-loading-dot {
                animation: ai-loading-bounce 1.4s infinite ease-in-out both;
            }
            
            .ai-loading-dot:nth-child(1) {
                animation-delay: -0.32s;
            }
            
            .ai-loading-dot:nth-child(2) {
                animation-delay: -0.16s;
            }
            
            .message-bubble {
                max-width: 85% !important;
                word-wrap: break-word !important;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .hidden { display: none; }
        .block { display: block; }
        
        .message-bubble {
            @apply max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg px-4 py-3 rounded-2xl relative shadow-sm;
            word-wrap: break-word;
        }
        
        .message-user {
            @apply bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-800 ml-auto;
            margin-left: auto;
            margin-right: 0;
        }
        
        .message-user::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: -8px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-left-color: #fbbf24;
            border-bottom: none;
            border-right: none;
        }
        
        .message-ai {
            @apply bg-white text-gray-800 mr-auto border border-gray-200;
            margin-left: 0;
            margin-right: auto;
        }
        
        .message-ai::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: -8px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-right-color: white;
            border-bottom: none;
            border-left: none;
        }
        
        .message-ai::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -9px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-right-color: #e5e7eb;
            border-bottom: none;
            border-left: none;
        }
        
        .message-time {
            @apply text-xs text-gray-500 mt-1;
        }
        
        .message-avatar {
            @apply w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white;
        }
        
        .avatar-ai {
            @apply bg-gradient-to-r from-blue-500 to-blue-600;
        }
        
        .avatar-user {
            @apply bg-gradient-to-r from-yellow-500 to-yellow-600;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">
    <!-- ç™»å…¥é é¢ -->
    <div id="login-page" class="min-h-screen flex flex-col items-center justify-center p-4 bg-gradient-to-br from-yellow-100 to-blue-100">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full text-center fade-in">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-4" data-zh="AI ç•™å­¸é¡§å•" data-en="AI Study Abroad Advisor">AI ç•™å­¸é¡§å•</h1>
            <p class="text-lg text-gray-600 mb-8" data-zh="æ‚¨çš„å€‹äººåŒ–ç•™å­¸è¦åŠƒå°ˆå®¶" data-en="Your Personalized Study Abroad Planning Expert">æ‚¨çš„å€‹äººåŒ–ç•™å­¸è¦åŠƒå°ˆå®¶</p>
            
            <div id="auth-section" class="mb-6">
                <div id="user-info" class="hidden mb-4">
                    <img id="user-avatar" class="w-16 h-16 rounded-full mx-auto mb-2" src="" alt="User Avatar">
                    <p class="text-xl font-semibold">æ­¡è¿ï¼Œ<span id="user-name"></span>!</p>
                    <div class="flex flex-col space-y-2 mt-4">
                        <button onclick="continueToChat()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium shadow-md">
                            <span data-zh="ç¹¼çºŒè·ŸAIç•™å­¸é¡§å•è«®è©¢" data-en="Continue with AI Study Advisor">ç¹¼çºŒè·ŸAIç•™å­¸é¡§å•è«®è©¢</span>
                        </button>
                        <button onclick="openUserSettings()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                            <span data-zh="ç”¨æˆ¶è¨­å®š" data-en="User Settings">ç”¨æˆ¶è¨­å®š</span>
                        </button>
                        <button onclick="logout()" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                            <span data-zh="ç™»å‡º" data-en="Logout">ç™»å‡º</span>
                        </button>
                    </div>
                </div>
                <div id="login-buttons">
                    <p class="text-gray-700 mb-4" data-zh="è«‹ç™»å…¥ä»¥ç¹¼çºŒ" data-en="Please login to continue">è«‹ç™»å…¥ä»¥ç¹¼çºŒ</p>
                    <button onclick="skipLogin()" class="w-full flex items-center justify-center px-4 py-3 mb-3 bg-yellow-400 text-gray-800 rounded-lg hover:bg-yellow-500 transition-colors font-medium shadow-md mobile-button mobile-optimized">
                        <span data-zh="è·³éç™»å…¥ï¼Œç›´æ¥é–‹å§‹" data-en="Skip login, start directly">è·³éç™»å…¥ï¼Œç›´æ¥é–‹å§‹</span>
                    </button>
                    <button onclick="loginWithGoogle()" id="google-login-btn" class="w-full flex items-center justify-center px-4 py-3 mb-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium shadow-md mobile-button mobile-optimized">
                        <img src="https://img.icons8.com/color/24/000000/google-logo.png" alt="Google" class="w-5 h-5 mr-2">
                        <span data-zh="ä½¿ç”¨ Google ç™»å…¥" data-en="Login with Google">ä½¿ç”¨ Google ç™»å…¥</span>
                    </button>
                    <button onclick="loginWithLINE()" class="w-full flex items-center justify-center px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium shadow-md mobile-button mobile-optimized">
                        <img src="https://img.icons8.com/color/24/000000/line-me.png" alt="LINE" class="w-5 h-5 mr-2">
                        <span data-zh="ä½¿ç”¨ LINE ç™»å…¥" data-en="Login with LINE">ä½¿ç”¨ LINE ç™»å…¥</span>
                    </button>
                    <div class="text-xs text-gray-500 mt-2 text-center" data-zh="æ”¯æ´ Google å’Œ LINE ç™»å…¥" data-en="Support Google and LINE login">æ”¯æ´ Google å’Œ LINE ç™»å…¥</div>
                </div>
            </div>


            <!-- èªè¨€åˆ‡æ› -->
            <div class="mt-6 flex justify-center space-x-4">
                <button onclick="switchLanguage('zh')" id="lang-switch-zh" 
                        class="px-4 py-2 text-sm rounded-lg bg-blue-500 text-white transition-colors">
                    ä¸­æ–‡
                </button>
                <button onclick="switchLanguage('en')" id="lang-switch-en" 
                        class="px-4 py-2 text-sm rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">
                    English
                </button>
            </div>
        </div>
    </div>

    <!-- è¨­å®šé é¢ -->
    <div id="setup-page" class="min-h-screen hidden">
        <div class="max-w-2xl mx-auto bg-white min-h-screen">
            <header class="bg-gradient-to-r from-yellow-400 to-yellow-300 text-gray-800 p-4 sm:p-6 relative">
                <button id="back-to-home" class="absolute left-2 sm:left-4 top-4 sm:top-6 text-gray-800 hover:text-gray-600 transition-colors text-sm sm:text-base z-10">
                    <span data-zh="â† Back" data-en="â† Back">â† Back</span>
                </button>
                <div class="text-center px-12 sm:px-0">
                    <h1 class="text-base sm:text-xl lg:text-2xl font-bold mb-1 sm:mb-2 leading-tight" data-zh="è¨­å®šæ‚¨çš„ç•™å­¸éœ€æ±‚" data-en="Set Your Study Abroad Requirements">è¨­å®šæ‚¨çš„ç•™å­¸éœ€æ±‚</h1>
                    <p class="text-gray-600 text-xs sm:text-base leading-tight" data-zh="è®“æˆ‘å€‘å…ˆäº†è§£æ‚¨çš„åŸºæœ¬è³‡è¨Š" data-en="Let us understand your basic information first">è®“æˆ‘å€‘å…ˆäº†è§£æ‚¨çš„åŸºæœ¬è³‡è¨Š</p>
                </div>
            </header>

            <!-- Setup Form -->
            <main class="p-6">
                <form id="setup-form" class="space-y-6">
                    <!-- å€‹äººåŸºæœ¬è³‡è¨Š -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">1</span>
                                <span data-zh="å€‹äººåŸºæœ¬è³‡è¨Š" data-en="Personal Information">å€‹äººåŸºæœ¬è³‡è¨Š</span>
                            </div>
                        </h3>
                        <div id="student-fields" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å­¸ç”Ÿå§“å *" data-en="Student Name *">å­¸ç”Ÿå§“å *</label>
                                <input type="text" id="student_name" name="student_name" required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="ä¾‹å¦‚ï¼šç‹å°æ˜" data-en-ph="e.g., David Wang" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å­¸ç”Ÿé›»å­éƒµä»¶ *" data-en="Student Email *">å­¸ç”Ÿé›»å­éƒµä»¶ *</label>
                                <input type="email" id="student_email" name="student_email" required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="ä¾‹å¦‚ï¼šdavid@example.com" data-en-ph="e.g., david@example.com" placeholder="ä¾‹å¦‚ï¼šdavid@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="åœ‹ç± *" data-en="Citizenship *">åœ‹ç± *</label>
                                <input type="text" id="citizenship" name="citizenship" required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="ä¾‹å¦‚ï¼šå°ç£" data-en-ph="e.g., Taiwan" placeholder="ä¾‹å¦‚ï¼šå°ç£">
                            </div>
                        </div>
                        <div id="parent-fields" class="space-y-4 hidden">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å®¶é•·å§“å *" data-en="Parent Name *">å®¶é•·å§“å *</label>
                                <input type="text" id="parent_name" name="parent_name"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="ä¾‹å¦‚ï¼šç‹åª½åª½" data-en-ph="e.g., Alice Wang" placeholder="ä¾‹å¦‚ï¼šç‹åª½åª½">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å®¶é•·é›»å­éƒµä»¶ *" data-en="Parent Email *">å®¶é•·é›»å­éƒµä»¶ *</label>
                                <input type="email" id="parent_email" name="parent_email"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="ä¾‹å¦‚ï¼šparent@example.com" data-en-ph="e.g., parent@example.com" placeholder="ä¾‹å¦‚ï¼šparent@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="èˆ‡å­¸ç”Ÿé—œä¿‚ *" data-en="Relationship to Student *">èˆ‡å­¸ç”Ÿé—œä¿‚ *</label>
                                <input type="text" id="relationship" name="relationship"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="ä¾‹å¦‚ï¼šæ¯è¦ª / çˆ¶è¦ª" data-en-ph="e.g., Mother / Father" placeholder="ä¾‹å¦‚ï¼šæ¯è¦ª">
                            </div>
                            <div class="border-t pt-4">
                                <p class="text-sm text-gray-500 mb-2" data-zh="å­¸ç”Ÿè¯çµ¡è³‡æ–™" data-en="Student Contact">å­¸ç”Ÿè¯çµ¡è³‡æ–™</p>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å­¸ç”Ÿå§“å *" data-en="Student Name *">å­¸ç”Ÿå§“å *</label>
                                <input type="text" id="child_name" name="child_name"
                                    class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    data-zh-ph="ä¾‹å¦‚ï¼šç‹å°æ˜" data-en-ph="e.g., David Wang" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜">
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å­¸ç”Ÿé›»å­éƒµä»¶ *" data-en="Student Email *">å­¸ç”Ÿé›»å­éƒµä»¶ *</label>
                                <input type="email" id="child_email" name="child_email"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="ä¾‹å¦‚ï¼šdavid@example.com" data-en-ph="e.g., david@example.com" placeholder="ä¾‹å¦‚ï¼šdavid@example.com">
                            </div>
                        </div>
                    </div>

                    <!-- å­¸è¡“èƒŒæ™¯ -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">2</span>
                                <span data-zh="å­¸è¡“èƒŒæ™¯" data-en="Academic Background">å­¸è¡“èƒŒæ™¯</span>
                            </div>
                        </h3>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="GPA (æ»¿åˆ†4.0) *" data-en="GPA (out of 4.0) *">GPA (æ»¿åˆ†4.0) *</label>
                            <input type="number" id="gpa" name="gpa" step="0.1" min="0" max="4" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                data-zh-ph="ä¾‹å¦‚ï¼š3.8" data-en-ph="e.g., 3.8" placeholder="ä¾‹å¦‚ï¼š3.8">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="ç›®æ¨™å­¸ä½ *" data-en="Target Degree *">ç›®æ¨™å­¸ä½ *</label>
                            <select id="degree" name="degree" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized">
                                <option value="" data-zh="è«‹é¸æ“‡" data-en="Please select">è«‹é¸æ“‡</option>
                                <option value="bachelor" data-zh="å­¸å£«" data-en="Bachelor's">å­¸å£«</option>
                                <option value="master" data-zh="ç¢©å£«" data-en="Master's">ç¢©å£«</option>
                                <option value="phd" data-zh="åšå£«" data-en="PhD">åšå£«</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="ç›®æ¨™åœ‹å®¶ *" data-en="Target Countries *">ç›®æ¨™åœ‹å®¶ *</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center">
                                    <input type="checkbox" name="countries" value="us" class="mr-2">
                                    <span data-zh="ç¾åœ‹" data-en="USA">ç¾åœ‹</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="countries" value="uk" class="mr-2">
                                    <span data-zh="è‹±åœ‹" data-en="UK">è‹±åœ‹</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="countries" value="ca" class="mr-2">
                                    <span data-zh="åŠ æ‹¿å¤§" data-en="Canada">åŠ æ‹¿å¤§</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- é ç®—å’Œæ™‚é–“ -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">3</span>
                                <span data-zh="é ç®—å’Œæ™‚é–“" data-en="Budget and Time">é ç®—å’Œæ™‚é–“</span>
                            </div>
                        </h3>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="é ç®— (æ¯å¹´å­¸è²»+ç”Ÿæ´»è²»ï¼Œå–®ä½ï¼šç¾å…ƒ) *" data-en="Budget (Annual tuition + living expenses, USD) *">é ç®— (æ¯å¹´å­¸è²»+ç”Ÿæ´»è²»ï¼Œå–®ä½ï¼šç¾å…ƒ) *</label>
                            <input type="number" id="budget" name="budget" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                data-zh-ph="ä¾‹å¦‚ï¼š50000" data-en-ph="e.g., 50000" placeholder="ä¾‹å¦‚ï¼š50000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="ç›®æ¨™å…¥å­¸æ™‚é–“ *" data-en="Target Intake Time *">ç›®æ¨™å…¥å­¸æ™‚é–“ *</label>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                <select id="intake_semester" name="intake_semester" required 
                                    class="w-full sm:w-1/3 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                    <option value="" data-zh="é¸æ“‡å­¸æœŸ" data-en="Select Semester">é¸æ“‡å­¸æœŸ</option>
                                    <option value="fall" data-zh="ç§‹å­£" data-en="Fall">ç§‹å­£</option>
                                    <option value="spring" data-zh="æ˜¥å­£" data-en="Spring">æ˜¥å­£</option>
                                    <option value="summer" data-zh="å¤å­£" data-en="Summer">å¤å­£</option>
                                    <option value="winter" data-zh="å†¬å­£" data-en="Winter">å†¬å­£</option>
                                </select>
                                <select id="intake_year" name="intake_year" required 
                                    class="w-full sm:w-2/3 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                    <option value="" data-zh="é¸æ“‡å¹´ä»½" data-en="Select Year">é¸æ“‡å¹´ä»½</option>
                                </select>
                            </div>
                            <input type="hidden" id="target_intake" name="target_intake">
                        </div>
                    </div>

                    <!-- è§’è‰²é¸æ“‡ -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">4</span>
                                <span data-zh="é¸æ“‡æ‚¨çš„èº«ä»½" data-en="Choose Your Role">é¸æ“‡æ‚¨çš„èº«ä»½</span>
                            </div>
                        </h3>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                            <button type="button" onclick="selectRole('student')" id="role-student" 
                                    class="flex-1 px-4 sm:px-6 py-3 bg-blue-500 text-white rounded-lg font-medium transition-colors text-sm sm:text-base">
                                <span data-zh="ğŸ‘¨â€ğŸ“ æˆ‘æ˜¯å­¸ç”Ÿ" data-en="ğŸ‘¨â€ğŸ“ I am a Student">ğŸ‘¨â€ğŸ“ æˆ‘æ˜¯å­¸ç”Ÿ</span>
                            </button>
                            <button type="button" onclick="selectRole('parent')" id="role-parent" 
                                    class="flex-1 px-4 sm:px-6 py-3 bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors hover:bg-gray-400 text-sm sm:text-base">
                                <span data-zh="ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ æˆ‘æ˜¯å®¶é•·" data-en="ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ I am a Parent">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ æˆ‘æ˜¯å®¶é•·</span>
                            </button>
                        </div>
                    </div>

                    <button type="submit" 
                            class="w-full bg-yellow-400 text-gray-800 py-3 px-6 rounded-lg font-medium hover:bg-yellow-500 transition-colors duration-200 text-lg shadow-lg"
                            data-zh="é–‹å§‹èˆ‡AIé¡§å•å°è©±" data-en="Start Chat with AI Advisor">
                        é–‹å§‹èˆ‡AIé¡§å•å°è©±
                    </button>
                </form>
            </main>
        </div>
    </div>

    <!-- èŠå¤©é é¢ -->
    <div id="chat-page" class="min-h-screen hidden">
        <div class="max-w-4xl mx-auto bg-white min-h-screen flex flex-col">
            <header class="bg-gradient-to-r from-yellow-400 to-yellow-300 text-gray-800 p-4 relative">
                <button id="back-to-setup" class="absolute left-4 top-4 text-gray-800 hover:text-gray-600 transition-colors" onclick="showLoginPage()" style="cursor: pointer; -webkit-tap-highlight-color: transparent; touch-action: manipulation;">
                    <span data-zh="â† è¿”å›é¦–é " data-en="â† Back to Home">â† è¿”å›é¦–é </span>
                </button>
                <button onclick="logout()" class="absolute right-4 top-4 text-gray-800 hover:text-gray-600 transition-colors">
                    <span data-zh="ç™»å‡º" data-en="Logout">ç™»å‡º</span>
                </button>
                <div class="text-center">
                    <h1 class="text-xl font-bold" data-zh="AI ç•™å­¸é¡§å•" data-en="AI Study Abroad Advisor">AI ç•™å­¸é¡§å•</h1>
                    <p class="text-sm" data-zh="æ­£åœ¨ç‚ºæ‚¨æä¾›å°ˆæ¥­å»ºè­°" data-en="Providing you with professional advice">æ­£åœ¨ç‚ºæ‚¨æä¾›å°ˆæ¥­å»ºè­°</p>
                        <div class="flex items-center justify-center mt-2">
                            <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                            <span class="text-sm" data-zh="åœ¨ç·š" data-en="Online">åœ¨ç·š</span>
                        </div>
                    </div>
            </header>

            <main class="flex-1 p-6 overflow-y-auto bg-white chat-container mobile-optimized" id="chat-container">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-4">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">AI</div>
                            <div>
                                <h3 class="font-semibold text-gray-800" data-zh="AI ç•™å­¸é¡§å•" data-en="AI Study Abroad Advisor">AI ç•™å­¸é¡§å•</h3>
                                <p class="text-sm text-gray-500" data-zh="æ‚¨çš„å°ˆå±¬ç•™å­¸è¦åŠƒå°ˆå®¶" data-en="Your Exclusive Study Abroad Planning Expert">æ‚¨çš„å°ˆå±¬ç•™å­¸è¦åŠƒå°ˆå®¶</p>
                            </div>
                        </div>
                        <div class="text-gray-700 leading-relaxed">
                            <p class="mb-3" data-zh="ğŸ“ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIç•™å­¸é¡§å•ã€‚" data-en="ğŸ“ Hello! I am your AI Study Abroad Advisor.">ğŸ“ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIç•™å­¸é¡§å•ã€‚</p>
                            <p class="mb-3" data-zh="æˆ‘å·²ç¶“äº†è§£äº†æ‚¨çš„åŸºæœ¬è³‡è¨Šï¼Œç¾åœ¨è®“æˆ‘å€‘æ·±å…¥è¨è«–æ‚¨çš„ç•™å­¸è¨ˆåŠƒå§ï¼" data-en="I have reviewed your basic information, now let's dive deep into your study abroad planning!">æˆ‘å·²ç¶“äº†è§£äº†æ‚¨çš„åŸºæœ¬è³‡è¨Šï¼Œç¾åœ¨è®“æˆ‘å€‘æ·±å…¥è¨è«–æ‚¨çš„ç•™å­¸è¨ˆåŠƒå§ï¼</p>
                            <p class="mb-3" data-zh="æ‚¨å¯ä»¥å•æˆ‘ä»»ä½•é—œæ–¼ç•™å­¸çš„å•é¡Œï¼Œæ¯”å¦‚ï¼š" data-en="You can ask me any questions about studying abroad, such as:">æ‚¨å¯ä»¥å•æˆ‘ä»»ä½•é—œæ–¼ç•™å­¸çš„å•é¡Œï¼Œæ¯”å¦‚ï¼š</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-4">
                                <div class="flex items-center text-sm text-gray-600">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                    <span data-zh="æ¨è–¦é©åˆçš„å­¸æ ¡å’Œå°ˆæ¥­" data-en="School and major recommendations">æ¨è–¦é©åˆçš„å­¸æ ¡å’Œå°ˆæ¥­</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                    <span data-zh="ç”³è«‹æµç¨‹å’Œæ™‚é–“è¦åŠƒ" data-en="Application process and timeline">ç”³è«‹æµç¨‹å’Œæ™‚é–“è¦åŠƒ</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                    <span data-zh="çå­¸é‡‘ç”³è«‹å»ºè­°" data-en="Scholarship application advice">çå­¸é‡‘ç”³è«‹å»ºè­°</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                    <span data-zh="ç°½è­‰å’Œä½å®¿è³‡è¨Š" data-en="Visa and accommodation info">ç°½è­‰å’Œä½å®¿è³‡è¨Š</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-400 mt-3" data-zh="å‰›å‰›" data-en="Just now">å‰›å‰›</div>
                    </div>
                </div>
            </main>

            <footer class="p-6 border-t border-gray-200 bg-gray-50">
                <div class="max-w-4xl mx-auto">
                    <div id="quick-actions" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 mb-4"></div>
                    <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                        <textarea id="message-input" rows="2"
                               class="flex-1 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base bg-white resize-none"
                               placeholder="å‘Šè¨´æˆ‘ä½ çš„ç•™å­¸éœ€æ±‚ã€ç›®æ¨™æˆ–å›°æƒ‘..."
                               data-zh-ph="å‘Šè¨´æˆ‘ä½ çš„ç•™å­¸éœ€æ±‚ã€ç›®æ¨™æˆ–å›°æƒ‘..."
                               data-en-ph="Tell me your study abroad needs, goals, or confusions..."></textarea>
                        <button id="send-btn" 
                                class="px-6 py-4 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition-colors text-sm sm:text-base flex items-center justify-center">
                            <span data-zh="é€å‡º" data-en="Send">é€å‡º</span>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-3 text-center" data-zh="æŒ‰ Ctrl+Enter ç™¼é€ï¼ŒEnter æ›è¡Œ" data-en="Press Ctrl+Enter to send, Enter for new line">æŒ‰ Ctrl+Enter ç™¼é€ï¼ŒEnter æ›è¡Œ</p>
                </div>
            </footer>
        </div>
    </div>

    <!-- ç”¨æˆ¶è¨­å®šæ¨¡æ…‹æ¡† -->
    <div id="user-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="closeUserSettingsOnOutside(event)">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900" data-zh="ç”¨æˆ¶è¨­å®š" data-en="User Settings">ç”¨æˆ¶è¨­å®š</h2>
                    <button onclick="closeUserSettings()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        Ã—
                    </button>
                </div>
                
                <div class="space-y-6">
                    <!-- ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º -->
                    <div class="text-center">
                        <img id="settings-user-avatar" class="w-20 h-20 rounded-full mx-auto mb-3" src="" alt="User Avatar">
                        <h3 id="settings-user-name" class="text-xl font-semibold text-gray-900"></h3>
                        <p id="settings-user-email" class="text-gray-600"></p>
                    </div>
                    
                    <!-- åŸºæœ¬è³‡è¨Šç·¨è¼¯ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="é¡¯ç¤ºåç¨±" data-en="Display Name">é¡¯ç¤ºåç¨±</label>
                        <input type="text" id="settings-display-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="åå¥½èªè¨€" data-en="Preferred Language">åå¥½èªè¨€</label>
                        <select id="settings-language" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="zh">ä¸­æ–‡</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                    
                    <!-- é€šçŸ¥è¨­å®š -->
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 mb-3" data-zh="é€šçŸ¥è¨­å®š" data-en="Notification Settings">é€šçŸ¥è¨­å®š</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="settings-email-notifications" class="mr-2">
                                <span data-zh="æ¥æ”¶éƒµä»¶é€šçŸ¥" data-en="Receive email notifications">æ¥æ”¶éƒµä»¶é€šçŸ¥</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="settings-push-notifications" class="mr-2">
                                <span data-zh="æ¥æ”¶æ¨é€é€šçŸ¥" data-en="Receive push notifications">æ¥æ”¶æ¨é€é€šçŸ¥</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- éš±ç§è¨­å®š -->
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 mb-3" data-zh="éš±ç§è¨­å®š" data-en="Privacy Settings">éš±ç§è¨­å®š</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="settings-profile-public" class="mr-2">
                                <span data-zh="å…¬é–‹å€‹äººè³‡æ–™" data-en="Make profile public">å…¬é–‹å€‹äººè³‡æ–™</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="settings-data-collection" class="mr-2">
                                <span data-zh="å…è¨±æ•¸æ“šæ”¶é›†ä»¥æ”¹å–„æœå‹™" data-en="Allow data collection to improve service">å…è¨±æ•¸æ“šæ”¶é›†ä»¥æ”¹å–„æœå‹™</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- æ“ä½œæŒ‰éˆ• -->
                <div class="space-y-3 mt-8">
                    <button onclick="editUserProfile()" class="w-full px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                        <span data-zh="ç·¨è¼¯è¨­å®šè³‡æ–™" data-en="Edit Profile Data">ç·¨è¼¯è¨­å®šè³‡æ–™</span>
                    </button>
                    <button onclick="queryStudentProgress()" id="query-progress-btn" class="w-full px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors hidden">
                        <span data-zh="æŸ¥è©¢å­¸ç”Ÿè«®è©¢é€²åº¦" data-en="Query Student Progress">æŸ¥è©¢å­¸ç”Ÿè«®è©¢é€²åº¦</span>
                    </button>
                    <div class="flex space-x-3">
                        <button onclick="saveUserSettings()" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            <span data-zh="å„²å­˜è¨­å®š" data-en="Save Settings">å„²å­˜è¨­å®š</span>
                        </button>
                        <button onclick="closeUserSettings()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                            <span data-zh="å–æ¶ˆ" data-en="Cancel">å–æ¶ˆ</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯è¨­å®šæ¨¡æ…‹æ¡† -->
    <div id="edit-profile-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="closeEditProfileOnOutside(event)">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900" data-zh="ç·¨è¼¯ç•™å­¸éœ€æ±‚è¨­å®š" data-en="Edit Study Abroad Requirements">ç·¨è¼¯ç•™å­¸éœ€æ±‚è¨­å®š</h2>
                    <button onclick="closeEditProfile()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        Ã—
                    </button>
                </div>
                
                <!-- ç·¨è¼¯è¡¨å–® -->
                <form id="edit-profile-form" class="space-y-6">
                    <!-- å€‹äººåŸºæœ¬è³‡è¨Š -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">1</span>
                                <span data-zh="å€‹äººåŸºæœ¬è³‡è¨Š" data-en="Personal Information">å€‹äººåŸºæœ¬è³‡è¨Š</span>
                            </div>
                        </h3>
                        <div id="edit-student-fields" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å­¸ç”Ÿå§“å *" data-en="Student Name *">å­¸ç”Ÿå§“å *</label>
                                <input type="text" id="edit_student_name" name="student_name" required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    data-zh-ph="ä¾‹å¦‚ï¼šç‹å°æ˜" data-en-ph="e.g., David Wang" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å­¸ç”Ÿé›»å­éƒµä»¶ *" data-en="Student Email *">å­¸ç”Ÿé›»å­éƒµä»¶ *</label>
                                <input type="email" id="edit_student_email" name="student_email" required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    data-zh-ph="ä¾‹å¦‚ï¼šdavid@example.com" data-en-ph="e.g., david@example.com" placeholder="ä¾‹å¦‚ï¼šdavid@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="åœ‹ç± *" data-en="Citizenship *">åœ‹ç± *</label>
                                <input type="text" id="edit_citizenship" name="citizenship" required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    data-zh-ph="ä¾‹å¦‚ï¼šå°ç£" data-en-ph="e.g., Taiwan" placeholder="ä¾‹å¦‚ï¼šå°ç£">
                            </div>
                        </div>
                        <div id="edit-parent-fields" class="space-y-4 hidden">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å®¶é•·å§“å *" data-en="Parent Name *">å®¶é•·å§“å *</label>
                                <input type="text" id="edit_parent_name" name="parent_name"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    data-zh-ph="ä¾‹å¦‚ï¼šç‹åª½åª½" data-en-ph="e.g., Alice Wang" placeholder="ä¾‹å¦‚ï¼šç‹åª½åª½">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å®¶é•·é›»å­éƒµä»¶ *" data-en="Parent Email *">å®¶é•·é›»å­éƒµä»¶ *</label>
                                <input type="email" id="edit_parent_email" name="parent_email"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    data-zh-ph="ä¾‹å¦‚ï¼šparent@example.com" data-en-ph="e.g., parent@example.com" placeholder="ä¾‹å¦‚ï¼šparent@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="èˆ‡å­¸ç”Ÿé—œä¿‚ *" data-en="Relationship to Student *">èˆ‡å­¸ç”Ÿé—œä¿‚ *</label>
                                <input type="text" id="edit_relationship" name="relationship"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    data-zh-ph="ä¾‹å¦‚ï¼šæ¯è¦ª / çˆ¶è¦ª" data-en-ph="e.g., Mother / Father" placeholder="ä¾‹å¦‚ï¼šæ¯è¦ª">
                            </div>
                            <div class="border-t pt-4">
                                <p class="text-sm text-gray-500 mb-2" data-zh="å­¸ç”Ÿè¯çµ¡è³‡æ–™" data-en="Student Contact">å­¸ç”Ÿè¯çµ¡è³‡æ–™</p>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å­¸ç”Ÿå§“å *" data-en="Student Name *">å­¸ç”Ÿå§“å *</label>
                                <input type="text" id="edit_child_name" name="child_name"
                                    class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    data-zh-ph="ä¾‹å¦‚ï¼šç‹å°æ˜" data-en-ph="e.g., David Wang" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜">
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å­¸ç”Ÿé›»å­éƒµä»¶ *" data-en="Student Email *">å­¸ç”Ÿé›»å­éƒµä»¶ *</label>
                                <input type="email" id="edit_child_email" name="child_email"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    data-zh-ph="ä¾‹å¦‚ï¼šdavid@example.com" data-en-ph="e.g., david@example.com" placeholder="ä¾‹å¦‚ï¼šdavid@example.com">
                            </div>
                        </div>
                    </div>

                    <!-- å­¸è¡“èƒŒæ™¯ -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">2</span>
                                <span data-zh="å­¸è¡“èƒŒæ™¯" data-en="Academic Background">å­¸è¡“èƒŒæ™¯</span>
                            </div>
                        </h3>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="GPA (æ»¿åˆ†4.0) *" data-en="GPA (out of 4.0) *">GPA (æ»¿åˆ†4.0) *</label>
                            <input type="number" id="edit_gpa" name="gpa" step="0.1" min="0" max="4" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                data-zh-ph="ä¾‹å¦‚ï¼š3.8" data-en-ph="e.g., 3.8" placeholder="ä¾‹å¦‚ï¼š3.8">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="ç›®æ¨™å­¸ä½ *" data-en="Target Degree *">ç›®æ¨™å­¸ä½ *</label>
                            <select id="edit_degree" name="degree" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                <option value="" data-zh="è«‹é¸æ“‡" data-en="Please select">è«‹é¸æ“‡</option>
                                <option value="bachelor" data-zh="å­¸å£«" data-en="Bachelor's">å­¸å£«</option>
                                <option value="master" data-zh="ç¢©å£«" data-en="Master's">ç¢©å£«</option>
                                <option value="phd" data-zh="åšå£«" data-en="PhD">åšå£«</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="ç›®æ¨™åœ‹å®¶ *" data-en="Target Countries *">ç›®æ¨™åœ‹å®¶ *</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center">
                                    <input type="checkbox" name="edit_countries" value="us" class="mr-2">
                                    <span data-zh="ç¾åœ‹" data-en="USA">ç¾åœ‹</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="edit_countries" value="uk" class="mr-2">
                                    <span data-zh="è‹±åœ‹" data-en="UK">è‹±åœ‹</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="edit_countries" value="ca" class="mr-2">
                                    <span data-zh="åŠ æ‹¿å¤§" data-en="Canada">åŠ æ‹¿å¤§</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- é ç®—å’Œæ™‚é–“ -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">3</span>
                                <span data-zh="é ç®—å’Œæ™‚é–“" data-en="Budget and Time">é ç®—å’Œæ™‚é–“</span>
                            </div>
                        </h3>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="é ç®— (æ¯å¹´å­¸è²»+ç”Ÿæ´»è²»ï¼Œå–®ä½ï¼šç¾å…ƒ) *" data-en="Budget (Annual tuition + living expenses, USD) *">é ç®— (æ¯å¹´å­¸è²»+ç”Ÿæ´»è²»ï¼Œå–®ä½ï¼šç¾å…ƒ) *</label>
                            <input type="number" id="edit_budget" name="budget" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                data-zh-ph="ä¾‹å¦‚ï¼š50000" data-en-ph="e.g., 50000" placeholder="ä¾‹å¦‚ï¼š50000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="ç›®æ¨™å…¥å­¸æ™‚é–“ *" data-en="Target Intake Time *">ç›®æ¨™å…¥å­¸æ™‚é–“ *</label>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                <select id="edit_intake_semester" name="intake_semester" required 
                                    class="w-full sm:w-1/3 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                    <option value="" data-zh="é¸æ“‡å­¸æœŸ" data-en="Select Semester">é¸æ“‡å­¸æœŸ</option>
                                    <option value="fall" data-zh="ç§‹å­£" data-en="Fall">ç§‹å­£</option>
                                    <option value="spring" data-zh="æ˜¥å­£" data-en="Spring">æ˜¥å­£</option>
                                    <option value="summer" data-zh="å¤å­£" data-en="Summer">å¤å­£</option>
                                    <option value="winter" data-zh="å†¬å­£" data-en="Winter">å†¬å­£</option>
                                </select>
                                <select id="edit_intake_year" name="intake_year" required 
                                    class="w-full sm:w-2/3 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                    <option value="" data-zh="é¸æ“‡å¹´ä»½" data-en="Select Year">é¸æ“‡å¹´ä»½</option>
                                </select>
                            </div>
                            <input type="hidden" id="edit_target_intake" name="target_intake">
                        </div>
                    </div>

                    <!-- è§’è‰²é¸æ“‡ -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">4</span>
                                <span data-zh="é¸æ“‡æ‚¨çš„èº«ä»½" data-en="Choose Your Role">é¸æ“‡æ‚¨çš„èº«ä»½</span>
                            </div>
                        </h3>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                            <button type="button" onclick="selectEditRole('student')" id="edit-role-student" 
                                    class="flex-1 px-4 sm:px-6 py-3 bg-blue-500 text-white rounded-lg font-medium transition-colors text-sm sm:text-base">
                                <span data-zh="ğŸ‘¨â€ğŸ“ æˆ‘æ˜¯å­¸ç”Ÿ" data-en="ğŸ‘¨â€ğŸ“ I am a Student">ğŸ‘¨â€ğŸ“ æˆ‘æ˜¯å­¸ç”Ÿ</span>
                            </button>
                            <button type="button" onclick="selectEditRole('parent')" id="edit-role-parent" 
                                    class="flex-1 px-4 sm:px-6 py-3 bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors hover:bg-gray-400 text-sm sm:text-base">
                                <span data-zh="ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ æˆ‘æ˜¯å®¶é•·" data-en="ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ I am a Parent">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ æˆ‘æ˜¯å®¶é•·</span>
                            </button>
                        </div>
                    </div>
                </form>

                <!-- æ“ä½œæŒ‰éˆ• -->
                <div class="flex space-x-3 mt-8">
                    <button onclick="saveEditedProfile()" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        <span data-zh="å„²å­˜è¨­å®š" data-en="Save Settings">å„²å­˜è¨­å®š</span>
                    </button>
                    <button onclick="closeEditProfile()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                        <span data-zh="å–æ¶ˆ" data-en="Cancel">å–æ¶ˆ</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å­¸ç”Ÿé€²åº¦æŸ¥è©¢æ¨¡æ…‹æ¡† -->
    <div id="student-progress-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="closeStudentProgressOnOutside(event)">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900" data-zh="å­¸ç”Ÿè«®è©¢é€²åº¦å ±å‘Š" data-en="Student Progress Report">å­¸ç”Ÿè«®è©¢é€²åº¦å ±å‘Š</h2>
                    <button onclick="closeStudentProgress()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        Ã—
                    </button>
                </div>
                
                <div id="progress-content">
                    <!-- é€²åº¦å…§å®¹å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
                </div>
                
                <!-- é—œé–‰æŒ‰éˆ• -->
                <div class="flex justify-end mt-6">
                    <button onclick="closeStudentProgress()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                        <span data-zh="é—œé–‰" data-en="Close">é—œé–‰</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        var currentRole = 'student';
        var currentLanguage = 'zh';
        var profileId = null;
        var eventSource = null; // SSE é€£ç·š
        
        // è¨­ç½® JWT Cookie (å®‰å…¨ç‰ˆæœ¬ï¼Œæ”¯æŒè·¨è¨­å‚™)
        function setJWTCookie(jwt) {
            // æª¢æŸ¥æ˜¯å¦ç‚º HTTPS ç’°å¢ƒ
            const isSecure = window.location.protocol === 'https:';
            const domain = window.location.hostname;
            
            // æ§‹å»ºå®‰å…¨çš„ Cookie å±¬æ€§
            let cookieAttributes = [
                `jwt=${jwt}`,
                'path=/',
                'max-age=86400', // 24å°æ™‚
                'SameSite=Lax', // é˜²æ­¢ CSRF
                'HttpOnly=false' // å…è¨± JavaScript è¨ªå•ï¼ˆSSE éœ€è¦ï¼‰
            ];
            
            // è¨­ç½®åŸŸåä»¥æ”¯æŒè·¨å­åŸŸï¼ˆå¦‚æœé©ç”¨ï¼‰
            if (domain.includes('zeabur.app')) {
                cookieAttributes.push('domain=.zeabur.app');
            }
            
            // åœ¨ HTTPS ç’°å¢ƒä¸‹å•Ÿç”¨ Secure å±¬æ€§
            if (isSecure) {
                cookieAttributes.push('Secure');
            }
            
            document.cookie = cookieAttributes.join('; ');
            
            console.log('JWT Cookie set with cross-device support:', {
                secure: isSecure,
                domain: domain.includes('zeabur.app') ? '.zeabur.app' : domain,
                sameSite: 'Lax',
                httpOnly: false,
                maxAge: '86400s'
            });
        }
        
        // æ¸…é™¤ JWT Cookie (å®‰å…¨ç‰ˆæœ¬)
        function clearJWTCookie() {
            // æª¢æŸ¥æ˜¯å¦ç‚º HTTPS ç’°å¢ƒ
            const isSecure = window.location.protocol === 'https:';
            
            // æ§‹å»ºæ¸…é™¤ Cookie çš„å±¬æ€§
            let clearAttributes = [
                'jwt=',
                'path=/',
                'expires=Thu, 01 Jan 1970 00:00:00 GMT',
                'SameSite=Lax'
            ];
            
            // åœ¨ HTTPS ç’°å¢ƒä¸‹æ·»åŠ  Secure å±¬æ€§
            if (isSecure) {
                clearAttributes.push('Secure');
            }
            
            document.cookie = clearAttributes.join('; ');
            
            console.log('JWT Cookie cleared with security attributes');
        }
        
        // é—œé–‰ SSE é€£ç·š
        function closeStream() {
            if (eventSource) {
                console.log('Closing SSE connection...');
                eventSource.close();
                eventSource = null;
            }
        }
        
        // é–‹å§‹ SSE ä¸²æµ
        function startStreaming(message, messageId) {
            return new Promise((resolve, reject) => {
                try {
                    const jwt = localStorage.getItem('jwt');
                    if (!jwt) {
                        reject(new Error('No JWT token'));
                        return;
                    }
                    
                    // è¨­ç½® Cookie
                    setJWTCookie(jwt);
                    
                    // é—œé–‰èˆŠé€£ç·š
                    closeStream();
                    
                    // å‰µå»ºæ–°çš„ EventSource
                    const streamUrl = window.__CONFIG__.API_BASE + '/api/v1/chat/stream';
                    eventSource = new EventSource(streamUrl + '?message=' + encodeURIComponent(message) + 
                                                 '&profile_id=' + encodeURIComponent(profileId || '') + 
                                                 '&language=' + encodeURIComponent(currentLanguage) + 
                                                 '&user_role=' + encodeURIComponent(currentRole));
                    
                    let fullResponse = '';
                    let isComplete = false;
                    
                    eventSource.onmessage = function(event) {
                        const data = event.data;
                        
                        // å¿½ç•¥å¿ƒè·³
                        if (data === ': keep-alive') {
                            return;
                        }
                        
                        // æª¢æŸ¥æ˜¯å¦å®Œæˆ
                        if (data === '[DONE]') {
                            isComplete = true;
                            closeStream();
                            resolve(fullResponse);
                            return;
                        }
                        
                        // ç´¯ç©å›æ‡‰å…§å®¹
                        fullResponse += data;
                        
                        // æ›´æ–°è¨Šæ¯æ°£æ³¡å…§å®¹
                        const messageElement = document.getElementById(messageId);
                        if (messageElement) {
                            const contentElement = messageElement.querySelector('.message-content');
                            if (contentElement) {
                                contentElement.textContent = fullResponse;
                                // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
                                const chatContainer = document.getElementById('chat-container');
                                if (chatContainer) {
                                    chatContainer.scrollTop = chatContainer.scrollHeight;
                                }
                            }
                        }
                    };
                    
                    eventSource.onerror = function(error) {
                        console.error('SSE error:', error);
                        console.error('EventSource readyState:', eventSource.readyState);
                        closeStream();
                        if (!isComplete) {
                            reject(new Error('SSE connection failed: ' + (error.message || 'Unknown error')));
                        }
                    };
                    
                    // è¨­ç½®è¶…æ™‚
                    setTimeout(() => {
                        if (!isComplete) {
                            console.warn('SSE timeout, falling back to regular API');
                            closeStream();
                            reject(new Error('SSE timeout'));
                        }
                    }, 30000); // 30 ç§’è¶…æ™‚
                    
                } catch (error) {
                    console.error('Error starting stream:', error);
                    closeStream();
                    reject(error);
                }
            });
        }
        
        // å¾æœ¬åœ°å„²å­˜è¼‰å…¥ profileId
        function loadProfileId() {
            var jwt = localStorage.getItem('jwt');
            var userProfile = localStorage.getItem('userProfile');
            
            if (jwt && userProfile && jwt !== 'fake-jwt-token-for-testing') {
                try {
                    var user = JSON.parse(userProfile);
                    var savedProfileId = localStorage.getItem('profileId_' + user.userId);
                    if (savedProfileId) {
                        profileId = savedProfileId;
                        console.log('Loaded profileId for user:', user.name, 'Profile ID:', profileId);
                    }
                } catch (e) {
                    console.error('Error loading profileId:', e);
                }
            }
        }
        
        // å„²å­˜ profileId åˆ°æœ¬åœ°å„²å­˜
        function saveProfileId(userId, profileIdValue) {
            if (userId && profileIdValue) {
                localStorage.setItem('profileId_' + userId, profileIdValue);
                profileId = profileIdValue;
                console.log('Saved profileId for user:', userId, 'Profile ID:', profileIdValue);
            }
        }
        
        // æª¢ç´¢ç”¨æˆ¶è¨­å®šè³‡æ–™
        function fetchUserProfileData(profileId) {
            return new Promise((resolve, reject) => {
                var jwt = localStorage.getItem('jwt');
                if (!jwt || !profileId) {
                    console.error('Missing JWT or profileId:', { jwt: !!jwt, profileId: profileId });
                    reject('No JWT token or profile ID');
                    return;
                }
                
                console.log('Fetching profile data for:', profileId);
                
                fetch(window.__CONFIG__.API_BASE + '/api/v1/user/profile/' + profileId, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + jwt,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    console.log('Profile API response status:', response.status);
                    return response.json();
                })
                .then(result => {
                    console.log('Profile API result:', result);
                    if (result.ok) {
                        console.log('User profile data retrieved:', result.data);
                        resolve(result.data);
                    } else {
                        console.error('Profile API error:', result.error);
                        if (result.error === 'Profile not found') {
                            reject('ç”¨æˆ¶é‚„æ²’æœ‰å¡«å¯«ç•™å­¸éœ€æ±‚è³‡æ–™ï¼Œè«‹å…ˆå¡«å¯«ã€Œè¨­å®šæ‚¨çš„ç•™å­¸éœ€æ±‚ã€è¡¨å–®ã€‚');
                        } else {
                            reject('Failed to retrieve profile: ' + result.error);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching user profile:', error);
                    reject(error);
                });
            });
        }

        // ç›£è½å½ˆå‡ºè¦–çª—æ¶ˆæ¯
        window.addEventListener('message', function(event) {
            // ç¢ºä¿æ¶ˆæ¯ä¾†è‡ªå¯ä¿¡çš„ä¾†æº
            if (event.origin !== 'https://aistudentbackend.zeabur.app') {
                return;
            }
            
            if (event.data && event.data.type === 'GOOGLE_LOGIN_SUCCESS') {
                console.log('Received login success message:', event.data);
                
                if (window.addDebugInfo) {
                    addDebugInfo('âœ“ æ”¶åˆ° Google ç™»å…¥æˆåŠŸæ¶ˆæ¯');
                    addDebugInfo('ç”¨æˆ¶: ' + event.data.user.name + ' (' + event.data.user.email + ')');
                }
                
                // å„²å­˜ token å’Œç”¨æˆ¶ä¿¡æ¯
                localStorage.setItem('jwt', event.data.token);
                localStorage.setItem('userProfile', JSON.stringify(event.data.user));
                
                // åŒæ™‚è¨­ç½® Cookie ç”¨æ–¼ SSE èªè­‰
                setJWTCookie(event.data.token);
                
                // è¨­ç½®åŒæ­¥æ™‚é–“
                localStorage.setItem('lastSyncTime', Date.now().toString());
                
                // è¼‰å…¥å·²ä¿å­˜çš„ profileId
                loadProfileId();
                
                // é¡¯ç¤ºç”¨æˆ¶ä¿¡æ¯ï¼Œä¸è‡ªå‹•è·³è½‰åˆ°è¨­å®šé é¢
                showUserInfo(event.data.user);
            }
        });

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å–å¾— Google Client ID ä»¥åˆå§‹åŒ– GIS
            fetch(window.__CONFIG__.API_BASE + '/api/v1/auth/config')
                .then(r => r.json())
                .then(cfg => {
                    if (cfg && cfg.ok && cfg.google && cfg.google.client_id) {
                        window.__GOOGLE_CLIENT_ID__ = cfg.google.client_id;
                        console.log('Google Client ID loaded:', cfg.google.client_id);
                    } else {
                        console.warn('Google Client ID not configured in backend');
                        console.log('Config response:', cfg);
                    }
                })
                .catch((error) => {
                    console.error('Failed to load Google Client ID:', error);
                });
                
            // æª¢æŸ¥ Google API è¼‰å…¥ç‹€æ…‹
            setTimeout(function() {
                if (typeof google !== 'undefined' && google.accounts) {
                    console.log('Google API loaded successfully');
                } else {
                    console.error('Google API failed to load');
                }
            }, 2000);
            // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            checkAuthStatus();
            
            // åˆå§‹åŒ–å¹´ä»½é¸é …
            initializeYearOptions();
            
            // ç¶å®šäº‹ä»¶
            document.getElementById('back-to-home').addEventListener('click', showLoginPage);
            // back-to-setup ç¾åœ¨ä½¿ç”¨ onclick å±¬æ€§ï¼Œæ›´å…¼å®¹ iOS Safari
            document.getElementById('setup-form').addEventListener('submit', handleSetupSubmit);
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    // Ctrl+Enter ç™¼é€è¨Šæ¯
                    sendMessage();
                }
                // å–®ç¨æŒ‰ Enter åªæ›è¡Œï¼Œä¸ç™¼é€
            });
            
            // ç¶å®šæ—¥æœŸé¸æ“‡äº‹ä»¶
            document.getElementById('intake_semester').addEventListener('change', updateTargetIntake);
            document.getElementById('intake_year').addEventListener('change', updateTargetIntake);
        });

        // æª¢æŸ¥èªè­‰ç‹€æ…‹
        function checkAuthStatus() {
            try {
                fetch(window.__CONFIG__.API_BASE + '/api/v1/auth/status')
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (data.ok && data.user) {
                        showUserInfo(data.user);
                    } else {
                        showLoginButtons();
                    }
                })
                .catch(function(error) {
                    console.error('Auth check failed:', error);
                    showLoginButtons();
                });
            } catch (error) {
                console.error('Auth check failed:', error);
                showLoginButtons();
            }
        }

        // é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
        function showUserInfo(user) {
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('login-buttons').classList.add('hidden');
            document.getElementById('user-name').textContent = user.name;
            if (user.avatar) {
                document.getElementById('user-avatar').src = user.avatar;
            }
            
            // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦æœ‰è¨­å®šè³‡æ–™
            checkUserProfileStatus();
        }
        
        // æª¢æŸ¥ç”¨æˆ¶è¨­å®šç‹€æ…‹
        function checkUserProfileStatus() {
            var jwt = localStorage.getItem('jwt');
            if (!jwt) return;
            
            fetch(window.__CONFIG__.API_BASE + '/api/v1/user/check-profile', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + jwt,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.ok) {
                    if (result.has_profile) {
                        // å·²æœ‰è¨­å®šè³‡æ–™
                        profileId = result.profile_id;
                        currentRole = result.user_role;
                        
                        // å„²å­˜ profileId
                        var userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                        if (userProfile.userId) {
                            saveProfileId(userProfile.userId, profileId);
                        }
                        
                        // æ›´æ–°æŒ‰éˆ•æ–‡å­—
                        var continueButton = document.querySelector('button[onclick="continueToChat()"]');
                        if (continueButton) {
                            continueButton.innerHTML = '<span data-zh="ç¹¼çºŒè·ŸAIç•™å­¸é¡§å•è«®è©¢" data-en="Continue with AI Study Advisor">ç¹¼çºŒè·ŸAIç•™å­¸é¡§å•è«®è©¢</span>';
                        }
                        
                        console.log('User has existing profile:', result.profile_data);
                    } else {
                        // ç¬¬ä¸€æ¬¡ç™»å…¥ï¼Œæ²’æœ‰è¨­å®šè³‡æ–™
                        console.log('User is first time login, needs to complete setup');
                    }
                }
            })
            .catch(error => {
                console.error('Error checking user profile:', error);
            });
        }

        // é¡¯ç¤ºç™»å…¥æŒ‰éˆ•
        function showLoginButtons() {
            document.getElementById('user-info').classList.add('hidden');
            document.getElementById('login-buttons').classList.remove('hidden');
        }

        // ç™»å…¥åŠŸèƒ½
        function loginWithGoogle() {
            console.log('Google login button clicked');
            if (window.addDebugInfo) {
                addDebugInfo('Google ç™»å…¥æŒ‰éˆ•è¢«é»æ“Š');
            }
            
            // æª¢æŸ¥æ˜¯å¦åœ¨æ‡‰ç”¨ç¨‹å¼å…§å»ºç€è¦½å™¨ä¸­ï¼ˆä½†å…è¨± LINE å…§å»ºç€è¦½å™¨ï¼‰
            var userAgent = navigator.userAgent || '';
            var isInAppBrowser = /FBAN|FBAV|Instagram|WhatsApp|Twitter|LinkedInApp|Skype|Pinterest|Snapchat|WeChat|Telegram|Viber|Messenger|MicroMessenger|QQ|UCBrowser|Opera Mini|Opera Mobi/i.test(userAgent);
            var isLineBrowser = /Line/i.test(userAgent);
            
            // æª¢æŸ¥æ˜¯å¦ç‚º iOS Safariï¼ˆéœ€è¦ç‰¹æ®Šè™•ç†ï¼‰
            var isIOSSafari = /iPad|iPhone|iPod/.test(userAgent) && /Safari/.test(userAgent) && !/CriOS|FxiOS|OPiOS|mercury/.test(userAgent);
            
            // åªå°é LINE çš„å…§å»ºç€è¦½å™¨é€²è¡Œé™åˆ¶
            if (isInAppBrowser && !isLineBrowser) {
                // åœ¨æ‡‰ç”¨ç¨‹å¼å…§å»ºç€è¦½å™¨ä¸­ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ¶é«”é©—
                var message = currentLanguage === 'en' ? 
                    'To complete Google login, please:\n\n1. Tap the menu button (â‹®) in the top right\n2. Select "Open in Browser" or "Open in Safari"\n3. Complete the login process' : 
                    'ç‚ºäº†å®Œæˆ Google ç™»å…¥ï¼Œè«‹ï¼š\n\n1. é»æ“Šå³ä¸Šè§’çš„é¸å–®æŒ‰éˆ• (â‹®)\n2. é¸æ“‡ã€Œåœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿã€æˆ–ã€Œåœ¨ Safari ä¸­é–‹å•Ÿã€\n3. å®Œæˆç™»å…¥æµç¨‹';
                
                // ä½¿ç”¨ confirm è€Œä¸æ˜¯ alertï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ¶é«”é©—
                var userChoice = confirm(message + '\n\n' + (currentLanguage === 'en' ? 'Click OK to continue with LINE login instead' : 'é»æ“Šç¢ºå®šä½¿ç”¨ LINE ç™»å…¥'));
                
                if (userChoice) {
                    // ç”¨æˆ¶é¸æ“‡ä½¿ç”¨ LINE ç™»å…¥
                    loginWithLINE();
                }
                
                if (window.addDebugInfo) {
                    addDebugInfo('âœ— æª¢æ¸¬åˆ°æ‡‰ç”¨ç¨‹å¼å…§å»ºç€è¦½å™¨ï¼Œå»ºè­°ä½¿ç”¨å¤–éƒ¨ç€è¦½å™¨');
                }
                return;
            }
            
            // LINE å…§å»ºç€è¦½å™¨å…è¨±ç›´æ¥é€²è¡Œ Google ç™»å…¥
            if (isLineBrowser) {
                if (window.addDebugInfo) {
                    addDebugInfo('âœ“ æª¢æ¸¬åˆ° LINE å…§å»ºç€è¦½å™¨ï¼Œå…è¨± Google ç™»å…¥');
                }
                
                // åœ¨ LINE å…§å»ºç€è¦½å™¨ä¸­ï¼Œæä¾›é¸æ“‡
                var lineMessage = currentLanguage === 'en' ? 
                    'You are using LINE browser. You can:\n\n1. Continue with Google login (may not work)\n2. Use LINE login instead (recommended)\n3. Open in external browser' :
                    'æ‚¨æ­£åœ¨ä½¿ç”¨ LINE ç€è¦½å™¨ã€‚æ‚¨å¯ä»¥ï¼š\n\n1. ç¹¼çºŒä½¿ç”¨ Google ç™»å…¥ï¼ˆå¯èƒ½ç„¡æ³•ä½¿ç”¨ï¼‰\n2. ä½¿ç”¨ LINE ç™»å…¥ï¼ˆæ¨è–¦ï¼‰\n3. åœ¨å¤–éƒ¨ç€è¦½å™¨ä¸­é–‹å•Ÿ';
                
                var choice = confirm(lineMessage + '\n\n' + (currentLanguage === 'en' ? 'Click OK for LINE login, Cancel for Google login' : 'é»æ“Šç¢ºå®šä½¿ç”¨ LINE ç™»å…¥ï¼Œå–æ¶ˆä½¿ç”¨ Google ç™»å…¥'));
                
                if (choice) {
                    // ç”¨æˆ¶é¸æ“‡ LINE ç™»å…¥
                    loginWithLINE();
                    return;
                }
                // å¦‚æœç”¨æˆ¶é¸æ“‡ Google ç™»å…¥ï¼Œç¹¼çºŒåŸ·è¡Œä¸‹é¢çš„ä»£ç¢¼
            }
            
            // ä½¿ç”¨å½ˆå‡ºè¦–çª—é€²è¡Œ Google ç™»å…¥
            var googleAuthUrl = 'https://accounts.google.com/o/oauth2/v2/auth?' +
                'client_id=' + (window.__GOOGLE_CLIENT_ID__ || '300123710303-m4j1laa65p664n5vtrdkfvfa7b42c2o6.apps.googleusercontent.com') + '&' +
                'redirect_uri=https://aistudentbackend.zeabur.app/auth/google/callback&' +
                'response_type=code&' +
                'scope=openid email profile&' +
                'state=popup_login';
            
            console.log('Opening Google login popup:', googleAuthUrl);
            
            // åœ¨ LINE å…§å»ºç€è¦½å™¨ä¸­ï¼Œä½¿ç”¨ç›´æ¥è·³è½‰è€Œä¸æ˜¯å½ˆå‡ºè¦–çª—
            if (isLineBrowser) {
                console.log('Using direct redirect for LINE browser');
                window.location.href = googleAuthUrl;
                return;
            }
            if (window.addDebugInfo) {
                addDebugInfo('æº–å‚™æ‰“é–‹ Google ç™»å…¥å½ˆå‡ºè¦–çª—');
                addDebugInfo('URL: ' + googleAuthUrl);
            }
            
            // æ‰“é–‹å½ˆå‡ºè¦–çª—
            var popup = window.open(
                googleAuthUrl,
                'googleLogin',
                'width=500,height=600,scrollbars=yes,resizable=yes,status=yes,location=yes,toolbar=no,menubar=no'
            );
            
            if (!popup) {
                const errorMsg = currentLanguage === 'en' ? 
                    'Popup blocked. Please allow popups for this site and try again.' : 
                    'å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹ã€‚è«‹å…è¨±æ­¤ç¶²ç«™çš„å½ˆå‡ºè¦–çª—å¾Œå†è©¦ã€‚';
                alert(errorMsg);
                if (window.addDebugInfo) {
                    addDebugInfo('âœ— ' + errorMsg);
                }
                return;
            }
            
            if (window.addDebugInfo) {
                addDebugInfo('âœ“ å½ˆå‡ºè¦–çª—å·²æˆåŠŸæ‰“é–‹');
            }
            
            // ç›£è½å½ˆå‡ºè¦–çª—çš„é—œé–‰
            var checkClosed = setInterval(function() {
                if (popup.closed) {
                    clearInterval(checkClosed);
                    console.log('Google login popup closed');
                    // ç™»å…¥æˆåŠŸæœƒé€šé postMessage è™•ç†ï¼Œé€™è£¡ä¸éœ€è¦é¡å¤–è™•ç†
                }
            }, 1000);
            
            // 5åˆ†é˜å¾Œè‡ªå‹•æ¸…ç†ç›£è½å™¨
            setTimeout(function() {
                clearInterval(checkClosed);
                if (!popup.closed) {
                    popup.close();
                }
            }, 300000);
        }

        function showLineUnavailable() {
            alert(currentLanguage === 'en' ? 
                'LINE login feature is coming soon! Please use Google login or skip login for now.' : 
                'LINE ç™»å…¥åŠŸèƒ½å³å°‡æ¨å‡ºï¼ç›®å‰è«‹ä½¿ç”¨ Google ç™»å…¥æˆ–è·³éç™»å…¥ã€‚');
        }
        
        function loginWithLINE() {
            console.log('LINE login button clicked');
            
            // æª¢æŸ¥æ˜¯å¦åœ¨ LINE å…§å»ºç€è¦½å™¨ä¸­
            var userAgent = navigator.userAgent || '';
            var isLineBrowser = /Line/i.test(userAgent);
            
            if (isLineBrowser) {
                console.log('Detected LINE in-app browser');
                
                // åœ¨ LINE å…§å»ºç€è¦½å™¨ä¸­ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ¶é«”é©—æç¤º
                var message = currentLanguage === 'en' ? 
                    'You are using LINE browser. This will open LINE authorization page.\n\n' +
                    'If you see QR code, you can:\n' +
                    '1. Use "Login via email account" button below\n' +
                    '2. Or use your LINE app to scan QR code\n\n' +
                    'Continue with LINE login?' :
                    'æ‚¨æ­£åœ¨ä½¿ç”¨ LINE ç€è¦½å™¨ã€‚é€™å°‡é–‹å•Ÿ LINE æˆæ¬Šé é¢ã€‚\n\n' +
                    'å¦‚æœçœ‹åˆ° QR codeï¼Œæ‚¨å¯ä»¥ï¼š\n' +
                    '1. ä½¿ç”¨ä¸‹æ–¹çš„ã€Œé€éé›»å­éƒµä»¶å¸³è™Ÿç™»å…¥ã€æŒ‰éˆ•\n' +
                    '2. æˆ–ä½¿ç”¨ LINE App æƒæ QR code\n\n' +
                    'ç¹¼çºŒä½¿ç”¨ LINE ç™»å…¥ï¼Ÿ';
                
                if (confirm(message)) {
                    // ä½¿ç”¨å¾Œç«¯ API ç²å– LINE ç™»å…¥ URL
                    fetch('https://aistudentbackend.zeabur.app/api/v1/auth/line/login')
                        .then(function(response) {
                            return response.json();
                        })
                        .then(function(data) {
                            if (data.ok) {
                                console.log('Redirecting to LINE login:', data.login_url);
                                window.location.href = data.login_url;
                            } else {
                                alert(currentLanguage === 'en' ? 
                                    'LINE login is not available. Please use Google login or skip login.' : 
                                    'LINE ç™»å…¥åŠŸèƒ½æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œè«‹ä½¿ç”¨ Google ç™»å…¥æˆ–è·³éç™»å…¥ã€‚');
                            }
                        })
                        .catch(function(error) {
                            console.error('LINE Login error:', error);
                            alert(currentLanguage === 'en' ? 
                                'LINE login failed. Please try again or use Google login.' : 
                                'LINE ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦æˆ–ä½¿ç”¨ Google ç™»å…¥ã€‚');
                        });
                }
            } else {
                // åœ¨å¤–éƒ¨ç€è¦½å™¨ä¸­ï¼Œç›´æ¥ä½¿ç”¨ LINE ç™»å…¥
                fetch('https://aistudentbackend.zeabur.app/api/v1/auth/line/login')
                    .then(function(response) {
                        return response.json();
                    })
                    .then(function(data) {
                        if (data.ok) {
                            window.location.href = data.login_url;
                        } else {
                            alert(currentLanguage === 'en' ? 
                                'LINE login is not available. Please use Google login or skip login.' : 
                                'LINE ç™»å…¥åŠŸèƒ½æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œè«‹ä½¿ç”¨ Google ç™»å…¥æˆ–è·³éç™»å…¥ã€‚');
                        }
                    })
                    .catch(function(error) {
                        console.error('LINE Login error:', error);
                        alert(currentLanguage === 'en' ? 
                            'LINE login failed. Please try again or use Google login.' : 
                            'LINE ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦æˆ–ä½¿ç”¨ Google ç™»å…¥ã€‚');
                    });
            }
        }
        
        // ç¹¼çºŒåˆ°èŠå¤©å°è©±æ¡†
        function continueToChat() {
            const jwt = localStorage.getItem('jwt');
            if (!jwt) {
                alert(currentLanguage === 'en' ? 'Please login first.' : 'è«‹å…ˆç™»å…¥ã€‚');
                return;
            }
            
            // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦æœ‰ç•™å­¸éœ€æ±‚è³‡æ–™
            fetch(window.__CONFIG__.API_BASE + '/api/v1/user/check-profile', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + jwt,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.ok) {
                    if (result.has_profile) {
                        // å·²æœ‰ç•™å­¸éœ€æ±‚è³‡æ–™ï¼Œç›´æ¥é€²å…¥èŠå¤©
                        console.log('User has profile, going to chat');
                        showChatPage();
                    } else {
                        // æ²’æœ‰ç•™å­¸éœ€æ±‚è³‡æ–™ï¼Œè·³è½‰åˆ°è¨­å®šé é¢
                        console.log('User has no profile, going to setup');
                        showSetupPage();
                    }
                } else {
                    console.error('Error checking user profile:', result.error);
                    // å‡ºéŒ¯æ™‚ï¼Œå¦‚æœæœ‰æœ¬åœ° profileId å°±ç›´æ¥èŠå¤©ï¼Œå¦å‰‡è·³è½‰è¨­å®š
                    if (profileId) {
                        showChatPage();
                    } else {
                        showSetupPage();
                    }
                }
            })
            .catch(error => {
                console.error('Error checking user profile:', error);
                // å‡ºéŒ¯æ™‚ï¼Œå¦‚æœæœ‰æœ¬åœ° profileId å°±ç›´æ¥èŠå¤©ï¼Œå¦å‰‡è·³è½‰è¨­å®š
                if (profileId) {
                    showChatPage();
                } else {
                    showSetupPage();
                }
            });
        }
        
        // ç·¨è¼¯ç”¨æˆ¶è¨­å®š
        function editUserProfile() {
            console.log('editUserProfile called, profileId:', profileId);
            
            if (!profileId) {
                console.error('No profileId available');
                alert(currentLanguage === 'en' ? 
                    'No profile found. Please complete the setup first.' : 
                    'æ‰¾ä¸åˆ°è¨­å®šè³‡æ–™ã€‚è«‹å…ˆå®Œæˆè¨­å®šã€‚');
                return;
            }
            
            console.log('Attempting to fetch profile data for:', profileId);
            
            // ç²å–ç”¨æˆ¶è³‡æ–™ä¸¦é å¡«ç·¨è¼¯è¡¨å–®
            fetchUserProfileData(profileId)
                .then(profileData => {
                    console.log('Profile data fetched successfully:', profileData);
                    // é å¡«ç·¨è¼¯è¡¨å–®è³‡æ–™
                    prefillEditForm(profileData);
                    
                    // é¡¯ç¤ºç·¨è¼¯æ¨¡æ…‹æ¡†
                    document.getElementById('edit-profile-modal').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error loading profile data:', error);
                    alert(currentLanguage === 'en' ? 
                        'Failed to load profile data: ' + error : 
                        'è¼‰å…¥è¨­å®šè³‡æ–™å¤±æ•—ï¼š' + error);
                });
        }
        
        // é å¡«ç·¨è¼¯è¡¨å–®
        function prefillEditForm(profileData) {
            // è¨­å®šè§’è‰²
            if (profileData.user_role) {
                selectEditRole(profileData.user_role);
            }
            
            // é å¡«å­¸ç”Ÿè³‡æ–™
            if (profileData.student_name) {
                document.getElementById('edit_student_name').value = profileData.student_name;
            }
            if (profileData.student_email) {
                document.getElementById('edit_student_email').value = profileData.student_email;
            }
            if (profileData.citizenship) {
                document.getElementById('edit_citizenship').value = profileData.citizenship;
            }
            
            // é å¡«å®¶é•·è³‡æ–™
            if (profileData.parent_name) {
                document.getElementById('edit_parent_name').value = profileData.parent_name;
            }
            if (profileData.parent_email) {
                document.getElementById('edit_parent_email').value = profileData.parent_email;
            }
            if (profileData.relationship) {
                document.getElementById('edit_relationship').value = profileData.relationship;
            }
            if (profileData.child_name) {
                document.getElementById('edit_child_name').value = profileData.child_name;
            }
            if (profileData.child_email) {
                document.getElementById('edit_child_email').value = profileData.child_email;
            }
            
            // é å¡«å­¸è¡“èƒŒæ™¯
            if (profileData.gpa) {
                document.getElementById('edit_gpa').value = profileData.gpa;
            }
            if (profileData.degree) {
                document.getElementById('edit_degree').value = profileData.degree;
            }
            
            // é å¡«åœ‹å®¶é¸æ“‡
            if (profileData.countries) {
                var countries = typeof profileData.countries === 'string' ? 
                    JSON.parse(profileData.countries) : profileData.countries;
                countries.forEach(country => {
                    var checkbox = document.querySelector(`input[name="edit_countries"][value="${country}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }
            
            // é å¡«é ç®—å’Œæ™‚é–“
            if (profileData.budget) {
                document.getElementById('edit_budget').value = profileData.budget;
            }
            if (profileData.target_intake) {
                var intakeParts = profileData.target_intake.split(' ');
                if (intakeParts.length >= 2) {
                    document.getElementById('edit_intake_semester').value = intakeParts[0];
                    document.getElementById('edit_intake_year').value = intakeParts[1];
                }
            }
            
            console.log('Edit form prefilled with profile data:', profileData);
        }
        
        // ç·¨è¼¯è§’è‰²é¸æ“‡
        function selectEditRole(role) {
            document.getElementById('edit-role-student').classList.toggle('bg-blue-500', role === 'student');
            document.getElementById('edit-role-student').classList.toggle('bg-gray-300', role !== 'student');
            document.getElementById('edit-role-parent').classList.toggle('bg-blue-500', role === 'parent');
            document.getElementById('edit-role-parent').classList.toggle('bg-gray-300', role !== 'parent');

            // åˆ‡æ›æ¬„ä½é¡¯ç¤º
            document.getElementById('edit-student-fields').classList.toggle('hidden', role !== 'student');
            document.getElementById('edit-parent-fields').classList.toggle('hidden', role !== 'parent');
        }
        
        // å„²å­˜ç·¨è¼¯çš„è¨­å®š
        function saveEditedProfile() {
            var form = document.getElementById('edit-profile-form');
            var formData = new FormData(form);
            var data = {};
            
            // ç²å–é¸ä¸­çš„è§’è‰²
            var selectedRole = document.getElementById('edit-role-student').classList.contains('bg-blue-500') ? 'student' : 'parent';
            
            if (selectedRole === 'student') {
                data = {
                    student_name: formData.get('student_name'),
                    student_email: formData.get('student_email'),
                    citizenship: formData.get('citizenship'),
                    gpa: parseFloat(formData.get('gpa')),
                    degree: formData.get('degree'),
                    countries: getCheckedEditCountries(),
                    budget: parseInt(formData.get('budget')),
                    target_intake: formData.get('target_intake'),
                    user_role: selectedRole
                };
            } else {
                data = {
                    parent_name: formData.get('parent_name'),
                    parent_email: formData.get('parent_email'),
                    relationship: formData.get('relationship'),
                    child_name: formData.get('child_name'),
                    child_email: formData.get('child_email'),
                    gpa: parseFloat(formData.get('gpa')),
                    degree: formData.get('degree'),
                    countries: getCheckedEditCountries(),
                    budget: parseInt(formData.get('budget')),
                    target_intake: formData.get('target_intake'),
                    user_role: selectedRole
                };
            }

            try {
                var jwt = localStorage.getItem('jwt');
                if (!jwt) {
                    alert(currentLanguage === 'en' ? 'Please login first.' : 'è«‹å…ˆç™»å…¥ã€‚');
                    return;
                }
                
                var authHeader = { 'Authorization': 'Bearer ' + jwt };
                var headers = {
                    'Content-Type': 'application/json'
                };
                for (var key in authHeader) {
                    headers[key] = authHeader[key];
                }
                
                // ç™¼é€æ›´æ–°è«‹æ±‚åˆ°å¾Œç«¯
                fetch(window.__CONFIG__.API_BASE + '/api/v1/user/update-profile/' + profileId, {
                    method: 'PUT',
                    headers: headers,
                    body: JSON.stringify(data)
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    if (result.ok) {
                        alert(currentLanguage === 'en' ? 
                            'Profile updated successfully!' : 
                            'è¨­å®šå·²æˆåŠŸæ›´æ–°ï¼');
                        closeEditProfile();
                    } else {
                        alert('æ›´æ–°å¤±æ•—ï¼š' + result.error);
                    }
                })
                .catch(function(error) {
                    console.error('Profile update failed:', error);
                    alert('æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
                });
            } catch (error) {
                console.error('Profile update failed:', error);
                alert('æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
            }
        }
        
        // ç²å–ç·¨è¼¯è¡¨å–®ä¸­é¸ä¸­çš„åœ‹å®¶
        function getCheckedEditCountries() {
            var countries = [];
            var checkboxes = document.querySelectorAll('input[name="edit_countries"]:checked');
            for (var i = 0; i < checkboxes.length; i++) {
                countries.push(checkboxes[i].value);
            }
            return countries;
        }
        
        // é—œé–‰ç·¨è¼¯è¨­å®šæ¨¡æ…‹æ¡†
        function closeEditProfile() {
            document.getElementById('edit-profile-modal').classList.add('hidden');
        }
        
        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰ç·¨è¼¯è¨­å®š
        function closeEditProfileOnOutside(event) {
            if (event.target === event.currentTarget) {
                closeEditProfile();
            }
        }
        
        // æŸ¥è©¢å­¸ç”Ÿé€²åº¦
        function queryStudentProgress() {
            const jwt = localStorage.getItem('jwt');
            if (!jwt) {
                alert(currentLanguage === 'en' ? 'Please login first.' : 'è«‹å…ˆç™»å…¥ã€‚');
                return;
            }
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            document.getElementById('progress-content').innerHTML = 
                '<div class="text-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div><p class="mt-2">è¼‰å…¥ä¸­...</p></div>';
            
            // é¡¯ç¤ºæ¨¡æ…‹æ¡†
            document.getElementById('student-progress-modal').classList.remove('hidden');
            
            fetch(window.__CONFIG__.API_BASE + '/api/v1/parent/student-progress', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + jwt,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.ok) {
                    displayStudentProgress(result.data);
                } else {
                    document.getElementById('progress-content').innerHTML = 
                        '<div class="text-center py-8 text-red-500">æŸ¥è©¢å¤±æ•—ï¼š' + result.error + '</div>';
                }
            })
            .catch(error => {
                console.error('Error querying student progress:', error);
                document.getElementById('progress-content').innerHTML = 
                    '<div class="text-center py-8 text-red-500">æŸ¥è©¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥</div>';
            });
        }
        
        // é¡¯ç¤ºå­¸ç”Ÿé€²åº¦
        function displayStudentProgress(data) {
            const content = document.getElementById('progress-content');
            
            if (!data.student_found) {
                content.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-gray-500 mb-4">ğŸ“š</div>
                        <h3 class="text-lg font-semibold mb-2">æœªæ‰¾åˆ°å­¸ç”Ÿè³‡æ–™</h3>
                        <p class="text-gray-600">${data.message}</p>
                    </div>
                `;
                return;
            }
            
            const student = data.student_info;
            const stats = data.activity_stats;
            const progress = data.progress_analysis;
            
            // é€²åº¦ç­‰ç´šé¡è‰²
            const progressColors = {
                'beginner': 'bg-yellow-100 text-yellow-800',
                'intermediate': 'bg-blue-100 text-blue-800',
                'advanced': 'bg-green-100 text-green-800'
            };
            
            // æ´»èºåº¦é¡è‰²
            const activityColors = {
                'low': 'bg-red-100 text-red-800',
                'medium': 'bg-yellow-100 text-yellow-800',
                'high': 'bg-green-100 text-green-800'
            };
            
            content.innerHTML = `
                <!-- å­¸ç”ŸåŸºæœ¬è³‡è¨Š -->
                <div class="bg-gray-50 p-4 rounded-lg mb-6">
                    <h3 class="text-lg font-semibold mb-3">ğŸ‘¨â€ğŸ“ å­¸ç”Ÿè³‡è¨Š</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">å§“å</p>
                            <p class="font-medium">${student.name}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">é›»å­éƒµä»¶</p>
                            <p class="font-medium">${student.email}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">è¨»å†Šæ™‚é–“</p>
                            <p class="font-medium">${new Date(student.profile_created).toLocaleDateString()}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">æœ€å¾Œæ›´æ–°</p>
                            <p class="font-medium">${new Date(student.last_updated).toLocaleDateString()}</p>
                        </div>
                    </div>
                </div>
                
                <!-- æ´»å‹•çµ±è¨ˆ -->
                <div class="bg-blue-50 p-4 rounded-lg mb-6">
                    <h3 class="text-lg font-semibold mb-3">ğŸ“Š æ´»å‹•çµ±è¨ˆ</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="text-center">
                            <p class="text-2xl font-bold text-blue-600">${stats.total_messages}</p>
                            <p class="text-sm text-gray-600">ç¸½è¨Šæ¯æ•¸</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-green-600">${stats.active_days}</p>
                            <p class="text-sm text-gray-600">æ´»èºå¤©æ•¸</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-purple-600">${progress.engagement_score}</p>
                            <p class="text-sm text-gray-600">åƒèˆ‡åº¦è©•åˆ†</p>
                        </div>
                    </div>
                </div>
                
                <!-- é€²åº¦åˆ†æ -->
                <div class="bg-green-50 p-4 rounded-lg mb-6">
                    <h3 class="text-lg font-semibold mb-3">ğŸ“ˆ é€²åº¦åˆ†æ</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">é€²åº¦ç­‰ç´š</p>
                            <span class="px-3 py-1 rounded-full text-sm font-medium ${progressColors[progress.progress_level]}">
                                ${progress.progress_level === 'beginner' ? 'åˆå­¸è€…' : 
                                  progress.progress_level === 'intermediate' ? 'ä¸­ç´š' : 'é«˜ç´š'}
                            </span>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 mb-1">æ´»èºåº¦</p>
                            <span class="px-3 py-1 rounded-full text-sm font-medium ${activityColors[progress.activity_level]}">
                                ${progress.activity_level === 'low' ? 'ä½' : 
                                  progress.activity_level === 'medium' ? 'ä¸­ç­‰' : 'é«˜'}
                            </span>
                        </div>
                    </div>
                    
                    <!-- å»ºè­° -->
                    <div>
                        <p class="text-sm text-gray-600 mb-2">ğŸ’¡ å»ºè­°</p>
                        <ul class="space-y-1">
                            ${progress.suggestions.map(suggestion => `<li class="text-sm">â€¢ ${suggestion}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                
                <!-- æœ€è¿‘è©±é¡Œ -->
                ${data.recent_topics.length > 0 ? `
                <div class="bg-purple-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3">ğŸ’¬ æœ€è¿‘è«®è©¢è©±é¡Œ</h3>
                    <div class="space-y-3">
                        ${data.recent_topics.slice(0, 3).map(topic => `
                            <div class="bg-white p-3 rounded border">
                                <p class="text-sm text-gray-700 mb-1">${topic.content}</p>
                                <p class="text-xs text-gray-500">${new Date(topic.time).toLocaleString()}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            `;
        }
        
        // é—œé–‰å­¸ç”Ÿé€²åº¦æ¨¡æ…‹æ¡†
        function closeStudentProgress() {
            document.getElementById('student-progress-modal').classList.add('hidden');
        }
        
        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰å­¸ç”Ÿé€²åº¦
        function closeStudentProgressOnOutside(event) {
            if (event.target === event.currentTarget) {
                closeStudentProgress();
            }
        }
        
        // æ ¹æ“šç”¨æˆ¶è§’è‰²é¡¯ç¤ºç›¸æ‡‰æŒ‰éˆ•
        function showRoleSpecificButtons() {
            const queryProgressBtn = document.getElementById('query-progress-btn');
            
            // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦ç‚ºå®¶é•·
            if (currentRole === 'parent') {
                queryProgressBtn.classList.remove('hidden');
            } else {
                queryProgressBtn.classList.add('hidden');
            }
        }
        
        // é å¡«è¨­å®šè¡¨å–®
        function prefillSetupForm(profileData) {
            // è¨­å®šè§’è‰²
            if (profileData.user_role) {
                selectRole(profileData.user_role);
            }
            
            // é å¡«å­¸ç”Ÿè³‡æ–™
            if (profileData.student_name) {
                document.getElementById('student_name').value = profileData.student_name;
            }
            if (profileData.student_email) {
                document.getElementById('student_email').value = profileData.student_email;
            }
            if (profileData.citizenship) {
                document.getElementById('citizenship').value = profileData.citizenship;
            }
            
            // é å¡«å®¶é•·è³‡æ–™
            if (profileData.parent_name) {
                document.getElementById('parent_name').value = profileData.parent_name;
            }
            if (profileData.parent_email) {
                document.getElementById('parent_email').value = profileData.parent_email;
            }
            if (profileData.relationship) {
                document.getElementById('relationship').value = profileData.relationship;
            }
            if (profileData.child_name) {
                document.getElementById('child_name').value = profileData.child_name;
            }
            if (profileData.child_email) {
                document.getElementById('child_email').value = profileData.child_email;
            }
            
            // é å¡«å­¸è¡“èƒŒæ™¯
            if (profileData.gpa) {
                document.getElementById('gpa').value = profileData.gpa;
            }
            if (profileData.degree) {
                document.getElementById('degree').value = profileData.degree;
            }
            
            // é å¡«åœ‹å®¶é¸æ“‡
            if (profileData.countries) {
                var countries = typeof profileData.countries === 'string' ? 
                    JSON.parse(profileData.countries) : profileData.countries;
                countries.forEach(country => {
                    var checkbox = document.querySelector(`input[value="${country}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }
            
            // é å¡«é ç®—å’Œæ™‚é–“
            if (profileData.budget) {
                document.getElementById('budget').value = profileData.budget;
            }
            if (profileData.target_intake) {
                var intakeParts = profileData.target_intake.split(' ');
                if (intakeParts.length >= 2) {
                    document.getElementById('intake_semester').value = intakeParts[0];
                    document.getElementById('intake_year').value = intakeParts[1];
                }
            }
            
            console.log('Form prefilled with profile data:', profileData);
        }
        
        // é–‹å•Ÿç”¨æˆ¶è¨­å®šé é¢
        function openUserSettings() {
            // é¡¯ç¤ºç”¨æˆ¶è¨­å®šæ¨¡æ…‹æ¡†
            document.getElementById('user-settings-modal').classList.remove('hidden');
            loadUserSettings();
        }
        
        // è¼‰å…¥ç”¨æˆ¶è¨­å®š
        function loadUserSettings() {
            const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            const jwt = localStorage.getItem('jwt');
            
            if (!jwt || !userProfile) {
                alert(currentLanguage === 'en' ? 
                    'Please login first.' : 
                    'è«‹å…ˆç™»å…¥ã€‚');
                return;
            }
            
            // è¼‰å…¥ç”¨æˆ¶åŸºæœ¬è³‡è¨Š
            document.getElementById('settings-user-avatar').src = userProfile.avatar || 'https://via.placeholder.com/80';
            document.getElementById('settings-user-name').textContent = userProfile.name || 'Unknown User';
            document.getElementById('settings-user-email').textContent = userProfile.email || '';
            
            // è¼‰å…¥è¨­å®šå€¼
            document.getElementById('settings-display-name').value = userProfile.name || '';
            document.getElementById('settings-language').value = currentLanguage;
            
            // å¾å¾Œç«¯è¼‰å…¥é€šçŸ¥è¨­å®š
            loadNotificationSettings();
            
            // å˜—è©¦è¼‰å…¥ç”¨æˆ¶çš„ç•™å­¸éœ€æ±‚è³‡æ–™
            loadUserProfileData();
            
            // æ ¹æ“šç”¨æˆ¶è§’è‰²é¡¯ç¤ºç›¸æ‡‰æŒ‰éˆ•
            showRoleSpecificButtons();
        }
        
        // è¼‰å…¥ç”¨æˆ¶çš„ç•™å­¸éœ€æ±‚è³‡æ–™
        function loadUserProfileData() {
            const jwt = localStorage.getItem('jwt');
            if (!jwt) return;
            
            const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            
            // å¦‚æœæœ‰ profileIdï¼Œç›´æ¥è¼‰å…¥
            if (profileId) {
                fetchUserProfileData(profileId)
                    .then(profileData => {
                        console.log('Profile data loaded successfully:', profileData);
                        // å¯ä»¥åœ¨é€™è£¡æ›´æ–° UI é¡¯ç¤ºç”¨æˆ¶çš„ç•™å­¸éœ€æ±‚è³‡æ–™
                    })
                    .catch(error => {
                        console.error('Error loading profile data:', error);
                        showProfileDataMessage(error);
                    });
            } else {
                // å¦‚æœæ²’æœ‰ profileIdï¼Œå˜—è©¦å¾å¾Œç«¯ç²å–ç”¨æˆ¶çš„æ‰€æœ‰ profile
                fetch(window.__CONFIG__.API_BASE + '/api/v1/user/check-profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + jwt,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.ok && result.has_profile && result.profile_id) {
                        // æ›´æ–° profileId ä¸¦è¼‰å…¥è³‡æ–™
                        profileId = result.profile_id;
                        if (userProfile.userId) {
                            localStorage.setItem('profileId_' + userProfile.userId, profileId);
                        }
                        
                        fetchUserProfileData(profileId)
                            .then(profileData => {
                                console.log('Profile data loaded successfully:', profileData);
                            })
                            .catch(error => {
                                console.error('Error loading profile data:', error);
                                showProfileDataMessage(error);
                            });
                    } else {
                        console.log('User has no profile data yet');
                        // é¡¯ç¤ºæç¤ºç”¨æˆ¶å¡«å¯«ç•™å­¸éœ€æ±‚çš„è¨Šæ¯
                        showProfileDataMessage('æ‚¨é‚„æ²’æœ‰å¡«å¯«ç•™å­¸éœ€æ±‚è³‡æ–™ï¼Œè«‹å…ˆå¡«å¯«ã€Œè¨­å®šæ‚¨çš„ç•™å­¸éœ€æ±‚ã€è¡¨å–®ã€‚');
                    }
                })
                .catch(error => {
                    console.error('Error checking user profile:', error);
                });
            }
        }
        
        // é¡¯ç¤ºç”¨æˆ¶è³‡æ–™è¨Šæ¯
        function showProfileDataMessage(message) {
            // åœ¨ç”¨æˆ¶è¨­å®šæ¨¡æ…‹æ¡†ä¸­é¡¯ç¤ºè¨Šæ¯
            const settingsModal = document.getElementById('user-settings-modal');
            if (settingsModal) {
                // å‰µå»ºæˆ–æ›´æ–°è¨Šæ¯é¡¯ç¤ºå€åŸŸ
                let messageDiv = document.getElementById('profile-data-message');
                if (!messageDiv) {
                    messageDiv = document.createElement('div');
                    messageDiv.id = 'profile-data-message';
                    messageDiv.className = 'bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4';
                    
                    // æ’å…¥åˆ°ç”¨æˆ¶è¨­å®šæ¨¡æ…‹æ¡†çš„å…§å®¹å€åŸŸ
                    const settingsContent = settingsModal.querySelector('.bg-white');
                    if (settingsContent) {
                        settingsContent.insertBefore(messageDiv, settingsContent.firstChild);
                    }
                }
                
                messageDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-800">${message}</p>
                        </div>
                    </div>
                `;
            }
        }
        
        // å¾å¾Œç«¯è¼‰å…¥é€šçŸ¥è¨­å®š
        function loadNotificationSettings() {
            const jwt = localStorage.getItem('jwt');
            if (!jwt) return;
            
            fetch(window.__CONFIG__.API_BASE + '/api/v1/user/notification-settings', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + jwt,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.ok && result.data) {
                    document.getElementById('settings-email-notifications').checked = result.data.email_notifications;
                    document.getElementById('settings-push-notifications').checked = result.data.push_notifications;
                    
                    // è¨­å®šé€šçŸ¥é »ç‡ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                    const frequencySelect = document.getElementById('settings-notification-frequency');
                    if (frequencySelect) {
                        frequencySelect.value = result.data.notification_frequency || 'daily';
                    }
                }
            })
            .catch(error => {
                console.error('Error loading notification settings:', error);
                // ä½¿ç”¨é è¨­å€¼
                document.getElementById('settings-email-notifications').checked = false;
                document.getElementById('settings-push-notifications').checked = true;
            });
        }
        
        // å„²å­˜ç”¨æˆ¶è¨­å®š
        function saveUserSettings() {
            const jwt = localStorage.getItem('jwt');
            if (!jwt) {
                alert(currentLanguage === 'en' ? 'Please login first.' : 'è«‹å…ˆç™»å…¥ã€‚');
                return;
            }
            
            const settings = {
                displayName: document.getElementById('settings-display-name').value,
                language: document.getElementById('settings-language').value,
                emailNotifications: document.getElementById('settings-email-notifications').checked,
                pushNotifications: document.getElementById('settings-push-notifications').checked,
                profilePublic: document.getElementById('settings-profile-public').checked,
                dataCollection: document.getElementById('settings-data-collection').checked,
                updatedAt: new Date().toISOString()
            };
            
            // å„²å­˜é€šçŸ¥è¨­å®šåˆ°å¾Œç«¯
            const notificationSettings = {
                email_notifications: settings.emailNotifications,
                push_notifications: settings.pushNotifications,
                notification_frequency: 'daily' // é è¨­å€¼
            };
            
            fetch(window.__CONFIG__.API_BASE + '/api/v1/user/notification-settings', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + jwt,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(notificationSettings)
            })
            .then(response => response.json())
            .then(result => {
                if (result.ok) {
                    console.log('Notification settings saved to backend');
                } else {
                    console.error('Failed to save notification settings:', result.error);
                }
            })
            .catch(error => {
                console.error('Error saving notification settings:', error);
            });
            
            // å„²å­˜åˆ°æœ¬åœ°å„²å­˜
            localStorage.setItem('userSettings', JSON.stringify(settings));
            
            // æ›´æ–°ç”¨æˆ¶è³‡æ–™
            const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            userProfile.name = settings.displayName;
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            
            // æ›´æ–°èªè¨€è¨­å®š
            if (settings.language !== currentLanguage) {
                currentLanguage = settings.language;
                switchLanguage(currentLanguage);
            }
            
            // æ›´æ–°é¡¯ç¤ºçš„ç”¨æˆ¶åç¨±
            document.getElementById('user-name').textContent = settings.displayName;
            
            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            alert(currentLanguage === 'en' ? 
                'Settings saved successfully!' : 
                'è¨­å®šå·²æˆåŠŸå„²å­˜ï¼');
            
            // é—œé–‰è¨­å®šæ¨¡æ…‹æ¡†
            closeUserSettings();
        }
        
        // é—œé–‰ç”¨æˆ¶è¨­å®š
        function closeUserSettings() {
            document.getElementById('user-settings-modal').classList.add('hidden');
        }
        
        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        function closeUserSettingsOnOutside(event) {
            if (event.target === event.currentTarget) {
                closeUserSettings();
            }
        }
        
        // ç™»å‡ºåŠŸèƒ½
        function logout() {
            // é—œé–‰ SSE é€£ç·š
            closeStream();
            
            // æ¸…é™¤æœ¬åœ°å„²å­˜
            localStorage.removeItem('jwt');
            localStorage.removeItem('userProfile');
            
            // æ¸…é™¤ Cookie
            clearJWTCookie();
            
            // é¡¯ç¤ºç™»å‡ºæˆåŠŸè¨Šæ¯
            alert(currentLanguage === 'en' ? 
                'You have been logged out successfully.' : 
                'æ‚¨å·²æˆåŠŸç™»å‡ºã€‚');
            
            // é‡æ–°è¼‰å…¥é é¢
            window.location.href = 'https://aistudent.zeabur.app';
        }


        // è·³éç™»å…¥
        function skipLogin() {
            // å‰µå»ºä¸€å€‹å‡çš„ JWT token ç”¨æ–¼æ¸¬è©¦
            var fakeToken = 'fake-jwt-token-for-testing';
            localStorage.setItem('jwt', fakeToken);
            
            // åŒæ™‚è¨­ç½® Cookie ç”¨æ–¼ SSE èªè­‰
            setJWTCookie(fakeToken);
            
            // å‰µå»ºä¸€å€‹å‡çš„ç”¨æˆ¶è³‡æ–™
            var fakeUser = {
                userId: 'test-user',
                email: 'test@example.com',
                name: 'æ¸¬è©¦ç”¨æˆ¶',
                avatar: 'https://via.placeholder.com/80'
            };
            localStorage.setItem('userProfile', JSON.stringify(fakeUser));
            
            // ç›´æ¥é€²å…¥èŠå¤©ï¼Œä¸éœ€è¦è¨­å®šé é¢
            showChatPage();
        }


        // åˆå§‹åŒ–å¹´ä»½é¸é …
        function initializeYearOptions() {
            var yearSelect = document.getElementById('intake_year');
            var currentYear = new Date().getFullYear();
            
            // ç”Ÿæˆæœªä¾† 5 å¹´çš„é¸é …
            for (var i = 0; i < 5; i++) {
                var year = currentYear + i;
                var option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                option.setAttribute('data-zh', year);
                option.setAttribute('data-en', year);
                yearSelect.appendChild(option);
            }
        }

        // æ›´æ–°ç›®æ¨™å…¥å­¸æ™‚é–“
        function updateTargetIntake() {
            var semester = document.getElementById('intake_semester').value;
            var year = document.getElementById('intake_year').value;
            var targetIntakeInput = document.getElementById('target_intake');
            
            if (semester && year) {
                var semesterText = currentLanguage === 'en' 
                    ? semester.charAt(0).toUpperCase() + semester.slice(1)
                    : semester === 'fall' ? 'ç§‹å­£' : semester === 'spring' ? 'æ˜¥å­£' : semester === 'summer' ? 'å¤å­£' : 'å†¬å­£';
                
                var intakeText = currentLanguage === 'en' 
                    ? semesterText + ' ' + year
                    : year + 'å¹´' + semesterText;
                
                targetIntakeInput.value = intakeText;
            } else {
                targetIntakeInput.value = '';
            }
        }

        // èªè¨€åˆ‡æ›
        function switchLanguage(lang) {
            currentLanguage = lang;
            // æ›´æ–°æ‰€æœ‰å…·å‚™ data-zh / data-en çš„å…ƒç´ 
            var elements = document.querySelectorAll('[data-zh]');
            for (var i = 0; i < elements.length; i++) {
                var el = elements[i];
                var text = el.getAttribute('data-' + currentLanguage);
                if (text) el.textContent = text;
            }
            // æ›´æ–° placeholder
            var inputs = document.querySelectorAll('[data-zh-ph]');
            for (var j = 0; j < inputs.length; j++) {
                var input = inputs[j];
                var placeholder = input.getAttribute('data-' + currentLanguage + '-ph');
                if (placeholder) input.placeholder = placeholder;
            }
            // æ›´æ–° select é¸é …
            var options = document.querySelectorAll('option[data-zh]');
            for (var k = 0; k < options.length; k++) {
                var option = options[k];
                var text = option.getAttribute('data-' + currentLanguage);
                if (text) option.textContent = text;
            }
            
            // æ›´æ–°ç›®æ¨™å…¥å­¸æ™‚é–“é¡¯ç¤º
            updateTargetIntake();
            
            // æ›´æ–°èªè¨€åˆ‡æ›æŒ‰éˆ•æ¨£å¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            var zhBtn = document.getElementById('lang-switch-zh');
            var enBtn = document.getElementById('lang-switch-en');
            if (zhBtn && enBtn) {
                zhBtn.classList.toggle('bg-blue-500', lang === 'zh');
                zhBtn.classList.toggle('bg-gray-200', lang !== 'zh');
                zhBtn.classList.toggle('text-white', lang === 'zh');
                zhBtn.classList.toggle('text-gray-700', lang !== 'zh');
                enBtn.classList.toggle('bg-blue-500', lang === 'en');
                enBtn.classList.toggle('bg-gray-200', lang !== 'en');
                enBtn.classList.toggle('text-white', lang === 'en');
                enBtn.classList.toggle('text-gray-700', lang !== 'en');
            }
            
            // é‡æ–°è¼‰å…¥å¿«é€Ÿå‹•ä½œæŒ‰éˆ•
            loadQuickActions();
        }

        // è§’è‰²é¸æ“‡
        function selectRole(role) {
            currentRole = role;
            document.getElementById('role-student').classList.toggle('bg-blue-500', role === 'student');
            document.getElementById('role-student').classList.toggle('bg-gray-300', role !== 'student');
            document.getElementById('role-parent').classList.toggle('bg-blue-500', role === 'parent');
            document.getElementById('role-parent').classList.toggle('bg-gray-300', role !== 'parent');

            // åˆ‡æ›æ¬„ä½é¡¯ç¤º
            document.getElementById('student-fields').classList.toggle('hidden', role !== 'student');
            document.getElementById('parent-fields').classList.toggle('hidden', role !== 'parent');
            loadQuickActions();
        }

        // é é¢åˆ‡æ›
        function showLoginPage() {
            try {
                console.log('Showing login page...');
                
                // å¼·åˆ¶éš±è—æ‰€æœ‰é é¢ï¼ˆå…¼å®¹æ‰€æœ‰ç€è¦½å™¨ï¼‰
                var pages = ['setup-page', 'chat-page', 'user-info-page'];
                pages.forEach(function(pageId) {
                    var page = document.getElementById(pageId);
                    if (page) {
                        page.style.display = 'none';
                        page.classList.add('hidden');
                    }
                });
                
                // é¡¯ç¤ºç™»å…¥é é¢
                var loginPage = document.getElementById('login-page');
                if (loginPage) {
                    loginPage.style.display = 'block';
                    loginPage.classList.remove('hidden');
                }
                
                // ç¢ºä¿é é¢æ»¾å‹•åˆ°é ‚éƒ¨ï¼ˆå…¼å®¹æ‰€æœ‰ç€è¦½å™¨ï¼‰
                if (window.scrollTo) {
                    window.scrollTo(0, 0);
                } else if (document.documentElement.scrollTop !== undefined) {
                    document.documentElement.scrollTop = 0;
                } else if (document.body.scrollTop !== undefined) {
                    document.body.scrollTop = 0;
                }
                
                console.log('Login page shown successfully');
            } catch (error) {
                console.error('Error showing login page:', error);
                // é™ç´šè™•ç†ï¼šç›´æ¥é‡æ–°è¼‰å…¥é é¢
                window.location.reload();
            }
        }

        function validateToken(token) {
            // ç°¡å–®çš„ token é©—è­‰ï¼Œæª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„ JWT æ ¼å¼
            try {
                var parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid token format');
                }
                
                // æª¢æŸ¥ token æ˜¯å¦éæœŸï¼ˆç°¡å–®æª¢æŸ¥ï¼‰
                var payload = JSON.parse(atob(parts[1]));
                var currentTime = Math.floor(Date.now() / 1000);
                
                if (payload.exp && payload.exp < currentTime) {
                    throw new Error('Token expired');
                }
                
                // Token æœ‰æ•ˆï¼Œæª¢æŸ¥æ˜¯å¦æœ‰ç”¨æˆ¶è³‡æ–™ä¸¦é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
                var userProfile = localStorage.getItem('userProfile');
                if (userProfile) {
                    try {
                        var user = JSON.parse(userProfile);
                        showUserInfo(user);
                    } catch (e) {
                        console.error('Error parsing user profile:', e);
                        showLoginButtons();
                    }
                } else {
                    showLoginButtons();
                }
            } catch (error) {
                console.log('Token validation failed:', error);
                // Token ç„¡æ•ˆï¼Œæ¸…é™¤ä¸¦é¡¯ç¤ºç™»å…¥é é¢
                localStorage.removeItem('jwt');
                showLoginButtons();
            }
        }

        function showSetupPage() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('setup-page').classList.remove('hidden');
            document.getElementById('chat-page').classList.add('hidden');
        }

        function showChatPage() {
            try {
                // å¼·åˆ¶éš±è—æ‰€æœ‰é é¢ï¼ˆå…¼å®¹æ‰€æœ‰ç€è¦½å™¨ï¼‰
                var pages = ['login-page', 'setup-page', 'user-info-page'];
                pages.forEach(function(pageId) {
                    var page = document.getElementById(pageId);
                    if (page) {
                        page.style.display = 'none';
                        page.classList.add('hidden');
                    }
                });
                
                // é¡¯ç¤ºèŠå¤©é é¢
                var chatPage = document.getElementById('chat-page');
                if (chatPage) {
                    chatPage.style.display = 'block';
                    chatPage.classList.remove('hidden');
                }
                
                // ç¢ºä¿é é¢æ»¾å‹•åˆ°é ‚éƒ¨ï¼ˆå…¼å®¹æ‰€æœ‰ç€è¦½å™¨ï¼‰
                if (window.scrollTo) {
                    window.scrollTo(0, 0);
                } else if (document.documentElement.scrollTop !== undefined) {
                    document.documentElement.scrollTop = 0;
                } else if (document.body.scrollTop !== undefined) {
                    document.body.scrollTop = 0;
                }
                
                // æ›´æ–°èŠå¤©é é¢çš„èªè¨€
                if (typeof switchLanguage === 'function') {
                    switchLanguage(currentLanguage);
                }
                
                if (typeof loadQuickActions === 'function') {
                    loadQuickActions();
                }
                
                // å…ˆè¼‰å…¥å°è©±æ­·å²ï¼Œç„¶å¾Œæ±ºå®šæ˜¯å¦ç™¼é€æ­¡è¿è¨Šæ¯
                if (typeof loadChatHistory === 'function') {
                    loadChatHistory();
                }
                
                console.log('Chat page shown successfully');
            } catch (error) {
                console.error('Error showing chat page:', error);
                alert('é é¢åˆ‡æ›å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦');
            }
        }

        // è™•ç†è¨­å®šæäº¤
        function handleSetupSubmit(e) {
            e.preventDefault();
            
            var formData = new FormData(e.target);
            var data = {};
            
            if (currentRole === 'student') {
                data = {
                    student_name: formData.get('student_name'),
                    student_email: formData.get('student_email'),
                    citizenship: formData.get('citizenship'),
                    gpa: parseFloat(formData.get('gpa')),
                    degree: formData.get('degree'),
                    countries: getCheckedCountries(),
                    budget: parseInt(formData.get('budget')),
                    target_intake: formData.get('target_intake'),
                    user_role: currentRole
                };
            } else {
                data = {
                    parent_name: formData.get('parent_name'),
                    parent_email: formData.get('parent_email'),
                    relationship: formData.get('relationship'),
                    child_name: formData.get('child_name'),
                    child_email: formData.get('child_email'),
                    gpa: parseFloat(formData.get('gpa')),
                    degree: formData.get('degree'),
                    countries: getCheckedCountries(),
                    budget: parseInt(formData.get('budget')),
                    target_intake: formData.get('target_intake'),
                    user_role: currentRole
                };
            }

            try {
                // æª¢æŸ¥æ˜¯å¦æœ‰ JWT token
                var jwt = localStorage.getItem('jwt');
                if (!jwt) {
                    alert(currentLanguage === 'en' ? 'Please login first or skip login to continue.' : 'è«‹å…ˆç™»å…¥æˆ–è·³éç™»å…¥ç¹¼çºŒ');
                    return;
                }
                
                var authHeader = { 'Authorization': 'Bearer ' + jwt };
                var headers = {
                    'Content-Type': 'application/json'
                };
                for (var key in authHeader) {
                    headers[key] = authHeader[key];
                }
                
                fetch(window.__CONFIG__.API_BASE + '/api/v1/intake', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(data)
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    console.log('Setup submission result:', result);
                    if (result.ok) {
                        profileId = result.data.profile_id;
                        console.log('Profile ID received:', profileId);
                        
                        // å„²å­˜ profileId åˆ°æœ¬åœ°å„²å­˜
                        var userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                        if (userProfile.userId) {
                            saveProfileId(userProfile.userId, profileId);
                        }
                        
                        // æ·»åŠ å»¶é²ç¢ºä¿ DOM æ›´æ–°å®Œæˆ
                        setTimeout(function() {
                            showChatPage();
                        }, 100);
                    } else {
                        console.error('Setup submission failed:', result.error);
                        alert('æäº¤å¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                    }
                })
                .catch(function(error) {
                    console.error('Setup submission failed:', error);
                    alert('æäº¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥ï¼š' + error.message);
                });
            } catch (error) {
                console.error('Setup submission failed:', error);
                alert('æäº¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
            }
        }
        
        // ç²å–é¸ä¸­çš„åœ‹å®¶
        function getCheckedCountries() {
            var countries = [];
            var checkboxes = document.querySelectorAll('input[name="countries"]:checked');
            for (var i = 0; i < checkboxes.length; i++) {
                countries.push(checkboxes[i].value);
            }
            return countries;
        }

        // ç™¼é€æ¶ˆæ¯
        function sendMessage() {
            var input = document.getElementById('message-input');
            var message = input.value.trim();
            
            if (!message) return;

            // ç¦ç”¨ç™¼é€æŒ‰éˆ•
            var sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'ç™¼é€ä¸­...';

            // æ·»åŠ ç”¨æˆ¶æ¶ˆæ¯åˆ°èŠå¤©
            var userMessageId = addMessage(message, 'user');
            input.value = '';

            // é¡¯ç¤º AI è¼‰å…¥å‹•ç•«
            showAILoading();

            // æª¢æŸ¥æ˜¯å¦æœ‰ profileIdï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨ç©ºå€¼
            console.log('Sending message with profileId:', profileId);

            // å‰µå»º AI å›æ‡‰è¨Šæ¯æ°£æ³¡ï¼ˆç©ºå…§å®¹ï¼‰
            var aiMessageId = addMessage('', 'ai', false);

            // å˜—è©¦ä½¿ç”¨ SSE ä¸²æµ
            startStreaming(message, aiMessageId)
                .then(function(fullResponse) {
                    console.log('SSE stream completed successfully');
                    hideAILoading();
                    
                    // é‡æ–°å•Ÿç”¨ç™¼é€æŒ‰éˆ•
                    sendBtn.disabled = false;
                    sendBtn.textContent = currentLanguage === 'en' ? 'Send' : 'ç™¼é€';
                })
                .catch(function(error) {
                    console.warn('SSE failed, falling back to regular API:', error);
                    hideAILoading();
                    
                    // Fallback åˆ°åŸæœ¬çš„ POST API
                    fallbackToRegularAPI(message, aiMessageId)
                        .finally(function() {
                            // é‡æ–°å•Ÿç”¨ç™¼é€æŒ‰éˆ•
                            sendBtn.disabled = false;
                            sendBtn.textContent = currentLanguage === 'en' ? 'Send' : 'ç™¼é€';
                        });
                });
        }
        
        // Fallback åˆ°åŸæœ¬çš„ POST API
        function fallbackToRegularAPI(message, aiMessageId) {
            return new Promise(function(resolve, reject) {
                try {
                    var authHeader = {};
                    var jwt = localStorage.getItem('jwt');
                    if (jwt) {
                        authHeader['Authorization'] = 'Bearer ' + jwt;
                    }
                    
                    var headers = {
                        'Content-Type': 'application/json'
                    };
                    for (var key in authHeader) {
                        headers[key] = authHeader[key];
                    }
                    
                    console.log('Fallback: Sending chat request with:', {
                        profile_id: profileId,
                        message: message,
                        user_role: currentRole,
                        language: currentLanguage
                    });
                    
                    fetch(window.__CONFIG__.API_BASE + '/api/v1/chat', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({
                            profile_id: profileId,
                            message: message,
                            user_role: currentRole,
                            language: currentLanguage
                        })
                    })
                    .then(function(response) {
                        return response.json();
                    })
                    .then(function(result) {
                        console.log('Fallback chat response:', result);
                        
                        if (result.ok && result.reply) {
                            // æ›´æ–° AI å›æ‡‰å…§å®¹
                            var messageElement = document.getElementById(aiMessageId);
                            if (messageElement) {
                                var contentElement = messageElement.querySelector('.message-content');
                                if (contentElement) {
                                    contentElement.textContent = result.reply;
                                }
                            }
                            resolve(result.reply);
                        } else {
                            console.error('Invalid fallback response:', result);
                            var errorMsg = 'æŠ±æ­‰ï¼Œæˆ‘ç„¡æ³•è™•ç†æ‚¨çš„è«‹æ±‚ã€‚è«‹ç¨å¾Œå†è©¦ã€‚';
                            var messageElement = document.getElementById(aiMessageId);
                            if (messageElement) {
                                var contentElement = messageElement.querySelector('.message-content');
                                if (contentElement) {
                                    contentElement.textContent = errorMsg;
                                }
                            }
                            reject(new Error('Invalid response'));
                        }
                    })
                    .catch(function(error) {
                        console.error('Fallback chat failed:', error);
                        var errorMsg = 'æŠ±æ­‰ï¼Œç¶²è·¯é€£æ¥å‡ºç¾å•é¡Œã€‚è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£æ¥ã€‚';
                        var messageElement = document.getElementById(aiMessageId);
                        if (messageElement) {
                            var contentElement = messageElement.querySelector('.message-content');
                            if (contentElement) {
                                contentElement.textContent = errorMsg;
                            }
                        }
                        reject(error);
                    });
                } catch (error) {
                    console.error('Fallback chat failed:', error);
                    var errorMsg = 'æŠ±æ­‰ï¼Œç¶²è·¯é€£æ¥å‡ºç¾å•é¡Œã€‚è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£æ¥ã€‚';
                    var messageElement = document.getElementById(aiMessageId);
                    if (messageElement) {
                        var contentElement = messageElement.querySelector('.message-content');
                        if (contentElement) {
                            contentElement.textContent = errorMsg;
                        }
                    }
                    reject(error);
                }
            });
        }

        // é¡¯ç¤º AI è¼‰å…¥å‹•ç•«
        function showAILoading() {
            var chatContainer = document.getElementById('chat-container');
            var loadingWrapper = document.createElement('div');
            loadingWrapper.id = 'ai-loading-message';
            loadingWrapper.className = 'mb-4';
            
            var currentTime = new Date().toLocaleTimeString('zh-TW', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            var aiTitle = currentLanguage === 'en' ? 'AI Study Abroad Advisor' : 'AI ç•™å­¸é¡§å•';
            var aiSubtitle = currentLanguage === 'en' ? 'Your Exclusive Study Abroad Planning Expert' : 'æ‚¨çš„å°ˆå±¬ç•™å­¸è¦åŠƒå°ˆå®¶';
            
            loadingWrapper.innerHTML = 
                '<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">' +
                    '<div class="flex items-center mb-4">' +
                        '<div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">AI</div>' +
                        '<div>' +
                            '<h3 class="font-semibold text-gray-800">' + aiTitle + '</h3>' +
                            '<p class="text-sm text-gray-500">' + aiSubtitle + '</p>' +
                        '</div>' +
                    '</div>' +
                    '<div class="flex items-center text-gray-600">' +
                        '<div class="flex space-x-1 mr-3">' +
                            '<div class="w-2 h-2 bg-blue-500 rounded-full ai-loading-dot"></div>' +
                            '<div class="w-2 h-2 bg-blue-500 rounded-full ai-loading-dot"></div>' +
                            '<div class="w-2 h-2 bg-blue-500 rounded-full ai-loading-dot"></div>' +
                        '</div>' +
                        '<span class="text-sm">' + (currentLanguage === 'en' ? 'AI is thinking...' : 'AI æ­£åœ¨æ€è€ƒä¸­...') + '</span>' +
                    '</div>' +
                    '<div class="text-xs text-gray-400 mt-3">' + currentTime + '</div>' +
                '</div>';
            
            chatContainer.appendChild(loadingWrapper);
            
            // æ»¾å‹•åˆ°åº•éƒ¨
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // éš±è— AI è¼‰å…¥å‹•ç•«
        function hideAILoading() {
            var loadingMessage = document.getElementById('ai-loading-message');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©
        function addMessage(message, sender, shouldScroll = true) {
            var chatContainer = document.getElementById('chat-container');
            var messageWrapper = document.createElement('div');
            
            // ç”Ÿæˆå”¯ä¸€çš„ messageId
            var messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            messageWrapper.id = messageId;
            
            var currentTime = new Date().toLocaleTimeString('zh-TW', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            if (sender === 'user') {
                messageWrapper.className = 'flex justify-end mb-4';
                messageWrapper.innerHTML = 
                    '<div class="max-w-xs sm:max-w-sm md:max-w-md bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-800 rounded-lg p-4 shadow-sm">' +
                        '<div class="text-sm leading-relaxed">' + message + '</div>' +
                        '<div class="text-xs text-gray-600 mt-2">' + currentTime + '</div>' +
                    '</div>';
            } else {
                messageWrapper.className = 'mb-4';
                var aiTitle = currentLanguage === 'en' ? 'AI Study Abroad Advisor' : 'AI ç•™å­¸é¡§å•';
                var aiSubtitle = currentLanguage === 'en' ? 'Your Exclusive Study Abroad Planning Expert' : 'æ‚¨çš„å°ˆå±¬ç•™å­¸è¦åŠƒå°ˆå®¶';
                
                messageWrapper.innerHTML = 
                    '<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">' +
                        '<div class="flex items-center mb-4">' +
                            '<div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">AI</div>' +
                            '<div>' +
                                '<h3 class="font-semibold text-gray-800">' + aiTitle + '</h3>' +
                                '<p class="text-sm text-gray-500">' + aiSubtitle + '</p>' +
                            '</div>' +
                        '</div>' +
                        '<div class="message-content text-gray-700 leading-relaxed whitespace-pre-line">' + message + '</div>' +
                        '<div class="text-xs text-gray-400 mt-3">' + currentTime + '</div>' +
                    '</div>';
            }
            
            chatContainer.appendChild(messageWrapper);
            
            if (shouldScroll) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            // ä¿å­˜å°è©±æ­·å²åˆ° localStorage
            saveChatHistory();
            
            // è¿”å› messageId
            return messageId;
        }

        // ä¿å­˜å°è©±æ­·å²
        function saveChatHistory() {
            if (!profileId) return;
            
            try {
                var messages = [];
                var chatContainer = document.getElementById('chat-container');
                var messageElements = chatContainer.children;
                
                for (var i = 0; i < messageElements.length; i++) {
                    var element = messageElements[i];
                    var messageText = '';
                    var messageType = '';
                    
                    if (element.classList.contains('justify-end')) {
                        // ç”¨æˆ¶è¨Šæ¯
                        var userMessage = element.querySelector('.text-sm');
                        if (userMessage) {
                            messageText = userMessage.textContent;
                            messageType = 'user';
                        }
                    } else {
                        // AI è¨Šæ¯
                        var aiMessage = element.querySelector('.text-gray-700');
                        if (aiMessage) {
                            messageText = aiMessage.textContent;
                            messageType = 'ai';
                        }
                    }
                    
                    if (messageText && messageType) {
                        messages.push({
                            content: messageText,
                            type: messageType,
                            timestamp: new Date().toISOString()
                        });
                    }
                }
                
                // é™åˆ¶æ­·å²è¨˜éŒ„æ•¸é‡ï¼ˆæœ€å¤š 50 æ¢ï¼‰
                if (messages.length > 50) {
                    messages = messages.slice(-50);
                }
                
                localStorage.setItem('chatHistory_' + profileId, JSON.stringify(messages));
            } catch (error) {
                console.error('Error saving chat history:', error);
            }
        }

        // è¼‰å…¥å°è©±æ­·å²
        function loadChatHistory() {
            if (!profileId) {
                // æ²’æœ‰ profileIdï¼Œç›´æ¥ç™¼é€æ­¡è¿è¨Šæ¯
                sendWelcomeMessage();
                return;
            }
            
            // å¾ localStorage è¼‰å…¥å°è©±æ­·å²
            var chatHistory = localStorage.getItem('chatHistory_' + profileId);
            if (chatHistory) {
                try {
                    var messages = JSON.parse(chatHistory);
                    // æ¸…ç©ºç¾æœ‰è¨Šæ¯
                    var chatContainer = document.getElementById('chat-messages');
                    chatContainer.innerHTML = '';
                    
                    // è¼‰å…¥æ­·å²è¨Šæ¯
                    messages.forEach(function(msg) {
                        addMessage(msg.content, msg.type, false); // false = ä¸æ»¾å‹•åˆ°åº•éƒ¨
                    });
                    
                    // æœ€å¾Œæ»¾å‹•åˆ°åº•éƒ¨
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    
                    console.log('Chat history loaded:', messages.length, 'messages');
                } catch (error) {
                    console.error('Error loading chat history:', error);
                    sendWelcomeMessage();
                }
            } else {
                // æ²’æœ‰æ­·å²è¨˜éŒ„ï¼Œç™¼é€æ­¡è¿è¨Šæ¯
                sendWelcomeMessage();
            }
        }

        // ç™¼é€æ­¡è¿è¨Šæ¯
        function sendWelcomeMessage() {
            if (!profileId) return;
            
            // æª¢æŸ¥æ˜¯å¦å·²æœ‰å°è©±æ­·å²
            var existingMessages = document.querySelectorAll('.message.ai');
            if (existingMessages.length > 0) {
                console.log('Chat history exists, skipping welcome message');
                return;
            }
            
            // é¡¯ç¤º AI è¼‰å…¥å‹•ç•«
            showAILoading();
            
            // åŒæ™‚ç™¼é€ API è«‹æ±‚ç²å–æ›´è©³ç´°çš„å›è¦†
            try {
                var authHeader = {};
                var jwt = localStorage.getItem('jwt');
                if (jwt) {
                    authHeader['Authorization'] = 'Bearer ' + jwt;
                }
                
                var headers = {
                    'Content-Type': 'application/json'
                };
                for (var key in authHeader) {
                    headers[key] = authHeader[key];
                }
                
                fetch(window.__CONFIG__.API_BASE + '/api/v1/chat', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        profile_id: profileId,
                        message: '', // ç©ºè¨Šæ¯è§¸ç™¼æ­¡è¿å›è¦†
                        user_role: currentRole,
                        language: currentLanguage
                    })
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    // éš±è—è¼‰å…¥å‹•ç•«
                    hideAILoading();
                    
                    if (result.ok && result.reply) {
                        addMessage(result.reply, 'ai');
                    } else {
                        console.error('Welcome message failed:', result);
                        // å¦‚æœ API å¤±æ•—ï¼Œé¡¯ç¤ºé è¨­æ­¡è¿è¨Šæ¯
                        var welcomeText = currentLanguage === 'en' ? 
                            'ğŸ“ Hello! I am your AI Study Abroad Advisor. How can I help you today?' :
                            'ğŸ“ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIç•™å­¸é¡§å•ã€‚ä»Šå¤©æœ‰ä»€éº¼å¯ä»¥ç‚ºæ‚¨æœå‹™çš„å—ï¼Ÿ';
                        addMessage(welcomeText, 'ai');
                    }
                })
                .catch(function(error) {
                    console.error('Welcome message error:', error);
                    
                    // éš±è—è¼‰å…¥å‹•ç•«
                    hideAILoading();
                });
            } catch (error) {
                console.error('Welcome message error:', error);
                
                // éš±è—è¼‰å…¥å‹•ç•«
                hideAILoading();
            }
        }

        // è¼‰å…¥å¿«é€Ÿå•ç­”æŒ‰éˆ•ï¼ˆä¾èº«ä»½ï¼‰
        function loadQuickActions() {
            var qa = document.getElementById('quick-actions');
            if (!qa) return;
            qa.innerHTML = '';
            
            var studentBtns = [
                { zh: 'å­¸æ ¡æ¨è–¦', en: 'School Recommendations', q: 'æ ¹æ“šæˆ‘çš„èƒŒæ™¯æ¨è–¦é©åˆçš„å­¸æ ¡å’Œç§‘ç³»', q_en: 'Recommend suitable schools and majors based on my background' },
                { zh: 'ç”³è«‹è¦åŠƒ', en: 'Application Planning', q: 'è«‹å¹«æˆ‘è¦åŠƒå®Œæ•´çš„ç”³è«‹æ™‚é–“è¡¨å’Œæµç¨‹', q_en: 'Please help me plan a complete application timeline and process' },
                { zh: 'çå­¸é‡‘ç”³è«‹', en: 'Scholarship Application', q: 'æœ‰å“ªäº›é©åˆæˆ‘çš„çå­¸é‡‘å¯ä»¥ç”³è«‹ï¼Ÿ', q_en: 'What scholarships are suitable for me to apply for?' },
                { zh: 'ç°½è­‰æŒ‡å°', en: 'Visa Guidance', q: 'å­¸ç”Ÿç°½è­‰ç”³è«‹æµç¨‹å’Œæ³¨æ„äº‹é …', q_en: 'Student visa application process and important notes' },
                { zh: 'ä½å®¿å»ºè­°', en: 'Housing Advice', q: 'æµ·å¤–ä½å®¿é¸æ“‡å’Œæ³¨æ„äº‹é …', q_en: 'Overseas accommodation options and considerations' },
                { zh: 'èªè¨€æº–å‚™', en: 'Language Preparation', q: 'èªè¨€è€ƒè©¦æº–å‚™å’Œæˆç¸¾è¦æ±‚', q_en: 'Language test preparation and score requirements' }
            ];
            var parentBtns = [
                { zh: 'è²»ç”¨è¦åŠƒ', en: 'Cost Planning', q: 'ä¸€å¹´ç¸½è²»ç”¨é ä¼°èˆ‡é ç®—å»ºè­°', q_en: 'Annual total cost estimation and budget recommendations' },
                { zh: 'æŠ•è³‡å›å ±', en: 'ROI Analysis', q: 'å¹«æˆ‘ä¼°ç®—ä¸åŒæ–¹æ¡ˆçš„æŠ•è³‡å›æ”¶æœŸ', q_en: 'Help me estimate the ROI for different options' },
                { zh: 'å®‰å…¨è€ƒé‡', en: 'Safety Considerations', q: 'æµ·å¤–ç•™å­¸å®‰å…¨æ³¨æ„äº‹é …', q_en: 'Safety considerations for studying abroad' },
                { zh: 'ä¿éšªè¦åŠƒ', en: 'Insurance Planning', q: 'ç•™å­¸ä¿éšªé¸æ“‡å’Œè¦åŠƒ', q_en: 'Study abroad insurance options and planning' },
                { zh: 'å°±æ¥­å‰æ™¯', en: 'Career Prospects', q: 'ç•¢æ¥­å¾Œå°±æ¥­å‰æ™¯å’Œç™¼å±•', q_en: 'Career prospects and development after graduation' },
                { zh: 'æ–‡åŒ–é©æ‡‰', en: 'Cultural Adaptation', q: 'å¦‚ä½•å¹«åŠ©å­©å­é©æ‡‰æµ·å¤–æ–‡åŒ–', q_en: 'How to help children adapt to overseas culture' }
            ];
            
            var buttons = currentRole === 'parent' ? parentBtns : studentBtns;
            
            for (var i = 0; i < buttons.length; i++) {
                var btn = buttons[i];
                var label = currentLanguage === 'en' ? btn.en : btn.zh;
                var question = currentLanguage === 'en' ? btn.q_en : btn.q;
                
                var button = document.createElement('button');
                button.type = 'button';
                button.className = 'px-4 py-3 text-sm bg-white hover:bg-gray-50 rounded-lg border border-gray-200 shadow-sm transition-colors text-gray-700 font-medium';
                button.textContent = label;
                button.onclick = function(questionText) {
                    return function() {
                        document.getElementById('message-input').value = questionText;
                        sendMessage();
                    };
                }(question);
                qa.appendChild(button);
            }
        }
        
        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        // è·¨è¨­å‚™åŒæ­¥æª¢æŸ¥
        function checkCrossDeviceSync() {
            const jwt = localStorage.getItem('jwt');
            if (!jwt) return;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ä¾†è‡ªå…¶ä»–è¨­å‚™çš„æ›´æ–°
            const lastSyncTime = localStorage.getItem('lastSyncTime') || 0;
            const currentTime = Date.now();
            
            // å¦‚æœè¶…é 5 åˆ†é˜æ²’æœ‰åŒæ­¥ï¼Œå‰‡æª¢æŸ¥æ›´æ–°
            if (currentTime - lastSyncTime > 5 * 60 * 1000) {
                syncUserData();
            }
        }
        
        // åŒæ­¥ç”¨æˆ¶è³‡æ–™
        function syncUserData() {
            const jwt = localStorage.getItem('jwt');
            if (!jwt) return;
            
            fetch(window.__CONFIG__.API_BASE + '/api/v1/user/sync', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + jwt,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok && data.data && data.data.user) {
                    // æ›´æ–°æœ¬åœ°ç”¨æˆ¶è³‡æ–™
                    localStorage.setItem('userProfile', JSON.stringify(data.data.user));
                    localStorage.setItem('lastSyncTime', Date.now().toString());
                    
                    console.log('User data synced across devices');
                    
                    // å¦‚æœæœ‰æ–°çš„ profileIdï¼Œæ›´æ–°å®ƒ
                    if (data.data.profileId && data.data.profileId !== profileId) {
                        profileId = data.data.profileId;
                        localStorage.setItem('profileId', profileId);
                        console.log('Profile ID updated from sync:', profileId);
                    }
                }
            })
            .catch(error => {
                console.log('Sync failed (this is normal if no server sync endpoint):', error);
                // ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œé¿å…å½±éŸ¿é é¢åŠŸèƒ½
            });
        }
        
        window.onload = function() {
            // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
            var existingJWT = localStorage.getItem('jwt');
            var existingUserProfile = localStorage.getItem('userProfile');
            
            // å¦‚æœå·²ç¶“ç™»å…¥ï¼Œé¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
            if (existingJWT && existingUserProfile && existingJWT !== 'fake-jwt-token-for-testing') {
                try {
                    var userProfile = JSON.parse(existingUserProfile);
                    
                    // è¼‰å…¥å·²ä¿å­˜çš„ profileId
                    loadProfileId();
                    
                    showUserInfo(userProfile);
                    console.log('User already logged in:', userProfile.name);
                    
                    // æª¢æŸ¥è·¨è¨­å‚™åŒæ­¥ï¼ˆå®‰å…¨èª¿ç”¨ï¼‰
                    try {
                        checkCrossDeviceSync();
                    } catch (e) {
                        console.log('Cross-device sync check failed:', e);
                    }
                } catch (e) {
                    console.error('Error parsing user profile:', e);
                    localStorage.removeItem('userProfile');
                }
            }
        };
        
        // é é¢é›¢é–‹æ™‚é—œé–‰ SSE é€£ç·š
        window.addEventListener('beforeunload', function() {
            closeStream();
        });
        
        // é é¢éš±è—æ™‚é—œé–‰ SSE é€£ç·š
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                closeStream();
            }
        });
            
            // æª¢æŸ¥ URL åƒæ•¸ä¸­çš„ token
            var urlParams = new URLSearchParams(window.location.search);
            var token = urlParams.get('token');
            var error = urlParams.get('error');
            
            // è™•ç†ç™»å…¥éŒ¯èª¤
            if (error) {
                var errorMessage = '';
                switch(error) {
                    case 'missing_code':
                        errorMessage = currentLanguage === 'en' ? 'Login failed: Missing authorization code' : 'ç™»å…¥å¤±æ•—ï¼šç¼ºå°‘æˆæ¬Šç¢¼';
                        break;
                    case 'token_exchange_failed':
                        errorMessage = currentLanguage === 'en' ? 'Login failed: Token exchange failed' : 'ç™»å…¥å¤±æ•—ï¼šä»¤ç‰Œäº¤æ›å¤±æ•—';
                        break;
                    case 'user_info_failed':
                        errorMessage = currentLanguage === 'en' ? 'Login failed: Unable to get user information' : 'ç™»å…¥å¤±æ•—ï¼šç„¡æ³•ç²å–ç”¨æˆ¶è³‡è¨Š';
                        break;
                    case 'callback_failed':
                        errorMessage = currentLanguage === 'en' ? 'Login failed: Callback processing failed' : 'ç™»å…¥å¤±æ•—ï¼šå›èª¿è™•ç†å¤±æ•—';
                        break;
                    default:
                        errorMessage = currentLanguage === 'en' ? 'Login failed: ' + error : 'ç™»å…¥å¤±æ•—ï¼š' + error;
                }
                alert(errorMessage);
                // æ¸…é™¤ URL åƒæ•¸
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            if (token) {
                // å„²å­˜ token
                localStorage.setItem('jwt', token);
                
                // åŒæ™‚è¨­ç½® Cookie ç”¨æ–¼ SSE èªè­‰
                setJWTCookie(token);
                
                // å¦‚æœæœ‰ provider åƒæ•¸ï¼Œè¡¨ç¤ºæ˜¯ LINE ç™»å…¥ï¼Œéœ€è¦ç²å–ç”¨æˆ¶è³‡è¨Š
                var provider = urlParams.get('provider');
                if (provider === 'line') {
                    // LINE ç™»å…¥æˆåŠŸï¼Œä½†éœ€è¦ç²å–ç”¨æˆ¶è³‡è¨Š
                    // æš«æ™‚é¡¯ç¤ºç™»å…¥æˆåŠŸè¨Šæ¯ï¼Œå¯¦éš›æ‡‰ç”¨ä¸­å¯èƒ½éœ€è¦é¡å¤–çš„ API èª¿ç”¨
                    alert(currentLanguage === 'en' ? 
                        'LINE login successful! Please refresh the page to continue.' : 
                        'LINE ç™»å…¥æˆåŠŸï¼è«‹é‡æ–°æ•´ç†é é¢ä»¥ç¹¼çºŒã€‚');
                }
                
                // æ¸…é™¤ URL åƒæ•¸
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // é‡æ–°è¼‰å…¥é é¢ä»¥é¡¯ç¤ºæ­£ç¢ºçš„ç‹€æ…‹
                window.location.reload();
            } else {
                // æª¢æŸ¥æœ¬åœ°å„²å­˜çš„ token
                var storedToken = localStorage.getItem('jwt');
                if (storedToken) {
                    // é©—è­‰ token æ˜¯å¦æœ‰æ•ˆ
                    validateToken(storedToken);
                } else {
                    showLoginPage();
                }
            }
        };
    </script>
</body>
</html>

