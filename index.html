<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI ç•™å­¸é¡§å•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // èª¿è©¦æ¨¡å¼é–‹é—œ (æŒ‰ Ctrl+Shift+D é–‹å•Ÿ)
        window.DEBUG_MODE = false;
        
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                window.DEBUG_MODE = !window.DEBUG_MODE;
                toggleDebugPanel();
            }
        });
        
        function toggleDebugPanel() {
            let panel = document.getElementById('debug-panel');
            if (!panel) {
                createDebugPanel();
            } else {
                panel.style.display = window.DEBUG_MODE ? 'block' : 'none';
            }
        }
        
        function createDebugPanel() {
            const panel = document.createElement('div');
            panel.id = 'debug-panel';
            panel.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                width: 400px;
                max-height: 500px;
                background: #f0f0f0;
                border: 2px solid #333;
                border-radius: 8px;
                padding: 15px;
                font-family: monospace;
                font-size: 12px;
                z-index: 10000;
                overflow-y: auto;
                display: ${window.DEBUG_MODE ? 'block' : 'none'};
            `;
            
            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin: 0; color: #333;">ğŸ”§ èª¿è©¦é¢æ¿</h3>
                    <button onclick="clearDebugInfo()" style="padding: 2px 6px; font-size: 10px;">æ¸…é™¤</button>
                </div>
                <div id="debug-info" style="background: white; padding: 10px; border-radius: 4px; min-height: 200px; max-height: 300px; overflow-y: auto;"></div>
                <div style="margin-top: 10px;">
                    <button onclick="testGoogleAPI()" style="padding: 4px 8px; margin: 2px; font-size: 10px;">æ¸¬è©¦ Google API</button>
                    <button onclick="testBackendConfig()" style="padding: 4px 8px; margin: 2px; font-size: 10px;">æ¸¬è©¦å¾Œç«¯</button>
                    <button onclick="testGoogleLogin()" style="padding: 4px 8px; margin: 2px; font-size: 10px;">æ¸¬è©¦ç™»å…¥</button>
                </div>
                <div style="margin-top: 5px; font-size: 10px; color: #666;">
                    æŒ‰ Ctrl+Shift+D åˆ‡æ›èª¿è©¦é¢æ¿
                </div>
            `;
            
            document.body.appendChild(panel);
            
            // æ·»åŠ èª¿è©¦å‡½æ•¸
            window.addDebugInfo = function(message) {
                const debugInfo = document.getElementById('debug-info');
                if (!debugInfo) return;
                
                const div = document.createElement('div');
                div.textContent = new Date().toLocaleTimeString() + ': ' + message;
                debugInfo.appendChild(div);
                debugInfo.scrollTop = debugInfo.scrollHeight;
                console.log('[DEBUG]', message);
            };
            
            window.clearDebugInfo = function() {
                const debugInfo = document.getElementById('debug-info');
                if (debugInfo) debugInfo.innerHTML = '';
            };
            
            window.testGoogleAPI = function() {
                addDebugInfo('æ¸¬è©¦ Google API è¼‰å…¥ç‹€æ…‹...');
                
                if (typeof google !== 'undefined') {
                    addDebugInfo('âœ“ Google API å·²è¼‰å…¥');
                    if (google.accounts) {
                        addDebugInfo('âœ“ Google Accounts API å¯ç”¨');
                    } else {
                        addDebugInfo('âœ— Google Accounts API ä¸å¯ç”¨');
                    }
                } else {
                    addDebugInfo('âœ— Google API æœªè¼‰å…¥');
                }
            };
            
            window.testBackendConfig = function() {
                addDebugInfo('æ¸¬è©¦å¾Œç«¯é…ç½®...');
                
                fetch(window.__CONFIG__.API_BASE + '/auth/config')
                    .then(r => r.json())
                    .then(cfg => {
                        addDebugInfo('å¾Œç«¯é…ç½®éŸ¿æ‡‰: ' + JSON.stringify(cfg));
                        
                        if (cfg && cfg.ok && cfg.google && cfg.google.client_id) {
                            addDebugInfo('âœ“ Google Client ID é…ç½®æ­£ç¢º: ' + cfg.google.client_id);
                            window.__GOOGLE_CLIENT_ID__ = cfg.google.client_id;
                        } else {
                            addDebugInfo('âœ— Google Client ID é…ç½®æœ‰å•é¡Œ');
                        }
                    })
                    .catch(error => {
                        addDebugInfo('âœ— å¾Œç«¯é…ç½®è«‹æ±‚å¤±æ•—: ' + error.message);
                    });
            };
            
            window.testGoogleLogin = function() {
                addDebugInfo('æ¸¬è©¦ Google ç™»å…¥ï¼ˆå½ˆå‡ºè¦–çª—æ¨¡å¼ï¼‰...');
                
                const clientId = window.__GOOGLE_CLIENT_ID__ || '300123710303-m4j1laa65p664n5vtrdkfvfa7b42c2o6.apps.googleusercontent.com';
                addDebugInfo('ä½¿ç”¨ Client ID: ' + clientId);
                
                const googleAuthUrl = 'https://accounts.google.com/o/oauth2/v2/auth?' +
                    'client_id=' + clientId + '&' +
                    'redirect_uri=https://aistudentbackend.zeabur.app/auth/google/callback&' +
                    'response_type=code&' +
                    'scope=openid email profile&' +
                    'state=popup_login';
                
                addDebugInfo('Google ç™»å…¥ URL: ' + googleAuthUrl);
                
                // æ‰“é–‹å½ˆå‡ºè¦–çª—
                const popup = window.open(
                    googleAuthUrl,
                    'googleLogin',
                    'width=500,height=600,scrollbars=yes,resizable=yes'
                );
                
                if (!popup) {
                    addDebugInfo('âœ— å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹');
                    return;
                }
                
                addDebugInfo('âœ“ å½ˆå‡ºè¦–çª—å·²æ‰“é–‹');
            };
        }
    </script>
    <script>
        // å…§åµŒé…ç½®
        window.__CONFIG__ = {
            API_BASE: 'https://aistudentbackend.zeabur.app/api/v1',
            // æš«æ™‚ä½¿ç”¨æ¸¬è©¦æ¨¡å¼ï¼Œè·³éå¾Œç«¯é©—è­‰
            TEST_MODE: true
        };
        
        // Google OAuth é…ç½®
        window.__GOOGLE_CLIENT_ID__ = '300123710303-m4j1laa65p664n5vtrdkfvfa7b42c2o6.apps.googleusercontent.com';
    </script>
    <style>
        /* è‡ªå®šç¾©æ¨£å¼ */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        /* æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
        @media (max-width: 768px) {
            .mobile-optimized {
                font-size: 16px !important; /* é˜²æ­¢ iOS è‡ªå‹•ç¸®æ”¾ */
                -webkit-text-size-adjust: 100%;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            
            .mobile-button {
                pointer-events: auto !important;
                -webkit-user-select: none;
                user-select: none;
                min-height: 44px !important; /* iOS å»ºè­°çš„æœ€å°è§¸æ§å€åŸŸ */
                padding: 12px 16px !important;
                font-size: 16px !important;
            }
            
            .mobile-input {
                font-size: 16px !important; /* é˜²æ­¢ iOS è‡ªå‹•ç¸®æ”¾ */
                padding: 12px 16px !important;
                min-height: 44px !important;
            }
            
            .mobile-text {
                font-size: 16px !important;
                line-height: 1.5 !important;
            }
            
            /* é˜²æ­¢é›™æ“Šç¸®æ”¾ */
            * {
                touch-action: manipulation;
            }
            
            /* å„ªåŒ–èŠå¤©ä»‹é¢ */
            .chat-container {
                height: calc(100vh - 120px) !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            .message-bubble {
                max-width: 85% !important;
                word-wrap: break-word !important;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .hidden { display: none; }
        .block { display: block; }
        
        .message-bubble {
            @apply max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg px-4 py-3 rounded-2xl relative shadow-sm;
            word-wrap: break-word;
        }
        
        .message-user {
            @apply bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-800 ml-auto;
            margin-left: auto;
            margin-right: 0;
        }
        
        .message-user::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: -8px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-left-color: #fbbf24;
            border-bottom: none;
            border-right: none;
        }
        
        .message-ai {
            @apply bg-white text-gray-800 mr-auto border border-gray-200;
            margin-left: 0;
            margin-right: auto;
        }
        
        .message-ai::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: -8px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-right-color: white;
            border-bottom: none;
            border-left: none;
        }
        
        .message-ai::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -9px;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-right-color: #e5e7eb;
            border-bottom: none;
            border-left: none;
        }
        
        .message-time {
            @apply text-xs text-gray-500 mt-1;
        }
        
        .message-avatar {
            @apply w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white;
        }
        
        .avatar-ai {
            @apply bg-gradient-to-r from-blue-500 to-blue-600;
        }
        
        .avatar-user {
            @apply bg-gradient-to-r from-yellow-500 to-yellow-600;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">
    <!-- ç™»å…¥é é¢ -->
    <div id="login-page" class="min-h-screen flex flex-col items-center justify-center p-4 bg-gradient-to-br from-yellow-100 to-blue-100">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full text-center fade-in">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-4" data-zh="AI ç•™å­¸é¡§å•" data-en="AI Study Abroad Advisor">AI ç•™å­¸é¡§å•</h1>
            <p class="text-lg text-gray-600 mb-8" data-zh="æ‚¨çš„å€‹äººåŒ–ç•™å­¸è¦åŠƒå°ˆå®¶" data-en="Your Personalized Study Abroad Planning Expert">æ‚¨çš„å€‹äººåŒ–ç•™å­¸è¦åŠƒå°ˆå®¶</p>
            
            <div id="auth-section" class="mb-6">
                <div id="user-info" class="hidden mb-4">
                    <img id="user-avatar" class="w-16 h-16 rounded-full mx-auto mb-2" src="" alt="User Avatar">
                    <p class="text-xl font-semibold">æ­¡è¿ï¼Œ<span id="user-name"></span>!</p>
                    <div class="flex flex-col space-y-2 mt-4">
                        <button onclick="continueToChat()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium shadow-md">
                            <span data-zh="ç¹¼çºŒåˆ°èŠå¤©å°è©±æ¡†" data-en="Continue to Chat">ç¹¼çºŒåˆ°èŠå¤©å°è©±æ¡†</span>
                        </button>
                        <button onclick="openUserSettings()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                            <span data-zh="ç”¨æˆ¶è¨­å®š" data-en="User Settings">ç”¨æˆ¶è¨­å®š</span>
                        </button>
                        <button onclick="logout()" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                            <span data-zh="ç™»å‡º" data-en="Logout">ç™»å‡º</span>
                        </button>
                    </div>
                </div>
                <div id="login-buttons">
                    <p class="text-gray-700 mb-4" data-zh="è«‹ç™»å…¥ä»¥ç¹¼çºŒ" data-en="Please login to continue">è«‹ç™»å…¥ä»¥ç¹¼çºŒ</p>
                    <button onclick="skipLogin()" class="w-full flex items-center justify-center px-4 py-3 mb-3 bg-yellow-400 text-gray-800 rounded-lg hover:bg-yellow-500 transition-colors font-medium shadow-md mobile-button mobile-optimized">
                        <span data-zh="è·³éç™»å…¥ï¼Œç›´æ¥é–‹å§‹" data-en="Skip login, start directly">è·³éç™»å…¥ï¼Œç›´æ¥é–‹å§‹</span>
                    </button>
                    <button onclick="loginWithGoogle()" id="google-login-btn" class="w-full flex items-center justify-center px-4 py-3 mb-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium shadow-md mobile-button mobile-optimized">
                        <img src="https://img.icons8.com/color/24/000000/google-logo.png" alt="Google" class="w-5 h-5 mr-2">
                        <span data-zh="ä½¿ç”¨ Google ç™»å…¥" data-en="Login with Google">ä½¿ç”¨ Google ç™»å…¥</span>
                    </button>
                    <button onclick="loginWithLINE()" class="w-full flex items-center justify-center px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium shadow-md mobile-button mobile-optimized">
                        <img src="https://img.icons8.com/color/24/000000/line-me.png" alt="LINE" class="w-5 h-5 mr-2">
                        <span data-zh="ä½¿ç”¨ LINE ç™»å…¥" data-en="Login with LINE">ä½¿ç”¨ LINE ç™»å…¥</span>
                    </button>
                    <div class="text-xs text-gray-500 mt-2 text-center" data-zh="æ”¯æ´ Google å’Œ LINE ç™»å…¥" data-en="Support Google and LINE login">æ”¯æ´ Google å’Œ LINE ç™»å…¥</div>
                </div>
            </div>


            <!-- èªè¨€åˆ‡æ› -->
            <div class="mt-6 flex justify-center space-x-4">
                <button onclick="switchLanguage('zh')" id="lang-switch-zh" 
                        class="px-4 py-2 text-sm rounded-lg bg-blue-500 text-white transition-colors">
                    ä¸­æ–‡
                </button>
                <button onclick="switchLanguage('en')" id="lang-switch-en" 
                        class="px-4 py-2 text-sm rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">
                    English
                </button>
            </div>
        </div>
    </div>

    <!-- è¨­å®šé é¢ -->
    <div id="setup-page" class="min-h-screen hidden">
        <div class="max-w-2xl mx-auto bg-white min-h-screen">
            <header class="bg-gradient-to-r from-yellow-400 to-yellow-300 text-gray-800 p-4 sm:p-6 relative">
                <button id="back-to-home" class="absolute left-2 sm:left-4 top-4 sm:top-6 text-gray-800 hover:text-gray-600 transition-colors text-sm sm:text-base z-10">
                    <span data-zh="â† Back" data-en="â† Back">â† Back</span>
                </button>
                <div class="text-center px-12 sm:px-0">
                    <h1 class="text-base sm:text-xl lg:text-2xl font-bold mb-1 sm:mb-2 leading-tight" data-zh="è¨­å®šæ‚¨çš„ç•™å­¸éœ€æ±‚" data-en="Set Your Study Abroad Requirements">è¨­å®šæ‚¨çš„ç•™å­¸éœ€æ±‚</h1>
                    <p class="text-gray-600 text-xs sm:text-base leading-tight" data-zh="è®“æˆ‘å€‘å…ˆäº†è§£æ‚¨çš„åŸºæœ¬è³‡è¨Š" data-en="Let us understand your basic information first">è®“æˆ‘å€‘å…ˆäº†è§£æ‚¨çš„åŸºæœ¬è³‡è¨Š</p>
                </div>
            </header>

            <!-- Setup Form -->
            <main class="p-6">
                <form id="setup-form" class="space-y-6">
                    <!-- å€‹äººåŸºæœ¬è³‡è¨Š -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">1</span>
                                <span data-zh="å€‹äººåŸºæœ¬è³‡è¨Š" data-en="Personal Information">å€‹äººåŸºæœ¬è³‡è¨Š</span>
                            </div>
                        </h3>
                        <div id="student-fields" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å­¸ç”Ÿå§“å *" data-en="Student Name *">å­¸ç”Ÿå§“å *</label>
                                <input type="text" id="student_name" name="student_name" required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="ä¾‹å¦‚ï¼šç‹å°æ˜" data-en-ph="e.g., David Wang" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å­¸ç”Ÿé›»å­éƒµä»¶ *" data-en="Student Email *">å­¸ç”Ÿé›»å­éƒµä»¶ *</label>
                                <input type="email" id="student_email" name="student_email" required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="ä¾‹å¦‚ï¼šdavid@example.com" data-en-ph="e.g., david@example.com" placeholder="ä¾‹å¦‚ï¼šdavid@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="åœ‹ç± *" data-en="Citizenship *">åœ‹ç± *</label>
                                <input type="text" id="citizenship" name="citizenship" required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="ä¾‹å¦‚ï¼šå°ç£" data-en-ph="e.g., Taiwan" placeholder="ä¾‹å¦‚ï¼šå°ç£">
                            </div>
                        </div>
                        <div id="parent-fields" class="space-y-4 hidden">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å®¶é•·å§“å *" data-en="Parent Name *">å®¶é•·å§“å *</label>
                                <input type="text" id="parent_name" name="parent_name"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="ä¾‹å¦‚ï¼šç‹åª½åª½" data-en-ph="e.g., Alice Wang" placeholder="ä¾‹å¦‚ï¼šç‹åª½åª½">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å®¶é•·é›»å­éƒµä»¶ *" data-en="Parent Email *">å®¶é•·é›»å­éƒµä»¶ *</label>
                                <input type="email" id="parent_email" name="parent_email"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="ä¾‹å¦‚ï¼šparent@example.com" data-en-ph="e.g., parent@example.com" placeholder="ä¾‹å¦‚ï¼šparent@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="èˆ‡å­¸ç”Ÿé—œä¿‚ *" data-en="Relationship to Student *">èˆ‡å­¸ç”Ÿé—œä¿‚ *</label>
                                <input type="text" id="relationship" name="relationship"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="ä¾‹å¦‚ï¼šæ¯è¦ª / çˆ¶è¦ª" data-en-ph="e.g., Mother / Father" placeholder="ä¾‹å¦‚ï¼šæ¯è¦ª">
                            </div>
                            <div class="border-t pt-4">
                                <p class="text-sm text-gray-500 mb-2" data-zh="å­¸ç”Ÿè¯çµ¡è³‡æ–™" data-en="Student Contact">å­¸ç”Ÿè¯çµ¡è³‡æ–™</p>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å­¸ç”Ÿå§“å *" data-en="Student Name *">å­¸ç”Ÿå§“å *</label>
                                <input type="text" id="child_name" name="child_name"
                                    class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                    data-zh-ph="ä¾‹å¦‚ï¼šç‹å°æ˜" data-en-ph="e.g., David Wang" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜">
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="å­¸ç”Ÿé›»å­éƒµä»¶ *" data-en="Student Email *">å­¸ç”Ÿé›»å­éƒµä»¶ *</label>
                                <input type="email" id="child_email" name="child_email"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                    data-zh-ph="ä¾‹å¦‚ï¼šdavid@example.com" data-en-ph="e.g., david@example.com" placeholder="ä¾‹å¦‚ï¼šdavid@example.com">
                            </div>
                        </div>
                    </div>

                    <!-- å­¸è¡“èƒŒæ™¯ -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">2</span>
                                <span data-zh="å­¸è¡“èƒŒæ™¯" data-en="Academic Background">å­¸è¡“èƒŒæ™¯</span>
                            </div>
                        </h3>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="GPA (æ»¿åˆ†4.0) *" data-en="GPA (out of 4.0) *">GPA (æ»¿åˆ†4.0) *</label>
                            <input type="number" id="gpa" name="gpa" step="0.1" min="0" max="4" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                data-zh-ph="ä¾‹å¦‚ï¼š3.8" data-en-ph="e.g., 3.8" placeholder="ä¾‹å¦‚ï¼š3.8">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="ç›®æ¨™å­¸ä½ *" data-en="Target Degree *">ç›®æ¨™å­¸ä½ *</label>
                            <select id="degree" name="degree" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized">
                                <option value="" data-zh="è«‹é¸æ“‡" data-en="Please select">è«‹é¸æ“‡</option>
                                <option value="bachelor" data-zh="å­¸å£«" data-en="Bachelor's">å­¸å£«</option>
                                <option value="master" data-zh="ç¢©å£«" data-en="Master's">ç¢©å£«</option>
                                <option value="phd" data-zh="åšå£«" data-en="PhD">åšå£«</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="ç›®æ¨™åœ‹å®¶ *" data-en="Target Countries *">ç›®æ¨™åœ‹å®¶ *</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center">
                                    <input type="checkbox" name="countries" value="us" class="mr-2">
                                    <span data-zh="ç¾åœ‹" data-en="USA">ç¾åœ‹</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="countries" value="uk" class="mr-2">
                                    <span data-zh="è‹±åœ‹" data-en="UK">è‹±åœ‹</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="countries" value="ca" class="mr-2">
                                    <span data-zh="åŠ æ‹¿å¤§" data-en="Canada">åŠ æ‹¿å¤§</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- é ç®—å’Œæ™‚é–“ -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">3</span>
                                <span data-zh="é ç®—å’Œæ™‚é–“" data-en="Budget and Time">é ç®—å’Œæ™‚é–“</span>
                            </div>
                        </h3>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="é ç®— (æ¯å¹´å­¸è²»+ç”Ÿæ´»è²»ï¼Œå–®ä½ï¼šç¾å…ƒ) *" data-en="Budget (Annual tuition + living expenses, USD) *">é ç®— (æ¯å¹´å­¸è²»+ç”Ÿæ´»è²»ï¼Œå–®ä½ï¼šç¾å…ƒ) *</label>
                            <input type="number" id="budget" name="budget" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent mobile-input mobile-optimized"
                                data-zh-ph="ä¾‹å¦‚ï¼š50000" data-en-ph="e.g., 50000" placeholder="ä¾‹å¦‚ï¼š50000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="ç›®æ¨™å…¥å­¸æ™‚é–“ *" data-en="Target Intake Time *">ç›®æ¨™å…¥å­¸æ™‚é–“ *</label>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                <select id="intake_semester" name="intake_semester" required 
                                    class="w-full sm:w-1/3 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                    <option value="" data-zh="é¸æ“‡å­¸æœŸ" data-en="Select Semester">é¸æ“‡å­¸æœŸ</option>
                                    <option value="fall" data-zh="ç§‹å­£" data-en="Fall">ç§‹å­£</option>
                                    <option value="spring" data-zh="æ˜¥å­£" data-en="Spring">æ˜¥å­£</option>
                                    <option value="summer" data-zh="å¤å­£" data-en="Summer">å¤å­£</option>
                                    <option value="winter" data-zh="å†¬å­£" data-en="Winter">å†¬å­£</option>
                                </select>
                                <select id="intake_year" name="intake_year" required 
                                    class="w-full sm:w-2/3 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                    <option value="" data-zh="é¸æ“‡å¹´ä»½" data-en="Select Year">é¸æ“‡å¹´ä»½</option>
                                </select>
                            </div>
                            <input type="hidden" id="target_intake" name="target_intake">
                        </div>
                    </div>

                    <!-- è§’è‰²é¸æ“‡ -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <div class="flex items-center mb-2">
                                <span class="w-6 h-6 bg-yellow-400 text-gray-800 rounded-full flex items-center justify-center text-sm mr-2">4</span>
                                <span data-zh="é¸æ“‡æ‚¨çš„èº«ä»½" data-en="Choose Your Role">é¸æ“‡æ‚¨çš„èº«ä»½</span>
                            </div>
                        </h3>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                            <button type="button" onclick="selectRole('student')" id="role-student" 
                                    class="flex-1 px-4 sm:px-6 py-3 bg-blue-500 text-white rounded-lg font-medium transition-colors text-sm sm:text-base">
                                <span data-zh="ğŸ‘¨â€ğŸ“ æˆ‘æ˜¯å­¸ç”Ÿ" data-en="ğŸ‘¨â€ğŸ“ I am a Student">ğŸ‘¨â€ğŸ“ æˆ‘æ˜¯å­¸ç”Ÿ</span>
                            </button>
                            <button type="button" onclick="selectRole('parent')" id="role-parent" 
                                    class="flex-1 px-4 sm:px-6 py-3 bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors hover:bg-gray-400 text-sm sm:text-base">
                                <span data-zh="ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ æˆ‘æ˜¯å®¶é•·" data-en="ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ I am a Parent">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ æˆ‘æ˜¯å®¶é•·</span>
                            </button>
                        </div>
                    </div>

                    <button type="submit" 
                            class="w-full bg-yellow-400 text-gray-800 py-3 px-6 rounded-lg font-medium hover:bg-yellow-500 transition-colors duration-200 text-lg shadow-lg"
                            data-zh="é–‹å§‹èˆ‡AIé¡§å•å°è©±" data-en="Start Chat with AI Advisor">
                        é–‹å§‹èˆ‡AIé¡§å•å°è©±
                    </button>
                </form>
            </main>
        </div>
    </div>

    <!-- èŠå¤©é é¢ -->
    <div id="chat-page" class="min-h-screen hidden">
        <div class="max-w-4xl mx-auto bg-white min-h-screen flex flex-col">
            <header class="bg-gradient-to-r from-yellow-400 to-yellow-300 text-gray-800 p-4 text-center relative">
                <button id="back-to-setup" class="absolute left-4 top-4 text-gray-800 hover:text-gray-600 transition-colors">
                    <span data-zh="â† é‡æ–°è¨­å®š" data-en="â† Reset Settings">â† é‡æ–°è¨­å®š</span>
                </button>
                <button onclick="logout()" class="absolute right-4 top-4 text-gray-800 hover:text-gray-600 transition-colors">
                    <span data-zh="ç™»å‡º" data-en="Logout">ç™»å‡º</span>
                </button>
                <h1 class="text-xl font-bold" data-zh="AI ç•™å­¸é¡§å•" data-en="AI Study Abroad Advisor">AI ç•™å­¸é¡§å•</h1>
                <p class="text-sm" data-zh="æ­£åœ¨ç‚ºæ‚¨æä¾›å°ˆæ¥­å»ºè­°" data-en="Providing you with professional advice">æ­£åœ¨ç‚ºæ‚¨æä¾›å°ˆæ¥­å»ºè­°</p>
                <div class="flex items-center justify-center mt-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                    <span class="text-sm" data-zh="åœ¨ç·š" data-en="Online">åœ¨ç·š</span>
                </div>
            </header>

            <main class="flex-1 p-6 overflow-y-auto bg-white chat-container mobile-optimized" id="chat-container">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-4">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">AI</div>
                            <div>
                                <h3 class="font-semibold text-gray-800" data-zh="AI ç•™å­¸é¡§å•" data-en="AI Study Abroad Advisor">AI ç•™å­¸é¡§å•</h3>
                                <p class="text-sm text-gray-500" data-zh="æ‚¨çš„å°ˆå±¬ç•™å­¸è¦åŠƒå°ˆå®¶" data-en="Your Exclusive Study Abroad Planning Expert">æ‚¨çš„å°ˆå±¬ç•™å­¸è¦åŠƒå°ˆå®¶</p>
                            </div>
                        </div>
                        <div class="text-gray-700 leading-relaxed">
                            <p class="mb-3" data-zh="ğŸ“ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIç•™å­¸é¡§å•ã€‚" data-en="ğŸ“ Hello! I am your AI Study Abroad Advisor.">ğŸ“ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIç•™å­¸é¡§å•ã€‚</p>
                            <p class="mb-3" data-zh="æˆ‘å·²ç¶“äº†è§£äº†æ‚¨çš„åŸºæœ¬è³‡è¨Šï¼Œç¾åœ¨è®“æˆ‘å€‘æ·±å…¥è¨è«–æ‚¨çš„ç•™å­¸è¨ˆåŠƒå§ï¼" data-en="I have reviewed your basic information, now let's dive deep into your study abroad planning!">æˆ‘å·²ç¶“äº†è§£äº†æ‚¨çš„åŸºæœ¬è³‡è¨Šï¼Œç¾åœ¨è®“æˆ‘å€‘æ·±å…¥è¨è«–æ‚¨çš„ç•™å­¸è¨ˆåŠƒå§ï¼</p>
                            <p class="mb-3" data-zh="æ‚¨å¯ä»¥å•æˆ‘ä»»ä½•é—œæ–¼ç•™å­¸çš„å•é¡Œï¼Œæ¯”å¦‚ï¼š" data-en="You can ask me any questions about studying abroad, such as:">æ‚¨å¯ä»¥å•æˆ‘ä»»ä½•é—œæ–¼ç•™å­¸çš„å•é¡Œï¼Œæ¯”å¦‚ï¼š</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-4">
                                <div class="flex items-center text-sm text-gray-600">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                    <span data-zh="æ¨è–¦é©åˆçš„å­¸æ ¡å’Œå°ˆæ¥­" data-en="School and major recommendations">æ¨è–¦é©åˆçš„å­¸æ ¡å’Œå°ˆæ¥­</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                    <span data-zh="ç”³è«‹æµç¨‹å’Œæ™‚é–“è¦åŠƒ" data-en="Application process and timeline">ç”³è«‹æµç¨‹å’Œæ™‚é–“è¦åŠƒ</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                    <span data-zh="çå­¸é‡‘ç”³è«‹å»ºè­°" data-en="Scholarship application advice">çå­¸é‡‘ç”³è«‹å»ºè­°</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                    <span data-zh="ç°½è­‰å’Œä½å®¿è³‡è¨Š" data-en="Visa and accommodation info">ç°½è­‰å’Œä½å®¿è³‡è¨Š</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-400 mt-3" data-zh="å‰›å‰›" data-en="Just now">å‰›å‰›</div>
                    </div>
                </div>
            </main>

            <footer class="p-6 border-t border-gray-200 bg-gray-50">
                <div class="max-w-4xl mx-auto">
                    <div id="quick-actions" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 mb-4"></div>
                    <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                        <textarea id="message-input" rows="2"
                               class="flex-1 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base bg-white resize-none"
                               placeholder="å‘Šè¨´æˆ‘ä½ çš„ç•™å­¸éœ€æ±‚ã€ç›®æ¨™æˆ–å›°æƒ‘..."
                               data-zh-ph="å‘Šè¨´æˆ‘ä½ çš„ç•™å­¸éœ€æ±‚ã€ç›®æ¨™æˆ–å›°æƒ‘..."
                               data-en-ph="Tell me your study abroad needs, goals, or confusions..."></textarea>
                        <button id="send-btn" 
                                class="px-6 py-4 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition-colors text-sm sm:text-base flex items-center justify-center">
                            <span data-zh="é€å‡º" data-en="Send">é€å‡º</span>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-3 text-center" data-zh="æŒ‰ Ctrl+Enter ç™¼é€ï¼ŒEnter æ›è¡Œ" data-en="Press Ctrl+Enter to send, Enter for new line">æŒ‰ Ctrl+Enter ç™¼é€ï¼ŒEnter æ›è¡Œ</p>
                </div>
            </footer>
        </div>
    </div>

    <!-- ç”¨æˆ¶è¨­å®šæ¨¡æ…‹æ¡† -->
    <div id="user-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="closeUserSettingsOnOutside(event)">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900" data-zh="ç”¨æˆ¶è¨­å®š" data-en="User Settings">ç”¨æˆ¶è¨­å®š</h2>
                    <button onclick="closeUserSettings()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        Ã—
                    </button>
                </div>
                
                <div class="space-y-6">
                    <!-- ç”¨æˆ¶è³‡è¨Šé¡¯ç¤º -->
                    <div class="text-center">
                        <img id="settings-user-avatar" class="w-20 h-20 rounded-full mx-auto mb-3" src="" alt="User Avatar">
                        <h3 id="settings-user-name" class="text-xl font-semibold text-gray-900"></h3>
                        <p id="settings-user-email" class="text-gray-600"></p>
                    </div>
                    
                    <!-- åŸºæœ¬è³‡è¨Šç·¨è¼¯ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="é¡¯ç¤ºåç¨±" data-en="Display Name">é¡¯ç¤ºåç¨±</label>
                        <input type="text" id="settings-display-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" data-zh="åå¥½èªè¨€" data-en="Preferred Language">åå¥½èªè¨€</label>
                        <select id="settings-language" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="zh">ä¸­æ–‡</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                    
                    <!-- é€šçŸ¥è¨­å®š -->
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 mb-3" data-zh="é€šçŸ¥è¨­å®š" data-en="Notification Settings">é€šçŸ¥è¨­å®š</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="settings-email-notifications" class="mr-2">
                                <span data-zh="æ¥æ”¶éƒµä»¶é€šçŸ¥" data-en="Receive email notifications">æ¥æ”¶éƒµä»¶é€šçŸ¥</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="settings-push-notifications" class="mr-2">
                                <span data-zh="æ¥æ”¶æ¨é€é€šçŸ¥" data-en="Receive push notifications">æ¥æ”¶æ¨é€é€šçŸ¥</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- éš±ç§è¨­å®š -->
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 mb-3" data-zh="éš±ç§è¨­å®š" data-en="Privacy Settings">éš±ç§è¨­å®š</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="settings-profile-public" class="mr-2">
                                <span data-zh="å…¬é–‹å€‹äººè³‡æ–™" data-en="Make profile public">å…¬é–‹å€‹äººè³‡æ–™</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="settings-data-collection" class="mr-2">
                                <span data-zh="å…è¨±æ•¸æ“šæ”¶é›†ä»¥æ”¹å–„æœå‹™" data-en="Allow data collection to improve service">å…è¨±æ•¸æ“šæ”¶é›†ä»¥æ”¹å–„æœå‹™</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- æ“ä½œæŒ‰éˆ• -->
                <div class="flex space-x-3 mt-8">
                    <button onclick="saveUserSettings()" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        <span data-zh="å„²å­˜è¨­å®š" data-en="Save Settings">å„²å­˜è¨­å®š</span>
                    </button>
                    <button onclick="closeUserSettings()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                        <span data-zh="å–æ¶ˆ" data-en="Cancel">å–æ¶ˆ</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        var currentRole = 'student';
        var currentLanguage = 'zh';
        var profileId = null;

        // ç›£è½å½ˆå‡ºè¦–çª—æ¶ˆæ¯
        window.addEventListener('message', function(event) {
            // ç¢ºä¿æ¶ˆæ¯ä¾†è‡ªå¯ä¿¡çš„ä¾†æº
            if (event.origin !== 'https://aistudentbackend.zeabur.app') {
                return;
            }
            
            if (event.data && event.data.type === 'GOOGLE_LOGIN_SUCCESS') {
                console.log('Received login success message:', event.data);
                
                if (window.addDebugInfo) {
                    addDebugInfo('âœ“ æ”¶åˆ° Google ç™»å…¥æˆåŠŸæ¶ˆæ¯');
                    addDebugInfo('ç”¨æˆ¶: ' + event.data.user.name + ' (' + event.data.user.email + ')');
                }
                
                // å„²å­˜ token å’Œç”¨æˆ¶ä¿¡æ¯
                localStorage.setItem('jwt', event.data.token);
                
                // é¡¯ç¤ºç”¨æˆ¶ä¿¡æ¯ä¸¦è·³è½‰åˆ°è¨­å®šé é¢
                showUserInfo(event.data.user);
                showSetupPage();
            }
        });

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å–å¾— Google Client ID ä»¥åˆå§‹åŒ– GIS
            fetch(window.__CONFIG__.API_BASE + '/auth/config')
                .then(r => r.json())
                .then(cfg => {
                    if (cfg && cfg.ok && cfg.google && cfg.google.client_id) {
                        window.__GOOGLE_CLIENT_ID__ = cfg.google.client_id;
                        console.log('Google Client ID loaded:', cfg.google.client_id);
                    } else {
                        console.warn('Google Client ID not configured in backend');
                        console.log('Config response:', cfg);
                    }
                })
                .catch((error) => {
                    console.error('Failed to load Google Client ID:', error);
                });
                
            // æª¢æŸ¥ Google API è¼‰å…¥ç‹€æ…‹
            setTimeout(function() {
                if (typeof google !== 'undefined' && google.accounts) {
                    console.log('Google API loaded successfully');
                } else {
                    console.error('Google API failed to load');
                }
            }, 2000);
            // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            checkAuthStatus();
            
            // åˆå§‹åŒ–å¹´ä»½é¸é …
            initializeYearOptions();
            
            // ç¶å®šäº‹ä»¶
            document.getElementById('back-to-home').addEventListener('click', showLoginPage);
            document.getElementById('back-to-setup').addEventListener('click', showSetupPage);
            document.getElementById('setup-form').addEventListener('submit', handleSetupSubmit);
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    // Ctrl+Enter ç™¼é€è¨Šæ¯
                    sendMessage();
                }
                // å–®ç¨æŒ‰ Enter åªæ›è¡Œï¼Œä¸ç™¼é€
            });
            
            // ç¶å®šæ—¥æœŸé¸æ“‡äº‹ä»¶
            document.getElementById('intake_semester').addEventListener('change', updateTargetIntake);
            document.getElementById('intake_year').addEventListener('change', updateTargetIntake);
        });

        // æª¢æŸ¥èªè­‰ç‹€æ…‹
        function checkAuthStatus() {
            try {
                fetch(window.__CONFIG__.API_BASE + '/auth/status')
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (data.ok && data.user) {
                        showUserInfo(data.user);
                    } else {
                        showLoginButtons();
                    }
                })
                .catch(function(error) {
                    console.error('Auth check failed:', error);
                    showLoginButtons();
                });
            } catch (error) {
                console.error('Auth check failed:', error);
                showLoginButtons();
            }
        }

        // é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
        function showUserInfo(user) {
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('login-buttons').classList.add('hidden');
            document.getElementById('user-name').textContent = user.name;
            if (user.avatar) {
                document.getElementById('user-avatar').src = user.avatar;
            }
        }

        // é¡¯ç¤ºç™»å…¥æŒ‰éˆ•
        function showLoginButtons() {
            document.getElementById('user-info').classList.add('hidden');
            document.getElementById('login-buttons').classList.remove('hidden');
        }

        // ç™»å…¥åŠŸèƒ½
        function loginWithGoogle() {
            console.log('Google login button clicked');
            if (window.addDebugInfo) {
                addDebugInfo('Google ç™»å…¥æŒ‰éˆ•è¢«é»æ“Š');
            }
            
            // ä½¿ç”¨å½ˆå‡ºè¦–çª—é€²è¡Œ Google ç™»å…¥
            var googleAuthUrl = 'https://accounts.google.com/o/oauth2/v2/auth?' +
                'client_id=' + (window.__GOOGLE_CLIENT_ID__ || '300123710303-m4j1laa65p664n5vtrdkfvfa7b42c2o6.apps.googleusercontent.com') + '&' +
                'redirect_uri=https://aistudentbackend.zeabur.app/auth/google/callback&' +
                'response_type=code&' +
                'scope=openid email profile&' +
                'state=popup_login';
            
            console.log('Opening Google login popup:', googleAuthUrl);
            if (window.addDebugInfo) {
                addDebugInfo('æº–å‚™æ‰“é–‹ Google ç™»å…¥å½ˆå‡ºè¦–çª—');
                addDebugInfo('URL: ' + googleAuthUrl);
            }
            
            // æ‰“é–‹å½ˆå‡ºè¦–çª—
            var popup = window.open(
                googleAuthUrl,
                'googleLogin',
                'width=500,height=600,scrollbars=yes,resizable=yes,status=yes,location=yes,toolbar=no,menubar=no'
            );
            
            if (!popup) {
                const errorMsg = currentLanguage === 'en' ? 
                    'Popup blocked. Please allow popups for this site and try again.' : 
                    'å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹ã€‚è«‹å…è¨±æ­¤ç¶²ç«™çš„å½ˆå‡ºè¦–çª—å¾Œå†è©¦ã€‚';
                alert(errorMsg);
                if (window.addDebugInfo) {
                    addDebugInfo('âœ— ' + errorMsg);
                }
                return;
            }
            
            if (window.addDebugInfo) {
                addDebugInfo('âœ“ å½ˆå‡ºè¦–çª—å·²æˆåŠŸæ‰“é–‹');
            }
            
            // ç›£è½å½ˆå‡ºè¦–çª—çš„é—œé–‰
            var checkClosed = setInterval(function() {
                if (popup.closed) {
                    clearInterval(checkClosed);
                    console.log('Google login popup closed');
                    // ç™»å…¥æˆåŠŸæœƒé€šé postMessage è™•ç†ï¼Œé€™è£¡ä¸éœ€è¦é¡å¤–è™•ç†
                }
            }, 1000);
            
            // 5åˆ†é˜å¾Œè‡ªå‹•æ¸…ç†ç›£è½å™¨
            setTimeout(function() {
                clearInterval(checkClosed);
                if (!popup.closed) {
                    popup.close();
                }
            }, 300000);
        }

        function showLineUnavailable() {
            alert(currentLanguage === 'en' ? 
                'LINE login feature is coming soon! Please use Google login or skip login for now.' : 
                'LINE ç™»å…¥åŠŸèƒ½å³å°‡æ¨å‡ºï¼ç›®å‰è«‹ä½¿ç”¨ Google ç™»å…¥æˆ–è·³éç™»å…¥ã€‚');
        }
        
        function loginWithLINE() {
            // ç²å– LINE Login URL
            fetch('https://aistudentbackend.zeabur.app/api/v1/auth/line/login')
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (data.ok) {
                        // é‡å®šå‘åˆ° LINE Login
                        window.location.href = data.login_url;
                    } else {
                        alert(currentLanguage === 'en' ? 
                            'LINE login is not available. Please use Google login or skip login.' : 
                            'LINE ç™»å…¥åŠŸèƒ½æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œè«‹ä½¿ç”¨ Google ç™»å…¥æˆ–è·³éç™»å…¥ã€‚');
                    }
                })
                .catch(function(error) {
                    console.error('LINE Login error:', error);
                    alert(currentLanguage === 'en' ? 
                        'LINE login failed. Please try again or use Google login.' : 
                        'LINE ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦æˆ–ä½¿ç”¨ Google ç™»å…¥ã€‚');
                });
        }
        
        // ç¹¼çºŒåˆ°èŠå¤©å°è©±æ¡†
        function continueToChat() {
            // æª¢æŸ¥æ˜¯å¦æœ‰ç”¨æˆ¶è¨­å®š
            if (!profileId) {
                // å¦‚æœæ²’æœ‰è¨­å®šï¼Œå…ˆé€²è¡Œè¨­å®šæµç¨‹
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('setup-section').classList.remove('hidden');
                return;
            }
            
            // å¦‚æœæœ‰è¨­å®šï¼Œç›´æ¥é€²å…¥èŠå¤©
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('setup-section').classList.add('hidden');
            document.getElementById('chat-section').classList.remove('hidden');
            
            // è¼‰å…¥èŠå¤©ç•Œé¢
            loadChatInterface();
        }
        
        // é–‹å•Ÿç”¨æˆ¶è¨­å®šé é¢
        function openUserSettings() {
            // é¡¯ç¤ºç”¨æˆ¶è¨­å®šæ¨¡æ…‹æ¡†
            document.getElementById('user-settings-modal').classList.remove('hidden');
            loadUserSettings();
        }
        
        // è¼‰å…¥ç”¨æˆ¶è¨­å®š
        function loadUserSettings() {
            const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            const jwt = localStorage.getItem('jwt');
            
            if (!jwt || !userProfile) {
                alert(currentLanguage === 'en' ? 
                    'Please login first.' : 
                    'è«‹å…ˆç™»å…¥ã€‚');
                return;
            }
            
            // è¼‰å…¥ç”¨æˆ¶åŸºæœ¬è³‡è¨Š
            document.getElementById('settings-user-avatar').src = userProfile.avatar || 'https://via.placeholder.com/80';
            document.getElementById('settings-user-name').textContent = userProfile.name || 'Unknown User';
            document.getElementById('settings-user-email').textContent = userProfile.email || '';
            
            // è¼‰å…¥è¨­å®šå€¼
            document.getElementById('settings-display-name').value = userProfile.name || '';
            document.getElementById('settings-language').value = currentLanguage;
            
            // è¼‰å…¥é€šçŸ¥è¨­å®šï¼ˆå¾æœ¬åœ°å„²å­˜æˆ–é è¨­å€¼ï¼‰
            const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
            document.getElementById('settings-email-notifications').checked = settings.emailNotifications || false;
            document.getElementById('settings-push-notifications').checked = settings.pushNotifications || true;
            document.getElementById('settings-profile-public').checked = settings.profilePublic || false;
            document.getElementById('settings-data-collection').checked = settings.dataCollection || true;
        }
        
        // å„²å­˜ç”¨æˆ¶è¨­å®š
        function saveUserSettings() {
            const settings = {
                displayName: document.getElementById('settings-display-name').value,
                language: document.getElementById('settings-language').value,
                emailNotifications: document.getElementById('settings-email-notifications').checked,
                pushNotifications: document.getElementById('settings-push-notifications').checked,
                profilePublic: document.getElementById('settings-profile-public').checked,
                dataCollection: document.getElementById('settings-data-collection').checked,
                updatedAt: new Date().toISOString()
            };
            
            // å„²å­˜åˆ°æœ¬åœ°å„²å­˜
            localStorage.setItem('userSettings', JSON.stringify(settings));
            
            // æ›´æ–°ç”¨æˆ¶è³‡æ–™
            const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            userProfile.name = settings.displayName;
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            
            // æ›´æ–°èªè¨€è¨­å®š
            if (settings.language !== currentLanguage) {
                currentLanguage = settings.language;
                switchLanguage(currentLanguage);
            }
            
            // æ›´æ–°é¡¯ç¤ºçš„ç”¨æˆ¶åç¨±
            document.getElementById('user-name').textContent = settings.displayName;
            
            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            alert(currentLanguage === 'en' ? 
                'Settings saved successfully!' : 
                'è¨­å®šå·²æˆåŠŸå„²å­˜ï¼');
            
            // é—œé–‰è¨­å®šæ¨¡æ…‹æ¡†
            closeUserSettings();
        }
        
        // é—œé–‰ç”¨æˆ¶è¨­å®š
        function closeUserSettings() {
            document.getElementById('user-settings-modal').classList.add('hidden');
        }
        
        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        function closeUserSettingsOnOutside(event) {
            if (event.target === event.currentTarget) {
                closeUserSettings();
            }
        }
        
        // ç™»å‡ºåŠŸèƒ½
        function logout() {
            // æ¸…é™¤æœ¬åœ°å„²å­˜
            localStorage.removeItem('jwt');
            localStorage.removeItem('userProfile');
            
            // é¡¯ç¤ºç™»å‡ºæˆåŠŸè¨Šæ¯
            alert(currentLanguage === 'en' ? 
                'You have been logged out successfully.' : 
                'æ‚¨å·²æˆåŠŸç™»å‡ºã€‚');
            
            // é‡æ–°è¼‰å…¥é é¢
            window.location.href = 'https://aistudent.zeabur.app';
        }


        // è·³éç™»å…¥
        function skipLogin() {
            // å‰µå»ºä¸€å€‹å‡çš„ JWT token ç”¨æ–¼æ¸¬è©¦
            var fakeToken = 'fake-jwt-token-for-testing';
            localStorage.setItem('jwt', fakeToken);
            showSetupPage();
        }


        // åˆå§‹åŒ–å¹´ä»½é¸é …
        function initializeYearOptions() {
            var yearSelect = document.getElementById('intake_year');
            var currentYear = new Date().getFullYear();
            
            // ç”Ÿæˆæœªä¾† 5 å¹´çš„é¸é …
            for (var i = 0; i < 5; i++) {
                var year = currentYear + i;
                var option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                option.setAttribute('data-zh', year);
                option.setAttribute('data-en', year);
                yearSelect.appendChild(option);
            }
        }

        // æ›´æ–°ç›®æ¨™å…¥å­¸æ™‚é–“
        function updateTargetIntake() {
            var semester = document.getElementById('intake_semester').value;
            var year = document.getElementById('intake_year').value;
            var targetIntakeInput = document.getElementById('target_intake');
            
            if (semester && year) {
                var semesterText = currentLanguage === 'en' 
                    ? semester.charAt(0).toUpperCase() + semester.slice(1)
                    : semester === 'fall' ? 'ç§‹å­£' : semester === 'spring' ? 'æ˜¥å­£' : semester === 'summer' ? 'å¤å­£' : 'å†¬å­£';
                
                var intakeText = currentLanguage === 'en' 
                    ? semesterText + ' ' + year
                    : year + 'å¹´' + semesterText;
                
                targetIntakeInput.value = intakeText;
            } else {
                targetIntakeInput.value = '';
            }
        }

        // èªè¨€åˆ‡æ›
        function switchLanguage(lang) {
            currentLanguage = lang;
            // æ›´æ–°æ‰€æœ‰å…·å‚™ data-zh / data-en çš„å…ƒç´ 
            var elements = document.querySelectorAll('[data-zh]');
            for (var i = 0; i < elements.length; i++) {
                var el = elements[i];
                var text = el.getAttribute('data-' + currentLanguage);
                if (text) el.textContent = text;
            }
            // æ›´æ–° placeholder
            var inputs = document.querySelectorAll('[data-zh-ph]');
            for (var j = 0; j < inputs.length; j++) {
                var input = inputs[j];
                var placeholder = input.getAttribute('data-' + currentLanguage + '-ph');
                if (placeholder) input.placeholder = placeholder;
            }
            // æ›´æ–° select é¸é …
            var options = document.querySelectorAll('option[data-zh]');
            for (var k = 0; k < options.length; k++) {
                var option = options[k];
                var text = option.getAttribute('data-' + currentLanguage);
                if (text) option.textContent = text;
            }
            
            // æ›´æ–°ç›®æ¨™å…¥å­¸æ™‚é–“é¡¯ç¤º
            updateTargetIntake();
            
            // æ›´æ–°èªè¨€åˆ‡æ›æŒ‰éˆ•æ¨£å¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            var zhBtn = document.getElementById('lang-switch-zh');
            var enBtn = document.getElementById('lang-switch-en');
            if (zhBtn && enBtn) {
                zhBtn.classList.toggle('bg-blue-500', lang === 'zh');
                zhBtn.classList.toggle('bg-gray-200', lang !== 'zh');
                zhBtn.classList.toggle('text-white', lang === 'zh');
                zhBtn.classList.toggle('text-gray-700', lang !== 'zh');
                enBtn.classList.toggle('bg-blue-500', lang === 'en');
                enBtn.classList.toggle('bg-gray-200', lang !== 'en');
                enBtn.classList.toggle('text-white', lang === 'en');
                enBtn.classList.toggle('text-gray-700', lang !== 'en');
            }
            
            // é‡æ–°è¼‰å…¥å¿«é€Ÿå‹•ä½œæŒ‰éˆ•
            loadQuickActions();
        }

        // è§’è‰²é¸æ“‡
        function selectRole(role) {
            currentRole = role;
            document.getElementById('role-student').classList.toggle('bg-blue-500', role === 'student');
            document.getElementById('role-student').classList.toggle('bg-gray-300', role !== 'student');
            document.getElementById('role-parent').classList.toggle('bg-blue-500', role === 'parent');
            document.getElementById('role-parent').classList.toggle('bg-gray-300', role !== 'parent');

            // åˆ‡æ›æ¬„ä½é¡¯ç¤º
            document.getElementById('student-fields').classList.toggle('hidden', role !== 'student');
            document.getElementById('parent-fields').classList.toggle('hidden', role !== 'parent');
            loadQuickActions();
        }

        // é é¢åˆ‡æ›
        function showLoginPage() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('setup-page').classList.add('hidden');
            document.getElementById('chat-page').classList.add('hidden');
        }

        function validateToken(token) {
            // ç°¡å–®çš„ token é©—è­‰ï¼Œæª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„ JWT æ ¼å¼
            try {
                var parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid token format');
                }
                
                // æª¢æŸ¥ token æ˜¯å¦éæœŸï¼ˆç°¡å–®æª¢æŸ¥ï¼‰
                var payload = JSON.parse(atob(parts[1]));
                var currentTime = Math.floor(Date.now() / 1000);
                
                if (payload.exp && payload.exp < currentTime) {
                    throw new Error('Token expired');
                }
                
                // Token æœ‰æ•ˆï¼Œé¡¯ç¤ºè¨­å®šé é¢
                showSetupPage();
            } catch (error) {
                console.log('Token validation failed:', error);
                // Token ç„¡æ•ˆï¼Œæ¸…é™¤ä¸¦é¡¯ç¤ºç™»å…¥é é¢
                localStorage.removeItem('jwt');
                showLoginPage();
            }
        }

        function showSetupPage() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('setup-page').classList.remove('hidden');
            document.getElementById('chat-page').classList.add('hidden');
        }

        function showChatPage() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('setup-page').classList.add('hidden');
            document.getElementById('chat-page').classList.remove('hidden');
            
            // æ›´æ–°èŠå¤©é é¢çš„èªè¨€
            switchLanguage(currentLanguage);
            
            loadQuickActions();
            // è‡ªå‹•ç™¼é€æ‰“æ‹›å‘¼è¨Šæ¯
            sendWelcomeMessage();
        }

        // è™•ç†è¨­å®šæäº¤
        function handleSetupSubmit(e) {
            e.preventDefault();
            
            var formData = new FormData(e.target);
            var data = {};
            
            if (currentRole === 'student') {
                data = {
                    student_name: formData.get('student_name'),
                    student_email: formData.get('student_email'),
                    citizenship: formData.get('citizenship'),
                    gpa: parseFloat(formData.get('gpa')),
                    degree: formData.get('degree'),
                    countries: getCheckedCountries(),
                    budget: parseInt(formData.get('budget')),
                    target_intake: formData.get('target_intake'),
                    user_role: currentRole
                };
            } else {
                data = {
                    parent_name: formData.get('parent_name'),
                    parent_email: formData.get('parent_email'),
                    relationship: formData.get('relationship'),
                    child_name: formData.get('child_name'),
                    child_email: formData.get('child_email'),
                    gpa: parseFloat(formData.get('gpa')),
                    degree: formData.get('degree'),
                    countries: getCheckedCountries(),
                    budget: parseInt(formData.get('budget')),
                    target_intake: formData.get('target_intake'),
                    user_role: currentRole
                };
            }

            try {
                // æª¢æŸ¥æ˜¯å¦æœ‰ JWT token
                var jwt = localStorage.getItem('jwt');
                if (!jwt) {
                    alert(currentLanguage === 'en' ? 'Please login first or skip login to continue.' : 'è«‹å…ˆç™»å…¥æˆ–è·³éç™»å…¥ç¹¼çºŒ');
                    return;
                }
                
                var authHeader = { 'Authorization': 'Bearer ' + jwt };
                var headers = {
                    'Content-Type': 'application/json'
                };
                for (var key in authHeader) {
                    headers[key] = authHeader[key];
                }
                
                fetch(window.__CONFIG__.API_BASE + '/intake', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(data)
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    if (result.ok) {
                        profileId = result.data.profile_id;
                        showChatPage();
                    } else {
                        alert('æäº¤å¤±æ•—ï¼š' + result.error);
                    }
                })
                .catch(function(error) {
                    console.error('Setup submission failed:', error);
                    alert('æäº¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
                });
            } catch (error) {
                console.error('Setup submission failed:', error);
                alert('æäº¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
            }
        }
        
        // ç²å–é¸ä¸­çš„åœ‹å®¶
        function getCheckedCountries() {
            var countries = [];
            var checkboxes = document.querySelectorAll('input[name="countries"]:checked');
            for (var i = 0; i < checkboxes.length; i++) {
                countries.push(checkboxes[i].value);
            }
            return countries;
        }

        // ç™¼é€æ¶ˆæ¯
        function sendMessage() {
            var input = document.getElementById('message-input');
            var message = input.value.trim();
            
            if (!message) return;

            // æ·»åŠ ç”¨æˆ¶æ¶ˆæ¯åˆ°èŠå¤©
            addMessage(message, 'user');
            input.value = '';

            try {
                var authHeader = {};
                var jwt = localStorage.getItem('jwt');
                if (jwt) {
                    authHeader['Authorization'] = 'Bearer ' + jwt;
                }
                
                var headers = {
                    'Content-Type': 'application/json'
                };
                for (var key in authHeader) {
                    headers[key] = authHeader[key];
                }
                
                fetch(window.__CONFIG__.API_BASE + '/chat', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        profile_id: profileId,
                        message: message,
                        user_role: currentRole,
                        language: currentLanguage
                    })
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    if (result.ok) {
                        addMessage(result.data.response, 'ai');
                    } else {
                        addMessage('æŠ±æ­‰ï¼Œæˆ‘ç„¡æ³•è™•ç†æ‚¨çš„è«‹æ±‚ã€‚è«‹ç¨å¾Œå†è©¦ã€‚', 'ai');
                    }
                })
                .catch(function(error) {
                    console.error('Chat failed:', error);
                    addMessage('æŠ±æ­‰ï¼Œç¶²è·¯é€£æ¥å‡ºç¾å•é¡Œã€‚è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£æ¥ã€‚', 'ai');
                });
            } catch (error) {
                console.error('Chat failed:', error);
                addMessage('æŠ±æ­‰ï¼Œç¶²è·¯é€£æ¥å‡ºç¾å•é¡Œã€‚è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£æ¥ã€‚', 'ai');
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©
        function addMessage(message, sender) {
            var chatContainer = document.getElementById('chat-container');
            var messageWrapper = document.createElement('div');
            
            var currentTime = new Date().toLocaleTimeString('zh-TW', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            if (sender === 'user') {
                messageWrapper.className = 'flex justify-end mb-4';
                messageWrapper.innerHTML = 
                    '<div class="max-w-xs sm:max-w-sm md:max-w-md bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-800 rounded-lg p-4 shadow-sm">' +
                        '<div class="text-sm leading-relaxed">' + message + '</div>' +
                        '<div class="text-xs text-gray-600 mt-2">' + currentTime + '</div>' +
                    '</div>';
            } else {
                messageWrapper.className = 'mb-4';
                var aiTitle = currentLanguage === 'en' ? 'AI Study Abroad Advisor' : 'AI ç•™å­¸é¡§å•';
                var aiSubtitle = currentLanguage === 'en' ? 'Your Exclusive Study Abroad Planning Expert' : 'æ‚¨çš„å°ˆå±¬ç•™å­¸è¦åŠƒå°ˆå®¶';
                
                messageWrapper.innerHTML = 
                    '<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">' +
                        '<div class="flex items-center mb-4">' +
                            '<div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">AI</div>' +
                            '<div>' +
                                '<h3 class="font-semibold text-gray-800">' + aiTitle + '</h3>' +
                                '<p class="text-sm text-gray-500">' + aiSubtitle + '</p>' +
                            '</div>' +
                        '</div>' +
                        '<div class="text-gray-700 leading-relaxed">' + message + '</div>' +
                        '<div class="text-xs text-gray-400 mt-3">' + currentTime + '</div>' +
                    '</div>';
            }
            
            chatContainer.appendChild(messageWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ç™¼é€æ­¡è¿è¨Šæ¯
        function sendWelcomeMessage() {
            if (!profileId) return;
            
            // ç«‹å³é¡¯ç¤ºæ­¡è¿è¨Šæ¯ï¼Œä¸ç­‰å¾… API å›æ‡‰
            var welcomeText = '';
            if (currentLanguage === 'en') {
                welcomeText = 'ğŸ“ Hello! I am your AI Study Abroad Advisor.\n\nI have reviewed your basic information, now let\'s dive deep into your study abroad planning!\n\nYou can ask me any questions about studying abroad, such as:\n\nâ€¢ School and major recommendations\nâ€¢ Application timeline planning\nâ€¢ Scholarship opportunities\nâ€¢ Visa and accommodation guidance\n\nWhat would you like to know first?';
            } else {
                welcomeText = 'ğŸ“ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIç•™å­¸é¡§å•ã€‚\n\næˆ‘å·²ç¶“äº†è§£äº†æ‚¨çš„åŸºæœ¬è³‡è¨Šï¼Œç¾åœ¨è®“æˆ‘å€‘æ·±å…¥è¨è«–æ‚¨çš„ç•™å­¸è¨ˆåŠƒå§ï¼\n\næ‚¨å¯ä»¥å•æˆ‘ä»»ä½•é—œæ–¼ç•™å­¸çš„å•é¡Œï¼Œæ¯”å¦‚ï¼š\n\nâ€¢ æ¨è–¦é©åˆçš„å­¸æ ¡å’Œå°ˆæ¥­\nâ€¢ ç”³è«‹æ™‚é–“è¦åŠƒ\nâ€¢ çå­¸é‡‘ç”³è«‹å»ºè­°\nâ€¢ ç°½è­‰èˆ‡ä½å®¿è³‡è¨Š\n\næ‚¨æƒ³å…ˆäº†è§£å“ªå€‹éƒ¨åˆ†å‘¢ï¼Ÿ';
            }
            
            addMessage(welcomeText, 'ai');
            
            // åŒæ™‚ç™¼é€ API è«‹æ±‚ç²å–æ›´è©³ç´°çš„å›è¦†
            try {
                var authHeader = {};
                var jwt = localStorage.getItem('jwt');
                if (jwt) {
                    authHeader['Authorization'] = 'Bearer ' + jwt;
                }
                
                var headers = {
                    'Content-Type': 'application/json'
                };
                for (var key in authHeader) {
                    headers[key] = authHeader[key];
                }
                
                fetch(window.__CONFIG__.API_BASE + '/chat', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        profile_id: profileId,
                        message: '', // ç©ºè¨Šæ¯è§¸ç™¼æ­¡è¿å›è¦†
                        user_role: currentRole,
                        language: currentLanguage
                    })
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(result) {
                    if (result.ok) {
                        addMessage(result.data.response, 'ai');
                    } else {
                        console.error('Welcome message failed:', result);
                    }
                })
                .catch(function(error) {
                    console.error('Welcome message error:', error);
                });
            } catch (error) {
                console.error('Welcome message error:', error);
            }
        }

        // è¼‰å…¥å¿«é€Ÿå•ç­”æŒ‰éˆ•ï¼ˆä¾èº«ä»½ï¼‰
        function loadQuickActions() {
            var qa = document.getElementById('quick-actions');
            if (!qa) return;
            qa.innerHTML = '';
            
            var studentBtns = [
                { zh: 'å­¸æ ¡æ¨è–¦', en: 'School Recommendations', q: 'æ ¹æ“šæˆ‘çš„èƒŒæ™¯æ¨è–¦é©åˆçš„å­¸æ ¡å’Œç§‘ç³»', q_en: 'Recommend suitable schools and majors based on my background' },
                { zh: 'ç”³è«‹è¦åŠƒ', en: 'Application Planning', q: 'è«‹å¹«æˆ‘è¦åŠƒå®Œæ•´çš„ç”³è«‹æ™‚é–“è¡¨å’Œæµç¨‹', q_en: 'Please help me plan a complete application timeline and process' },
                { zh: 'çå­¸é‡‘ç”³è«‹', en: 'Scholarship Application', q: 'æœ‰å“ªäº›é©åˆæˆ‘çš„çå­¸é‡‘å¯ä»¥ç”³è«‹ï¼Ÿ', q_en: 'What scholarships are suitable for me to apply for?' },
                { zh: 'ç°½è­‰æŒ‡å°', en: 'Visa Guidance', q: 'å­¸ç”Ÿç°½è­‰ç”³è«‹æµç¨‹å’Œæ³¨æ„äº‹é …', q_en: 'Student visa application process and important notes' },
                { zh: 'ä½å®¿å»ºè­°', en: 'Housing Advice', q: 'æµ·å¤–ä½å®¿é¸æ“‡å’Œæ³¨æ„äº‹é …', q_en: 'Overseas accommodation options and considerations' },
                { zh: 'èªè¨€æº–å‚™', en: 'Language Preparation', q: 'èªè¨€è€ƒè©¦æº–å‚™å’Œæˆç¸¾è¦æ±‚', q_en: 'Language test preparation and score requirements' }
            ];
            var parentBtns = [
                { zh: 'è²»ç”¨è¦åŠƒ', en: 'Cost Planning', q: 'ä¸€å¹´ç¸½è²»ç”¨é ä¼°èˆ‡é ç®—å»ºè­°', q_en: 'Annual total cost estimation and budget recommendations' },
                { zh: 'æŠ•è³‡å›å ±', en: 'ROI Analysis', q: 'å¹«æˆ‘ä¼°ç®—ä¸åŒæ–¹æ¡ˆçš„æŠ•è³‡å›æ”¶æœŸ', q_en: 'Help me estimate the ROI for different options' },
                { zh: 'å®‰å…¨è€ƒé‡', en: 'Safety Considerations', q: 'æµ·å¤–ç•™å­¸å®‰å…¨æ³¨æ„äº‹é …', q_en: 'Safety considerations for studying abroad' },
                { zh: 'ä¿éšªè¦åŠƒ', en: 'Insurance Planning', q: 'ç•™å­¸ä¿éšªé¸æ“‡å’Œè¦åŠƒ', q_en: 'Study abroad insurance options and planning' },
                { zh: 'å°±æ¥­å‰æ™¯', en: 'Career Prospects', q: 'ç•¢æ¥­å¾Œå°±æ¥­å‰æ™¯å’Œç™¼å±•', q_en: 'Career prospects and development after graduation' },
                { zh: 'æ–‡åŒ–é©æ‡‰', en: 'Cultural Adaptation', q: 'å¦‚ä½•å¹«åŠ©å­©å­é©æ‡‰æµ·å¤–æ–‡åŒ–', q_en: 'How to help children adapt to overseas culture' }
            ];
            
            var buttons = currentRole === 'parent' ? parentBtns : studentBtns;
            
            for (var i = 0; i < buttons.length; i++) {
                var btn = buttons[i];
                var label = currentLanguage === 'en' ? btn.en : btn.zh;
                var question = currentLanguage === 'en' ? btn.q_en : btn.q;
                
                var button = document.createElement('button');
                button.type = 'button';
                button.className = 'px-4 py-3 text-sm bg-white hover:bg-gray-50 rounded-lg border border-gray-200 shadow-sm transition-colors text-gray-700 font-medium';
                button.textContent = label;
                button.onclick = function(questionText) {
                    return function() {
                        document.getElementById('message-input').value = questionText;
                        sendMessage();
                    };
                }(question);
                qa.appendChild(button);
            }
        }
        
        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        window.onload = function() {
            // æ¸…é™¤å¯èƒ½ç„¡æ•ˆçš„èˆŠ tokenï¼ˆç”¨æ–¼æ¸¬è©¦ï¼‰
            // å–æ¶ˆè¨»è§£ä¸‹é¢é€™è¡Œä¾†å¼·åˆ¶é¡¯ç¤ºç™»å…¥é é¢
            localStorage.removeItem('jwt');
            
            // æª¢æŸ¥ URL åƒæ•¸ä¸­çš„ token
            var urlParams = new URLSearchParams(window.location.search);
            var token = urlParams.get('token');
            var error = urlParams.get('error');
            
            // è™•ç†ç™»å…¥éŒ¯èª¤
            if (error) {
                var errorMessage = '';
                switch(error) {
                    case 'missing_code':
                        errorMessage = currentLanguage === 'en' ? 'Login failed: Missing authorization code' : 'ç™»å…¥å¤±æ•—ï¼šç¼ºå°‘æˆæ¬Šç¢¼';
                        break;
                    case 'token_exchange_failed':
                        errorMessage = currentLanguage === 'en' ? 'Login failed: Token exchange failed' : 'ç™»å…¥å¤±æ•—ï¼šä»¤ç‰Œäº¤æ›å¤±æ•—';
                        break;
                    case 'user_info_failed':
                        errorMessage = currentLanguage === 'en' ? 'Login failed: Unable to get user information' : 'ç™»å…¥å¤±æ•—ï¼šç„¡æ³•ç²å–ç”¨æˆ¶è³‡è¨Š';
                        break;
                    case 'callback_failed':
                        errorMessage = currentLanguage === 'en' ? 'Login failed: Callback processing failed' : 'ç™»å…¥å¤±æ•—ï¼šå›èª¿è™•ç†å¤±æ•—';
                        break;
                    default:
                        errorMessage = currentLanguage === 'en' ? 'Login failed: ' + error : 'ç™»å…¥å¤±æ•—ï¼š' + error;
                }
                alert(errorMessage);
                // æ¸…é™¤ URL åƒæ•¸
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            if (token) {
                // å„²å­˜ token ä¸¦è·³è½‰åˆ°è¨­å®šé é¢
                localStorage.setItem('jwt', token);
                showSetupPage();
                // æ¸…é™¤ URL åƒæ•¸
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                // æª¢æŸ¥æœ¬åœ°å„²å­˜çš„ token
                var storedToken = localStorage.getItem('jwt');
                if (storedToken) {
                    // é©—è­‰ token æ˜¯å¦æœ‰æ•ˆ
                    validateToken(storedToken);
                } else {
                    showLoginPage();
                }
            }
        };
    </script>
</body>
</html>

